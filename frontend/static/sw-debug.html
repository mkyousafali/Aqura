<!DOCTYPE html>
<html>
<head>
    <title>Service Worker Debug</title>
</head>
<body>
    <h2>Service Worker Debug</h2>
    <div id="output"></div>
    
    <button onclick="checkServiceWorkers()">Check Service Workers</button>
    <button onclick="registerPushSW()">Register Push SW</button>
    <button onclick="clearAllSW()">Clear All SW</button>
    
    <script>
        const output = document.getElementById('output');
        
        function log(message) {
            console.log(message);
            output.innerHTML += '<p>' + message + '</p>';
        }
        
        async function checkServiceWorkers() {
            output.innerHTML = '<h3>Service Worker Status:</h3>';
            
            if (!('serviceWorker' in navigator)) {
                log('‚ùå Service Workers not supported');
                return;
            }
            
            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                log(`üìä Found ${registrations.length} service worker registrations:`);
                
                registrations.forEach((reg, index) => {
                    const scriptURL = reg.active?.scriptURL || reg.waiting?.scriptURL || reg.installing?.scriptURL || 'Unknown';
                    const state = reg.active?.state || 'No active worker';
                    
                    log(`SW ${index + 1}:`);
                    log(`  Scope: ${reg.scope}`);
                    log(`  Script: ${scriptURL}`);
                    log(`  State: ${state}`);
                    log(`  Active: ${!!reg.active}`);
                    log(`  Waiting: ${!!reg.waiting}`);
                    log(`  Installing: ${!!reg.installing}`);
                    log('---');
                });
                
                // Check ready registration
                const ready = await navigator.serviceWorker.ready;
                log('üìç Ready registration:');
                log(`  Scope: ${ready.scope}`);
                log(`  Active: ${!!ready.active}`);
                log(`  State: ${ready.active?.state || 'No active worker'}`);
                
            } catch (error) {
                log('‚ùå Error checking service workers: ' + error.message);
            }
        }
        
        async function registerPushSW() {
            output.innerHTML = '<h3>Registering Push Service Worker:</h3>';
            
            try {
                log('üîÑ Registering push service worker...');
                const registration = await navigator.serviceWorker.register('/sw-push.js', {
                    scope: '/'
                });
                
                log('‚úÖ Push service worker registered');
                log(`Scope: ${registration.scope}`);
                log(`Installing: ${!!registration.installing}`);
                log(`Waiting: ${!!registration.waiting}`);
                log(`Active: ${!!registration.active}`);
                
                // Wait for activation
                if (registration.installing) {
                    log('‚è≥ Waiting for service worker to install...');
                    registration.installing.addEventListener('statechange', () => {
                        log(`State changed to: ${registration.installing.state}`);
                    });
                }
                
                const ready = await navigator.serviceWorker.ready;
                log('üéØ Service worker ready!');
                log(`Ready scope: ${ready.scope}`);
                log(`Ready active: ${!!ready.active}`);
                
            } catch (error) {
                log('‚ùå Error registering service worker: ' + error.message);
            }
        }
        
        async function clearAllSW() {
            output.innerHTML = '<h3>Clearing All Service Workers:</h3>';
            
            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                log(`üóëÔ∏è Unregistering ${registrations.length} service workers...`);
                
                for (const reg of registrations) {
                    log(`Unregistering: ${reg.scope}`);
                    await reg.unregister();
                }
                
                log('‚úÖ All service workers unregistered');
                
            } catch (error) {
                log('‚ùå Error clearing service workers: ' + error.message);
            }
        }
        
        // Auto-check on page load
        checkServiceWorkers();
    </script>
</body>
</html>