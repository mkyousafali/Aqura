const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./Dqyum4BN.js","./CE8Bg3hM.js","./C1FmrZbK.js"])))=>i.map(i=>d[i]);
var U=Object.defineProperty;var k=(u,e,t)=>e in u?U(u,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):u[e]=t;var g=(u,e,t)=>k(u,typeof e!="symbol"?e+"":e,t);import{w as y,g as q}from"./CE8Bg3hM.js";import{s as l}from"./Dqyum4BN.js";import{_ as I}from"./C1FmrZbK.js";class T{async loginWithCredentials(e,t){try{const{data:r,error:s}=await l.from("user_management_view").select("*").eq("username",e).eq("status","active").limit(1);if(s)throw new Error("Database error: "+s.message);if(!r||r.length===0)throw new Error("Invalid username or password");const i=r[0],{data:o,error:a}=await l.rpc("verify_password",{password:t,hash:await this.getPasswordHash(i.id)});if(a)throw console.error("Password verification error:",a),new Error("Authentication failed");if(!o)throw await this.incrementFailedLoginAttempts(i.id),new Error("Invalid username or password");const n=await this.getUserPermissions(i.id);await this.updateLastLogin(i.id);const c=this.generateSessionToken(),v=this.mapDatabaseUserToUser(i,n);return await this.createUserSession(i.id,c,"username_password"),{user:v,token:c}}catch(r){throw console.error("Login error:",r),r}}async loginWithQuickAccess(e){try{if(!/^[0-9]{6}$/.test(e))throw new Error("Invalid access code format");const{data:t,error:r}=await l.from("users").select(`
					id,
					username,
					quick_access_code,
					quick_access_salt,
					status,
					user_type,
					employee_id,
					branch_id,
					role_type,
					position_id,
					avatar
				`).eq("status","active").eq("quick_access_code",e).limit(1);if(r)throw console.error("Database error:",r),new Error("Database error: "+r.message);if(!t||t.length===0)throw new Error("Invalid access code");const s=t[0],{data:i,error:o}=await l.from("user_management_view").select("*").eq("id",s.id).single();if(o||!i)throw console.error("User details error:",o),new Error("User details not found");const a=await this.getUserPermissions(s.id);await this.updateLastLogin(s.id);const n=this.generateSessionToken(),c=this.mapDatabaseUserToUser(i,a);return await this.createUserSession(s.id,n,"quick_access"),{user:c,token:n}}catch(t){throw console.error("Quick access login error:",t),t}}async validateSession(e){try{const{data:t,error:r}=await l.from("user_sessions").select(`
					*,
					users!inner(*)
				`).eq("session_token",e).eq("is_active",!0).gt("expires_at",new Date().toISOString()).limit(1);if(r||!t||t.length===0)return null;const s=t[0],{data:i,error:o}=await l.from("user_management_view").select("*").eq("id",s.user_id).eq("status","active").single();if(o||!i)return null;const a=await this.getUserPermissions(s.user_id);return this.mapDatabaseUserToUser(i,a)}catch(t){return console.error("Session validation error:",t),null}}async logout(e){try{await l.from("user_sessions").update({is_active:!1,ended_at:new Date().toISOString()}).eq("session_token",e)}catch(t){console.error("Logout error:",t)}}async getPasswordHash(e){const{data:t,error:r}=await l.from("users").select("password_hash").eq("id",e).single();if(r||!t)throw new Error("User not found");return t.password_hash}async getUserPermissions(e){const{data:t,error:r}=await l.from("user_permissions_view").select("*").eq("user_id",e);if(r)return console.error("Error fetching permissions:",r),{};const s={};return t&&t.forEach(i=>{s[i.function_code]={can_view:i.can_view,can_add:i.can_add,can_edit:i.can_edit,can_delete:i.can_delete,can_export:i.can_export}}),s}async incrementFailedLoginAttempts(e){const{data:t}=await l.from("users").select("failed_login_attempts").eq("id",e).single(),r=(t==null?void 0:t.failed_login_attempts)||0;await l.from("users").update({failed_login_attempts:r+1}).eq("id",e)}async updateLastLogin(e){await l.from("users").update({last_login_at:new Date().toISOString(),failed_login_attempts:0}).eq("id",e)}async createUserSession(e,t,r){const s=new Date;s.setHours(s.getHours()+(r==="quick_access"?8:24)),await l.from("user_sessions").insert({user_id:e,session_token:t,login_method:r,expires_at:s.toISOString(),is_active:!0})}generateSessionToken(){const e=Date.now().toString(),t=Math.random().toString(36).substring(2);return`aqura_${e}_${t}`}mapDatabaseUserToUser(e,t){return{id:e.id,username:e.username,role:e.role_type,roleType:e.role_type,userType:e.user_type,avatar:e.avatar,employeeName:e.employee_name,branchName:e.branch_name,lastLogin:e.last_login,permissions:t}}}const w=new T,d=typeof window<"u";function E(){const{subscribe:u,set:e,update:t}=y(null);return{subscribe:u,init:async()=>{if(d)try{const r=localStorage.getItem("aqura-auth-token"),s=localStorage.getItem("aqura-user"),i=localStorage.getItem("aqura-session");if(r&&s&&i){const o=JSON.parse(s),a=JSON.parse(i);if(new Date(a.expiresAt)>new Date){const n=await w.validateSession(r);n?e({token:r,user:n,...a}):(localStorage.removeItem("aqura-auth-token"),localStorage.removeItem("aqura-user"),localStorage.removeItem("aqura-session"))}else localStorage.removeItem("aqura-auth-token"),localStorage.removeItem("aqura-user"),localStorage.removeItem("aqura-session")}}catch(r){console.error("Error initializing auth:",r),d&&(localStorage.removeItem("aqura-auth-token"),localStorage.removeItem("aqura-user"),localStorage.removeItem("aqura-session"))}},loginWithCredentials:async(r,s,i=!1)=>{try{const{user:o,token:a}=await w.loginWithCredentials(r,s),n=new Date;n.setHours(n.getHours()+(i?720:24));const c={token:a,user:o,loginMethod:"username",loginTime:new Date().toISOString(),expiresAt:n.toISOString()};return d&&(localStorage.setItem("aqura-auth-token",c.token),localStorage.setItem("aqura-user",JSON.stringify(c.user)),localStorage.setItem("aqura-session",JSON.stringify({loginMethod:c.loginMethod,loginTime:c.loginTime,expiresAt:c.expiresAt}))),e(c),{success:!0,user:o}}catch(o){throw console.error("Login error:",o),new Error(o.message||"Login failed")}},loginWithQuickAccess:async r=>{try{const{user:s,token:i}=await w.loginWithQuickAccess(r),o=new Date;o.setHours(o.getHours()+8);const a={token:i,user:s,loginMethod:"quickAccess",loginTime:new Date().toISOString(),expiresAt:o.toISOString()};return d&&(localStorage.setItem("aqura-auth-token",a.token),localStorage.setItem("aqura-user",JSON.stringify(a.user)),localStorage.setItem("aqura-session",JSON.stringify({loginMethod:a.loginMethod,loginTime:a.loginTime,expiresAt:a.expiresAt}))),e(a),{success:!0,user:s}}catch(s){throw console.error("Quick access error:",s),new Error(s.message||"Quick access failed")}},logout:async()=>{console.log("Auth store logout called");let r=null;if(t(s=>(r=s,s)),r!=null&&r.token)try{await w.logout(r.token)}catch(s){console.error("Error ending session in database:",s)}d&&(console.log("Clearing localStorage items..."),localStorage.removeItem("aqura-auth-token"),localStorage.removeItem("aqura-user"),localStorage.removeItem("aqura-session"),console.log("localStorage cleared")),console.log("Setting auth state to null"),e(null),console.log("Logout completed")},updateUser:r=>{t(s=>(s&&(s.user={...s.user,...r},d&&localStorage.setItem("aqura-user",JSON.stringify(s.user))),s))},hasPermission:(r,s)=>{let i=!1;return t(o=>{var a,n,c;return(n=(a=o==null?void 0:o.user)==null?void 0:a.permissions)!=null&&n[r]?i=o.user.permissions[r][`can_${s}`]||!1:((c=o==null?void 0:o.user)==null?void 0:c.roleType)==="Master Admin"&&(i=!0),o}),i},refreshSession:async()=>{if(!d)return;const r=localStorage.getItem("aqura-auth-token");if(r)try{const s=await w.validateSession(r);s?t(i=>(i&&(i.user=s,localStorage.setItem("aqura-user",JSON.stringify(s))),i)):(localStorage.removeItem("aqura-auth-token"),localStorage.removeItem("aqura-user"),localStorage.removeItem("aqura-session"),e(null))}catch(s){console.error("Session refresh error:",s),localStorage.removeItem("aqura-auth-token"),localStorage.removeItem("aqura-user"),localStorage.removeItem("aqura-session"),e(null)}}}}const x=E(),_="BExwv7hh64Fkg6RRzkzueFm8MQn0NkdtImUf5q2X1UUwLKyGw3RtLqgj-MixTecmRaePJSxNva9J0Y5CMZIqzS8",A="https://vmypotfsyrvuublyddyt.supabase.co",D="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZteXBvdGZzeXJ2dXVibHlkZHl0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NjQ4MjQ4OSwiZXhwIjoyMDcyMDU4NDg5fQ.RmkgY9IQ-XzNeUvcuEbrQlF6P4-8BjJkjKnB8h8HoPQ";let m=null;class N{constructor(){g(this,"swRegistration",null);g(this,"subscription",null)}async initialize(){if(!("serviceWorker"in navigator)||!("PushManager"in window))return console.warn("Push notifications not supported in this browser"),!1;try{return this.swRegistration=await navigator.serviceWorker.register("/sw.js",{scope:"/"}),console.log("Service Worker registered successfully"),await navigator.serviceWorker.ready,await this.requestPermission()!=="granted"?(console.warn("Notification permission not granted"),!1):(await this.subscribeToPush(),!0)}catch(e){return console.error("Failed to initialize push notifications:",e),!1}}async requestPermission(){if(!("Notification"in window))return"denied";let e=Notification.permission;return e==="default"&&(e=await Notification.requestPermission()),e}async subscribeToPush(){if(!this.swRegistration)return console.error("Service worker not registered"),null;try{return this.subscription=await this.swRegistration.pushManager.getSubscription(),this.subscription||(this.subscription=await this.swRegistration.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.urlBase64ToUint8Array(_)})),await this.registerDevice(),this.subscription}catch(e){return console.error("Failed to subscribe to push notifications:",e),null}}async registerDevice(){if(!this.subscription){console.error("No push subscription available");return}const e=q(f);if(!e){console.error("No user logged in");return}const t=this.generateDeviceId(),r=e.id,s={user_id:r,device_id:t,endpoint:this.subscription.endpoint,p256dh:this.subscription.getKey("p256dh")?btoa(String.fromCharCode(...new Uint8Array(this.subscription.getKey("p256dh")))):"",auth:this.subscription.getKey("auth")?btoa(String.fromCharCode(...new Uint8Array(this.subscription.getKey("auth")))):"",device_type:this.getDeviceType(),browser_name:this.getBrowserName(),user_agent:navigator.userAgent,is_active:!0,last_seen:new Date().toISOString()};console.log("ðŸ“± Registering device:",{originalUserId:e.id,mappedUUID:r,deviceId:t,deviceType:this.getDeviceType()});try{if(!m){const{createClient:o}=await I(async()=>{const{createClient:a}=await import("./Dqyum4BN.js").then(n=>n.f);return{createClient:a}},__vite__mapDeps([0,1,2]),import.meta.url);m=o(A,D)}const{error:i}=await m.from("push_subscriptions").upsert(s);if(i)throw i;localStorage.setItem("aqura-device-id",t),console.log("Device registered for push notifications")}catch(i){console.error("Failed to register device:",i)}}async unregisterDevice(){const e=localStorage.getItem("aqura-device-id");if(e)try{const{createClient:t}=await I(async()=>{const{createClient:i}=await import("./Dqyum4BN.js").then(o=>o.f);return{createClient:i}},__vite__mapDeps([0,1,2]),import.meta.url),r=t(A,D),{error:s}=await r.from("push_subscriptions").update({is_active:!1}).eq("device_id",e);if(s)throw s;this.subscription&&(await this.subscription.unsubscribe(),this.subscription=null),localStorage.removeItem("aqura-device-id"),console.log("Device unregistered from push notifications")}catch(t){console.error("Failed to unregister device:",t)}}async sendTestNotification(){if(Notification.permission!=="granted"){console.warn("Cannot send notification - permission not granted");return}const e=new Notification("Aqura Test Notification",{body:"Push notifications are working!",icon:"/favicon.png",badge:"/badge-icon.png",tag:"test-notification"});setTimeout(()=>{e.close()},5e3)}async showNotification(e){var r;if(Notification.permission!=="granted")return;const t=new Notification(e.title,{body:e.body,icon:e.icon||"/favicon.png",badge:e.badge||"/badge-icon.png",data:e.data,tag:((r=e.data)==null?void 0:r.notification_id)||"aqura-notification",requireInteraction:!0});t.onclick=s=>{var i;s.preventDefault(),window.focus(),(i=e.data)!=null&&i.url&&(window.location.href=e.data.url),t.close()}}async updateLastSeen(){const e=localStorage.getItem("aqura-device-id");if(e)try{if(!m){const{createClient:t}=await I(async()=>{const{createClient:r}=await import("./Dqyum4BN.js").then(s=>s.f);return{createClient:r}},__vite__mapDeps([0,1,2]),import.meta.url);m=t(A,D)}await m.from("push_subscriptions").update({last_seen:new Date().toISOString(),is_active:!0}).eq("device_id",e)}catch(t){console.error("Failed to update last seen:",t)}}generateDeviceId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}generateUUIDFromString(e){let t=0;for(let o=0;o<e.length;o++){const a=e.charCodeAt(o);t=(t<<5)-t+a,t=t&t}const r=Math.abs(t).toString(16).padStart(8,"0"),s=(r+r+r+r).substring(0,32);return`${s.slice(0,8)}-${s.slice(8,12)}-4${s.slice(13,16)}-a${s.slice(17,20)}-${s.slice(20,32)}`}getDeviceType(){const e=navigator.userAgent;return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(e)?"mobile":"desktop"}getBrowserName(){const e=navigator.userAgent;return e.includes("Chrome")?"Chrome":e.includes("Firefox")?"Firefox":e.includes("Safari")?"Safari":e.includes("Edge")?"Edge":"Unknown"}urlBase64ToUint8Array(e){try{const t="=".repeat((4-e.length%4)%4),r=(e+t).replace(/-/g,"+").replace(/_/g,"/"),s=window.atob(r),i=new Uint8Array(s.length);for(let o=0;o<s.length;++o)i[o]=s.charCodeAt(o);return i}catch(t){throw console.error("Failed to decode VAPID key:",t),new Error("Invalid VAPID public key format")}}}const h=new N,f=y(null),S=y(!1),b=y(null);class P{constructor(){g(this,"sessionCheckInterval",null);g(this,"activityTrackingInterval",null);g(this,"SESSION_DURATION",24*60*60*1e3);g(this,"ACTIVITY_UPDATE_INTERVAL",5*60*1e3)}async initializeAuth(){try{console.log("ðŸ” Starting persistent auth initialization..."),await this.loadDeviceSessions();const e=await this.getActiveUser();e?(console.log("ðŸ” Found active user session:",e.username),await this.setCurrentUser(e)):(console.log("ðŸ” No active user session found"),f.set(null),S.set(!1)),this.startSessionMonitoring(),e&&await h.initialize(),console.log("ðŸ” Persistent auth initialization complete")}catch(e){console.error("ðŸ” Error initializing auth:",e),f.set(null),S.set(!1)}}async loginWithQuickAccess(e){try{const{user:t,token:r}=await w.loginWithQuickAccess(e),s={id:t.id,username:t.username,role:t.role,roleType:t.roleType,userType:t.userType,avatar:t.avatar,employeeName:t.employeeName,branchName:t.branchName,loginTime:new Date().toISOString(),deviceId:this.getDeviceId(),loginMethod:"quickAccess",isActive:!0};return await this.saveUserSession(s),await this.setCurrentUser(s),await h.initialize(),await this.logUserActivity("quick_access_login",s.id),{success:!0,user:s}}catch(t){return console.error("Quick access login error:",t),{success:!1,error:t instanceof Error?t.message:"Quick access login failed. Please try again."}}}async login(e,t){var r,s,i,o;try{const{data:a,error:n}=await l.auth.signInWithPassword({email:e.includes("@")?e:`${e}@aqura.local`,password:t});if(n||!a.user)return{success:!1,error:(n==null?void 0:n.message)||"Authentication failed"};const{data:c,error:v}=await l.from("users").select(`
					id,
					username,
					email,
					role,
					hr_employees (
						id,
						employee_id,
						branch_id
					)
				`).eq("id",a.user.id).single();if(v||!c)return{success:!1,error:"User data not found"};const p={id:c.id,username:c.username,role:c.role,employee_id:(s=(r=c.hr_employees)==null?void 0:r[0])==null?void 0:s.employee_id,branch_id:(o=(i=c.hr_employees)==null?void 0:i[0])==null?void 0:o.branch_id,loginTime:new Date().toISOString(),deviceId:this.getDeviceId(),loginMethod:"password",isActive:!0};return await this.saveUserSession(p),await this.setCurrentUser(p),await h.initialize(),await this.logUserActivity("login",p.id),{success:!0,user:p}}catch(a){return console.error("Login error:",a),{success:!1,error:"Login failed. Please try again."}}}async logout(){try{const e=await this.getCurrentUser();e&&(this.logUserActivity("logout",e.id).catch(t=>console.warn("Failed to log logout activity:",t)),await h.unregisterDevice(),await this.removeUserSession(e.id),await l.auth.signOut()),f.set(null),S.set(!1),this.stopSessionMonitoring()}catch(e){console.error("Logout error:",e)}}async switchUser(e){try{const t=await this.getDeviceSession();if(!t)return{success:!1,error:"No device session found"};const r=t.users.find(i=>i.id===e);return r?Date.now()-new Date(r.loginTime).getTime()>this.SESSION_DURATION?(await this.removeUserSession(e),{success:!1,error:"Session expired. Please login again."}):(await this.setCurrentUser(r),t.currentUserId=e,t.lastActivity=new Date().toISOString(),await this.saveDeviceSession(t),await h.unregisterDevice(),await h.initialize(),await this.logUserActivity("switch",e),{success:!0,user:r}):{success:!1,error:"User not found on this device"}}catch(t){return console.error("Switch user error:",t),{success:!1,error:"Failed to switch user"}}}async getDeviceUsers(){const e=await this.getDeviceSession();return(e==null?void 0:e.users.filter(t=>t.isActive))||[]}async isSessionValid(e){const t=await this.getDeviceSession();if(!t)return!1;const r=t.users.find(i=>i.id===e);return r?Date.now()-new Date(r.loginTime).getTime()<=this.SESSION_DURATION:!1}async loadDeviceSessions(){try{const e=localStorage.getItem("aqura-device-session");if(e){const t=JSON.parse(e);b.set(t)}}catch(e){console.error("Error loading device sessions:",e)}}async saveDeviceSession(e){try{localStorage.setItem("aqura-device-session",JSON.stringify(e)),b.set(e)}catch(t){console.error("Error saving device session:",t)}}async getDeviceSession(){try{const e=localStorage.getItem("aqura-device-session");return e?JSON.parse(e):null}catch(e){return console.error("Error getting device session:",e),null}}async saveUserSession(e){let t=await this.getDeviceSession();t||(t={deviceId:this.getDeviceId(),users:[],lastActivity:new Date().toISOString()}),t.users=t.users.filter(r=>r.id!==e.id),t.users.push(e),t.currentUserId=e.id,t.lastActivity=new Date().toISOString(),await this.saveDeviceSession(t)}async removeUserSession(e){const t=await this.getDeviceSession();t&&(t.users=t.users.filter(r=>r.id!==e),t.currentUserId===e&&(t.currentUserId=void 0),t.lastActivity=new Date().toISOString(),await this.saveDeviceSession(t))}async getActiveUser(){const e=await this.getDeviceSession();if(!e||!e.currentUserId)return null;const t=e.users.find(s=>s.id===e.currentUserId);return t?await this.isSessionValid(t.id)?t:(await this.removeUserSession(t.id),null):null}async getCurrentUser(){return new Promise(e=>{let t;const r=setTimeout(()=>{t&&t(),e(null)},1e3);t=f.subscribe(s=>{clearTimeout(r),t&&t(),e(s)})})}async setCurrentUser(e){f.set(e),S.set(!0),setTimeout(async()=>{try{await this.updateLastActivity()}catch(t){console.warn("Failed to update last activity:",t)}},100)}async updateLastActivity(){const e=await this.getDeviceSession();e&&(e.lastActivity=new Date().toISOString(),await this.saveDeviceSession(e)),await h.updateLastSeen()}startSessionMonitoring(){this.sessionCheckInterval=setInterval(async()=>{const e=await this.getCurrentUser();e&&(await this.isSessionValid(e.id)||await this.logout())},60*1e3),this.activityTrackingInterval=setInterval(async()=>{await this.getCurrentUser()&&await this.updateLastActivity()},this.ACTIVITY_UPDATE_INTERVAL)}stopSessionMonitoring(){this.sessionCheckInterval&&(clearInterval(this.sessionCheckInterval),this.sessionCheckInterval=null),this.activityTrackingInterval&&(clearInterval(this.activityTrackingInterval),this.activityTrackingInterval=null)}getDeviceId(){let e=localStorage.getItem("aqura-device-id");return e||(e=`${Date.now()}-${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("aqura-device-id",e)),e}async logUserActivity(e,t){try{console.log("ðŸ” [PersistentAuth] Logging user activity:",{activity:e,userId:t});const r=await l.from("user_audit_logs").insert({user_id:t,action:e,ip_address:null,user_agent:navigator.userAgent});r.error?console.error("ðŸ” [PersistentAuth] Audit log insert error:",r.error):console.log("ðŸ” [PersistentAuth] Audit log inserted successfully")}catch(r){console.error("ðŸ” [PersistentAuth] Error logging user activity:",r)}}}const O=new P;["mousedown","mousemove","keypress","scroll","touchstart","click"].forEach(u=>{document.addEventListener(u,()=>{O.updateLastActivity()},{passive:!0})});export{x as a,h as b,f as c,b as d,S as i,O as p};
//# sourceMappingURL=COcYFW_x.js.map
