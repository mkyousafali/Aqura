<script>
	import { createEventDispatcher, onMount } from 'svelte';
	import { get } from 'svelte/store';
	import { supabase, supabaseAdmin } from '$lib/utils/supabase';
	import { currentUser, isAuthenticated } from '$lib/utils/persistentAuth';
	import { notificationManagement } from '$lib/utils/notificationManagement';
	import { 
		captureAndSaveWarning, 
		generateWhatsAppShareUrl 
	} from '$lib/utils/warningImageStorage';
	
	export let data;
	
	const dispatch = createEventDispatcher();
	
	let isEditing = false;
	let editableWarning = data.warningText;
	let isSending = false;
	let isSaving = false;
	let sendError = null;
	let hasWhatsApp = false;
	let whatsappNumber = '';
	let warningSaved = false; // Flag to prevent duplicate saves
	let currentUserName = ''; // Store current logged-in user name
	let currentUserPosition = ''; // Store current user's position
	let currentUserEmployeeId = null; // Store current user's employee_id
	
	// Workflow state management
	let workflowStep = 'edit'; // 'edit' | 'save' | 'send' | 'share'
	let savedWarningId = null; // Store the warning ID after saving
	let savedImageUrl = null; // Store the image URL after saving
	let isSavingImage = false; // Loading state for image save
	let saveImageError = null; // Error message for image save
	let successMessage = null; // Success message display
	
	// Get current user name and position on mount
	onMount(async () => {
		const user = get(currentUser);
		console.log('ЁЯФН Current user from store:', user);
		if (user) {
			currentUserName = user.username || 'System Administrator';
			currentUserEmployeeId = user.employee_id;
			console.log('ЁЯФН Extracted employee_id:', currentUserEmployeeId);
			
			// If employee_id is not in session, fetch it from database
			if (!currentUserEmployeeId && user.id) {
				console.log('ЁЯФН employee_id not in session, fetching from database...');
				try {
					const { data: userData, error } = await supabaseAdmin
						.from('users')
						.select('employee_id')
						.eq('id', user.id)
						.single();
					
					if (!error && userData?.employee_id) {
						currentUserEmployeeId = userData.employee_id;
						console.log('тЬЕ Fetched employee_id from database:', currentUserEmployeeId);
					}
				} catch (err) {
					console.error('Error fetching employee_id:', err);
				}
			}
			
			// Fetch user's current position
			if (currentUserEmployeeId) {
				try {
					const { data: positionData, error } = await supabaseAdmin
						.from('hr_position_assignments')
						.select(`
							position_id,
							hr_positions (
								position_title_en,
								position_title_ar
							)
						`)
						.eq('employee_id', currentUserEmployeeId)
						.eq('is_current', true);
					
					console.log('Position fetch - employee_id:', currentUserEmployeeId);
					console.log('Position fetch - error:', error);
					console.log('Position fetch - data:', positionData);
					
					if (!error && positionData && positionData.length > 0 && positionData[0]?.hr_positions) {
						// Use English position title, or Arabic if English is not available
						currentUserPosition = positionData[0].hr_positions.position_title_en || 
											  positionData[0].hr_positions.position_title_ar || 
											  'Manager';
					} else {
						console.warn('No position found for employee_id:', currentUserEmployeeId);
						currentUserPosition = 'Manager';
					}
				} catch (err) {
					console.error('Error fetching user position:', err);
					currentUserPosition = 'Manager';
				}
			} else {
				console.warn('No employee_id found for current user');
				currentUserPosition = 'Manager';
			}
		}
		await checkWhatsAppContact();
	});

	// Multi-language translations
	const translations = {
		en: {
			companyName: 'AQURA MANAGEMENT SYSTEM',
			documentTitle: 'PERFORMANCE WARNING NOTICE',
			date: 'Date:',
			to: 'To:',
			from: 'From:',
			subject: 'Subject:',
			subjectText: 'Performance Improvement Required',
			taskAssignedBy: 'Task Assigned By:',
			position: 'Position:',
			performanceSummary: 'Performance Summary',
			totalTasksAssigned: 'Total Tasks Assigned:',
			tasksCompleted: 'Tasks Completed:',
			overdueTasks: 'Overdue Tasks:',
			completionRate: 'Completion Rate:',
			warningDetails: 'Warning Details',
			employeeSignature: 'Employee Signature',
			managerSignature: 'Manager Signature',
			edit: 'Edit',
			print: 'Print',
			sendWarning: 'Send Warning',
			sendWhatsApp: 'Send WhatsApp',
			notificationSent: 'Notification sent successfully!',
			whatsappSent: 'WhatsApp message sent!',
			warningSent: 'Warning sent successfully!',
			datePlaceholder: 'Date: ________________',
			improvementRequired: 'Immediate improvement is required to avoid further disciplinary action.',
			documentFooter: 'This document is generated by Aqura Management System',
			name: 'Name:',
			signature: 'Signature:',
			date: 'Date',
			acknowledgmentStatement: 'I acknowledge that I have read and understood the above warning notice. I commit to improving my performance and meeting the required standards.',
			autoGeneratedNote: 'Note: This is an automatically generated document. Physical signatures are not required. Once sent through the internal notification system, this document will be considered as officially signed and acknowledged by both parties.'
		},
		hi: {
			companyName: 'рдЕрдХреНрд╡рд░рд╛ рдкреНрд░рдмрдВрдзрди рдкреНрд░рдгрд╛рд▓реА',
			documentTitle: 'рдкреНрд░рджрд░реНрд╢рди рдЪреЗрддрд╛рд╡рдиреА рд╕реВрдЪрдирд╛',
			date: 'рджрд┐рдирд╛рдВрдХ:',
			to: 'рдХреЛ:',
			from: 'рд╕реЗ:',
			subject: 'рд╡рд┐рд╖рдп:',
			subjectText: 'рдкреНрд░рджрд░реНрд╢рди рд╕реБрдзрд╛рд░ рдЖрд╡рд╢реНрдпрдХ',
			taskAssignedBy: 'рдХрд╛рд░реНрдп рд╕реМрдВрдкрд╛ рдЧрдпрд╛:',
			position: 'рдкрдж:',
			performanceSummary: 'рдкреНрд░рджрд░реНрд╢рди рд╕рд╛рд░рд╛рдВрд╢',
			totalTasksAssigned: 'рдХреБрд▓ рд╕реМрдВрдкреЗ рдЧрдП рдХрд╛рд░реНрдп:',
			tasksCompleted: 'рдкреВрд░реНрдг рдХрд┐рдП рдЧрдП рдХрд╛рд░реНрдп:',
			overdueTasks: 'рд╡рд┐рд▓рдВрдмрд┐рдд рдХрд╛рд░реНрдп:',
			completionRate: 'рдкреВрд░реНрдгрддрд╛ рджрд░:',
			warningDetails: 'рдЪреЗрддрд╛рд╡рдиреА рд╡рд┐рд╡рд░рдг',
			employeeSignature: 'рдХрд░реНрдордЪрд╛рд░реА рд╣рд╕реНрддрд╛рдХреНрд╖рд░',
			managerSignature: 'рдкреНрд░рдмрдВрдзрдХ рд╣рд╕реНрддрд╛рдХреНрд╖рд░',
			edit: 'рд╕рдВрдкрд╛рджрд┐рдд рдХрд░реЗрдВ',
			print: 'рдкреНрд░рд┐рдВрдЯ',
			save: 'рдЪреЗрддрд╛рд╡рдиреА рд╕рд╣реЗрдЬреЗрдВ',
			sendWarning: 'рдЪреЗрддрд╛рд╡рдиреА рднреЗрдЬреЗрдВ',
			sendWhatsApp: 'рд╡реНрд╣рд╛рдЯреНрд╕рдПрдк рднреЗрдЬреЗрдВ',
			notificationSent: 'рд╕реВрдЪрдирд╛ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рднреЗрдЬреА рдЧрдИ!',
			whatsappSent: 'рд╡реНрд╣рд╛рдЯреНрд╕рдПрдк рд╕рдВрджреЗрд╢ рднреЗрдЬрд╛ рдЧрдпрд╛!',
			datePlaceholder: 'рджрд┐рдирд╛рдВрдХ: ________________',
			improvementRequired: 'рдЕрдиреБрд╢рд╛рд╕рдирд╛рддреНрдордХ рдХрд╛рд░реНрд░рд╡рд╛рдИ рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рддрддреНрдХрд╛рд▓ рд╕реБрдзрд╛рд░ рдЖрд╡рд╢реНрдпрдХ рд╣реИред',
			documentFooter: 'рдпрд╣ рджрд╕реНрддрд╛рд╡реЗрдЬ рдЕрдХреНрд╡рд░рд╛ рдкреНрд░рдмрдВрдзрди рдкреНрд░рдгрд╛рд▓реА рджреНрд╡рд╛рд░рд╛ рдЙрддреНрдкрдиреНрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ',
			name: 'рдирд╛рдо:',
			signature: 'рд╣рд╕реНрддрд╛рдХреНрд╖рд░:',
			autoGeneratedNote: 'рдиреЛрдЯ: рдпрд╣ рдПрдХ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдЙрддреНрдкрдиреНрди рджрд╕реНрддрд╛рд╡реЗрдЬ рд╣реИред рднреМрддрд┐рдХ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИред рдЖрдВрддрд░рд┐рдХ рдЕрдзрд┐рд╕реВрдЪрдирд╛ рдкреНрд░рдгрд╛рд▓реА рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рднреЗрдЬреЗ рдЬрд╛рдиреЗ рдХреЗ рдмрд╛рдж, рдЗрд╕ рджрд╕реНрддрд╛рд╡реЗрдЬ рдХреЛ рджреЛрдиреЛрдВ рдкрдХреНрд╖реЛрдВ рджреНрд╡рд╛рд░рд╛ рдЖрдзрд┐рдХрд╛рд░рд┐рдХ рд░реВрдк рд╕реЗ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рдФрд░ рд╕реНрд╡реАрдХрд╛рд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдорд╛рдирд╛ рдЬрд╛рдПрдЧрд╛ред',
			acknowledgmentStatement: 'рдореИрдВ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рддрд╛/рдХрд░рддреА рд╣реВрдВ рдХрд┐ рдореИрдВрдиреЗ рдЙрдкрд░реЛрдХреНрдд рдЪреЗрддрд╛рд╡рдиреА рд╕реВрдЪрдирд╛ рдХреЛ рдкрдврд╝рд╛ рдФрд░ рд╕рдордЭрд╛ рд╣реИред рдореИрдВ рдЕрдкрдиреЗ рдкреНрд░рджрд░реНрд╢рди рдореЗрдВ рд╕реБрдзрд╛рд░ рдХрд░рдиреЗ рдФрд░ рдЖрд╡рд╢реНрдпрдХ рдорд╛рдирдХреЛрдВ рдХреЛ рдкреВрд░рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рддрд┐рдмрджреНрдз рд╣реВрдВред'
		},
		ar: {
			companyName: '┘Ж╪╕╪з┘Е ╪е╪п╪з╪▒╪й ╪г┘Г┘И╪▒╪з',
			documentTitle: '╪е╪┤╪╣╪з╪▒ ╪к╪н╪░┘К╪▒ ╪з┘Д╪г╪п╪з╪б',
			date: '╪з┘Д╪к╪з╪▒┘К╪о:',
			to: '╪е┘Д┘Й:',
			from: '┘Е┘Ж:',
			subject: '╪з┘Д┘Е┘И╪╢┘И╪╣:',
			subjectText: '╪к╪н╪│┘К┘Ж ╪з┘Д╪г╪п╪з╪б ┘Е╪╖┘Д┘И╪и',
			taskAssignedBy: '╪з┘Д┘Е┘З┘Е╪й ┘Е┘Г┘Д┘Б ╪и┘З╪з:',
			position: '╪з┘Д┘Е┘Ж╪╡╪и:',
			performanceSummary: '┘Е┘Д╪о╪╡ ╪з┘Д╪г╪п╪з╪б',
			totalTasksAssigned: '╪е╪м┘Е╪з┘Д┘К ╪з┘Д┘Е┘З╪з┘Е ╪з┘Д┘Е┘Г┘Д┘Б╪й:',
			tasksCompleted: '╪з┘Д┘Е┘З╪з┘Е ╪з┘Д┘Е┘Г╪к┘Е┘Д╪й:',
			overdueTasks: '╪з┘Д┘Е┘З╪з┘Е ╪з┘Д┘Е╪к╪г╪о╪▒╪й:',
			completionRate: '┘Е╪╣╪п┘Д ╪з┘Д╪е┘Ж╪м╪з╪▓:',
			warningDetails: '╪к┘Б╪з╪╡┘К┘Д ╪з┘Д╪к╪н╪░┘К╪▒',
			employeeSignature: '╪к┘И┘В┘К╪╣ ╪з┘Д┘Е┘И╪╕┘Б',
			managerSignature: '╪к┘И┘В┘К╪╣ ╪з┘Д┘Е╪п┘К╪▒',
			edit: '╪к╪╣╪п┘К┘Д',
			print: '╪╖╪и╪з╪╣╪й',
			save: '╪н┘Б╪╕ ╪з┘Д╪к╪н╪░┘К╪▒',
			sendWarning: '╪е╪▒╪│╪з┘Д ╪к╪н╪░┘К╪▒',
			sendWhatsApp: '╪е╪▒╪│╪з┘Д ┘И╪з╪к╪│╪з╪и',
			notificationSent: '╪к┘Е ╪е╪▒╪│╪з┘Д ╪з┘Д╪е╪┤╪╣╪з╪▒ ╪и┘Ж╪м╪з╪н!',
			whatsappSent: '╪к┘Е ╪е╪▒╪│╪з┘Д ╪▒╪│╪з┘Д╪й ┘И╪з╪к╪│╪з╪и!',
			datePlaceholder: '╪з┘Д╪к╪з╪▒┘К╪о: ________________',
			improvementRequired: '╪з┘Д╪к╪н╪│┘Ж ╪з┘Д┘Б┘И╪▒┘К ┘Е╪╖┘Д┘И╪и ┘Д╪к╪м┘Ж╪и ╪з╪к╪о╪з╪░ ╪е╪м╪▒╪з╪б╪з╪к ╪к╪г╪п┘К╪и┘К╪й ╪е╪╢╪з┘Б┘К╪й.',
			documentFooter: '╪к┘Е ╪е┘Ж╪┤╪з╪б ┘З╪░╪з ╪з┘Д┘Е╪│╪к┘Ж╪п ╪и┘И╪з╪│╪╖╪й ┘Ж╪╕╪з┘Е ╪е╪п╪з╪▒╪й ╪г┘Г┘И╪▒╪з',
			name: '╪з┘Д╪з╪│┘Е:',
			signature: '╪з┘Д╪к┘И┘В┘К╪╣:',
			autoGeneratedNote: '┘Е┘Д╪з╪н╪╕╪й: ┘З╪░╪з ┘Е╪│╪к┘Ж╪п ╪к┘Е ╪е┘Ж╪┤╪з╪д┘З ╪к┘Д┘В╪з╪ж┘К╪з┘Л. ╪з┘Д╪к┘И┘В┘К╪╣╪з╪к ╪з┘Д┘Б╪╣┘Д┘К╪й ╪║┘К╪▒ ┘Е╪╖┘Д┘И╪и╪й. ╪и┘Е╪м╪▒╪п ╪з┘Д╪е╪▒╪│╪з┘Д ╪╣╪и╪▒ ┘Ж╪╕╪з┘Е ╪з┘Д╪е╪┤╪╣╪з╪▒╪з╪к ╪з┘Д╪п╪з╪о┘Д┘К╪М ╪│┘К┘П╪╣╪к╪и╪▒ ┘З╪░╪з ╪з┘Д┘Е╪│╪к┘Ж╪п ┘Е┘И┘В╪╣╪з┘Л ┘И┘Е┘П┘В╪▒╪з┘Л ╪и┘З ╪▒╪│┘Е┘К╪з┘Л ┘Е┘Ж ┘В╪и┘Д ╪з┘Д╪╖╪▒┘Б┘К┘Ж.',
			acknowledgmentStatement: '╪г┘В╪▒ ╪и╪г┘Ж┘Ж┘К ┘В╪▒╪г╪к ┘И┘Б┘З┘Е╪к ╪е╪┤╪╣╪з╪▒ ╪з┘Д╪к╪н╪░┘К╪▒ ╪г╪╣┘Д╪з┘З. ┘И╪г┘Д╪к╪▓┘Е ╪и╪к╪н╪│┘К┘Ж ╪г╪п╪з╪ж┘К ┘И╪з╪│╪к┘К┘Б╪з╪б ╪з┘Д┘Е╪╣╪з┘К┘К╪▒ ╪з┘Д┘Е╪╖┘Д┘И╪и╪й.'
		},
		ur: {
			companyName: '╪з┌й┘И╪▒╪з ┘Е┘Ж█М╪м┘Е┘Ж┘╣ ╪│╪│┘╣┘Е',
			documentTitle: '┌й╪з╪▒┌й╪▒╪п┌п█М ╪з┘Ж╪к╪и╪з█Б█М ┘Ж┘И┘╣╪│',
			date: '╪к╪з╪▒█М╪о:',
			to: '┌й┘И:',
			from: '╪│█Т:',
			subject: '┘Е┘И╪╢┘И╪╣:',
			subjectText: '┌й╪з╪▒┌й╪▒╪п┌п█М ┘Е█М┌║ ╪и█Б╪к╪▒█М ╪п╪▒┌й╪з╪▒',
			taskAssignedBy: '┌й╪з┘Е ╪к┘Б┘И█М╪╢ ┌й█М╪з ┌п█М╪з:',
			position: '╪╣█Б╪п█Б:',
			performanceSummary: '┌й╪з╪▒┌й╪▒╪п┌п█М ┌й╪з ╪о┘Д╪з╪╡█Б',
			totalTasksAssigned: '┌й┘Д ╪к┘Б┘И█М╪╢ ╪┤╪п█Б ┌й╪з┘Е:',
			tasksCompleted: '┘Е┌й┘Е┘Д ╪┤╪п█Б ┌й╪з┘Е:',
			overdueTasks: '╪к╪з╪о█М╪▒ ╪│█Т ┌й╪з┘Е:',
			completionRate: '╪к┌й┘Е█М┘Д ┌й█М ╪┤╪▒╪н:',
			warningDetails: '╪з┘Ж╪к╪и╪з█Б ┌й█М ╪к┘Б╪╡█М┘Д╪з╪к',
			employeeSignature: '┘Е┘Д╪з╪▓┘Е ┌й█Т ╪п╪│╪к╪о╪╖',
			managerSignature: '┘Е┘Ж█М╪м╪▒ ┌й█Т ╪п╪│╪к╪о╪╖',
			edit: '╪к╪▒┘Е█М┘Е',
			print: '┘╛╪▒┘Ж┘╣',
			sendWarning: '╪з┘Ж╪к╪и╪з█Б ╪и┌╛█М╪м█М┌║',
			sendWhatsApp: '┘И╪з┘╣╪│ ╪з█М┘╛ ╪и┌╛█М╪м█М┌║',
			notificationSent: '╪з╪╖┘Д╪з╪╣ ┌й╪з┘Е█М╪з╪и█М ╪│█Т ╪и┌╛█М╪м ╪п█М ┌п╪ж█М!',
			whatsappSent: '┘И╪з┘╣╪│ ╪з█М┘╛ ┘╛█М╪║╪з┘Е ╪и┌╛█М╪м ╪п█М╪з ┌п█М╪з!',
			datePlaceholder: '╪к╪з╪▒█М╪о: ________________',
			improvementRequired: '┘Е╪▓█М╪п ╪к╪з╪п█М╪и█М ┌й╪з╪▒╪▒┘И╪з╪ж█М ╪│█Т ╪и┌Ж┘Ж█Т ┌й█Т ┘Д█М█Т ┘Б┘И╪▒█М ╪и█Б╪к╪▒█М ╪п╪▒┌й╪з╪▒ █Б█Т█Ф',
			documentFooter: '█М█Б ╪п╪│╪к╪з┘И█М╪▓ ╪з┌й┘И╪▒╪з ┘Е┘Ж█М╪м┘Е┘Ж┘╣ ╪│╪│┘╣┘Е ┌й█Т ╪░╪▒█М╪╣█Т ╪к█М╪з╪▒ ┌й█М ┌п╪ж█М █Б█Т',
			name: '┘Ж╪з┘Е:',
			signature: '╪п╪│╪к╪о╪╖:',
			autoGeneratedNote: '┘Ж┘И┘╣: █М█Б ╪о┘И╪п┌й╪з╪▒ ╪╖┘И╪▒ ┘╛╪▒ ╪к█М╪з╪▒ ┌й╪▒╪п█Б ╪п╪│╪к╪з┘И█М╪▓ █Б█Т█Ф ╪м╪│┘Е╪з┘Ж█М ╪п╪│╪к╪о╪╖┘И┌║ ┌й█М ╪╢╪▒┘И╪▒╪к ┘Ж█Б█М┌║ █Б█Т█Ф ╪з┘Ж╪п╪▒┘И┘Ж█М ╪з╪╖┘Д╪з╪╣╪з╪к█М ┘Ж╪╕╪з┘Е ┌й█Т ╪░╪▒█М╪╣█Т ╪и┌╛█М╪м█Т ╪м╪з┘Ж█Т ┌й█Т ╪и╪╣╪п╪М ╪з╪│ ╪п╪│╪к╪з┘И█М╪▓ ┌й┘И ╪п┘И┘Ж┘И┌║ ┘Б╪▒█М┘В┘И┌║ ┌й█М ╪╖╪▒┘Б ╪│█Т ╪и╪з╪╢╪з╪и╪╖█Б ╪╖┘И╪▒ ┘╛╪▒ ╪п╪│╪к╪о╪╖ ╪┤╪п█Б ╪з┘И╪▒ ╪к╪│┘Д█М┘Е ╪┤╪п█Б ╪│┘Е╪м┌╛╪з ╪м╪з╪ж█Т ┌п╪з█Ф',
			acknowledgmentStatement: '┘Е█М┌║ ╪к╪│┘Д█М┘Е ┌й╪▒╪к╪з/┌й╪▒╪к█М █Б┘И┌║ ┌й█Б ┘Е█М┌║ ┘Ж█Т ┘Е╪░┌й┘И╪▒█Б ╪и╪з┘Д╪з ╪к┘Ж╪и█М█Б ┘Ж┘И┘╣╪│ ┌й┘И ┘╛┌С┌╛╪з ╪з┘И╪▒ ╪│┘Е╪м┌╛╪з █Б█Т█Ф ┘Е█М┌║ ╪з┘╛┘Ж█М ┌й╪з╪▒┌й╪▒╪п┌п█М ┌й┘И ╪и█Б╪к╪▒ ╪и┘Ж╪з┘Ж█Т ╪з┘И╪▒ ┘Е╪╖┘Д┘И╪и█Б ┘Е╪╣█М╪з╪▒╪з╪к ┌й┘И ┘╛┘И╪▒╪з ┌й╪▒┘Ж█Т ┌й╪з ╪╣█Б╪п ┌й╪▒╪к╪з/┌й╪▒╪к█М █Б┘И┌║█Ф'
		},
		ta: {
			companyName: 'роЕроХрпНро╡ро░ро╛ роорпЗро▓ро╛рогрпНроорпИ роЕроорпИрокрпНрокрпБ',
			documentTitle: 'роЪрпЖропро▓рпНродро┐ро▒ройрпН роОроЪрпНроЪро░ро┐роХрпНроХрпИ роЕро▒ро┐ро╡ро┐рокрпНрокрпБ',
			date: 'родрпЗродро┐:',
			to: 'рокрпЖро▒рпБроиро░рпН:',
			from: 'роЕройрпБрокрпНрокрпБроиро░рпН:',
			subject: 'ро╡ро┐рд╖ропроорпН:',
			subjectText: 'роЪрпЖропро▓рпНродро┐ро▒ройрпН роорпЗроорпНрокро╛роЯрпБ родрпЗро╡рпИ',
			performanceSummary: 'роЪрпЖропро▓рпНродро┐ро▒ройрпН роЪрпБро░рпБроХрпНроХроорпН',
			totalTasksAssigned: 'роорпКродрпНрод роТродрпБроХрпНроХрокрпНрокроЯрпНроЯ рокрогро┐роХро│рпН:',
			tasksCompleted: 'роиро┐ро▒рпИро╡рпЗро▒рпНро▒рокрпНрокроЯрпНроЯ рокрогро┐роХро│рпН:',
			overdueTasks: 'родро╛роородрооро╛рой рокрогро┐роХро│рпН:',
			completionRate: 'роиро┐ро▒рпИро╡рпЗро▒рпНро▒ро▓рпН ро╡ро┐роХро┐родроорпН:',
			warningDetails: 'роОроЪрпНроЪро░ро┐роХрпНроХрпИ ро╡ро┐ро╡ро░роЩрпНроХро│рпН',
			employeeSignature: 'роКро┤ро┐ропро░рпН роХрпИропрпКрокрпНрокроорпН',
			managerSignature: 'роорпЗро▓ро╛ро│ро░рпН роХрпИропрпКрокрпНрокроорпН',
			edit: 'родро┐ро░рпБродрпНродрпБ',
			print: 'роЕроЪрпНроЪро┐роЯрпБ',
			sendWarning: 'роОроЪрпНроЪро░ро┐роХрпНроХрпИ роЕройрпБрокрпНрокрпБ',
			sendWhatsApp: 'ро╡ро╛роЯрпНро╕рпНроЕрокрпН роЕройрпБрокрпНрокрпБ',
			notificationSent: 'роЕро▒ро┐ро╡ро┐рокрпНрокрпБ ро╡рпЖро▒рпНро▒ро┐роХро░рооро╛роХ роЕройрпБрокрпНрокрокрпНрокроЯрпНроЯродрпБ!',
			whatsappSent: 'ро╡ро╛роЯрпНро╕рпНроЕрокрпН роЪрпЖропрпНродро┐ роЕройрпБрокрпНрокрокрпНрокроЯрпНроЯродрпБ!',
			datePlaceholder: 'родрпЗродро┐: ________________',
			improvementRequired: 'роорпЗро▓рпБроорпН роТро┤рпБроЩрпНроХрпБроорпБро▒рпИ роироЯро╡роЯро┐роХрпНроХрпИропрпИродрпН родро╡ро┐ро░рпНроХрпНроХ роЙроЯройроЯро┐ роорпБройрпНройрпЗро▒рпНро▒роорпН родрпЗро╡рпИ.',
			documentFooter: 'роЗроирпНрод роЖро╡рогроорпН роЕроХрпНро╡ро░ро╛ роорпЗро▓ро╛рогрпНроорпИ роЕроорпИрокрпНрокро╛ро▓рпН роЙро░рпБро╡ро╛роХрпНроХрокрпНрокроЯрпНроЯродрпБ',
			autoGeneratedNote: 'роХрпБро▒ро┐рокрпНрокрпБ: роЗродрпБ родро╛ройро╛роХ роЙро░рпБро╡ро╛роХрпНроХрокрпНрокроЯрпНроЯ роЖро╡рогроорпН. роЙроЯро▓рпН роХрпИропрпЖро┤рпБродрпНродрпБроХрпНроХро│рпН родрпЗро╡рпИропро┐ро▓рпНро▓рпИ. роЙро│рпН роЕро▒ро┐ро╡ро┐рокрпНрокрпБ роЕроорпИрокрпНрокрпБ роорпВро▓роорпН роЕройрпБрокрпНрокрокрпНрокроЯрпНроЯро╡рпБроЯройрпН, роЗроирпНрод роЖро╡рогроорпН роЗро░рпБ родро░рокрпНрокро┐ройро░ро╛ро▓рпБроорпН роЕродро┐роХро╛ро░рокрпНрокрпВро░рпНро╡рооро╛роХ роХрпИропрпКрокрпНрокрооро┐роЯрокрпНрокроЯрпНроЯрпБ роТрокрпНрокрпБроХрпНроХрпКро│рпНро│рокрпНрокроЯрпНроЯродро╛роХ роХро░рпБродрокрпНрокроЯрпБроорпН.',
			acknowledgmentStatement: 'роорпЗро▓рпЗ роЙро│рпНро│ роОроЪрпНроЪро░ро┐роХрпНроХрпИ роЕро▒ро┐ро╡ро┐рокрпНрокрпИ роиро╛ройрпН рокроЯро┐родрпНродрпБ рокрпБро░ро┐роирпНродрпБроХрпКрогрпНроЯрпЗройрпН роОройрпНрокродрпИ роТрокрпНрокрпБроХрпНроХрпКро│рпНроХро┐ро▒рпЗройрпН. роОройрпН роЪрпЖропро▓рпНродро┐ро▒ройрпИ роорпЗроорпНрокроЯрпБродрпНродро╡рпБроорпН родрпЗро╡рпИропро╛рой родро░роЩрпНроХро│рпИ рокрпВро░рпНродрпНродро┐ роЪрпЖропрпНропро╡рпБроорпН роЙро▒рпБродро┐ропро│ро┐роХрпНроХро┐ро▒рпЗройрпН.'
		},
		ml: {
			companyName: 'р┤Ер┤Хр╡Нр┤╡р┤╛р┤▒ р┤ор┤╛р┤ир╡Зр┤Ьр╡НтАМр┤ор╡Жр┤ир╡Нр┤▒р╡Н р┤╕р┤┐р┤╕р╡Нр┤▒р╡Нр┤▒р┤В',
			documentTitle: 'р┤кр╡Нр┤░р┤Хр┤Яр┤и р┤ор╡Бр┤ир╡Нр┤ир┤▒р┤┐р┤пр┤┐р┤кр╡Нр┤кр╡Н р┤Ер┤▒р┤┐р┤пр┤┐р┤кр╡Нр┤кр╡Н',
			date: 'р┤др╡Ар┤пр┤др┤┐:',
			to: 'р┤╡р╡Зр┤гр╡Нр┤Яр┤┐:',
			from: 'р┤ир┤┐р┤ир╡Нр┤ир╡Н:',
			subject: 'р┤╡р┤┐р┤╖р┤пр┤В:',
			subjectText: 'р┤кр╡Нр┤░р┤Хр┤Яр┤и р┤ор╡Жр┤Ър╡Нр┤Ър┤кр╡Нр┤кр╡Жр┤Яр╡Бр┤др╡Нр┤др╡╜ р┤Жр┤╡р┤╢р╡Нр┤пр┤В',
			performanceSummary: 'р┤кр╡Нр┤░р┤Хр┤Яр┤и р┤╕р┤Вр┤Чр╡Нр┤░р┤╣р┤В',
			totalTasksAssigned: 'р┤ор╡Кр┤др╡Нр┤др┤В р┤ир┤┐р┤пр╡Лр┤Чр┤┐р┤Ър╡Нр┤Ъ р┤Ьр╡Лр┤▓р┤┐р┤Хр╡╛:',
			tasksCompleted: 'р┤кр╡Вр╡╝р┤др╡Нр┤др╡Ар┤Хр┤░р┤┐р┤Ър╡Нр┤Ъ р┤Ьр╡Лр┤▓р┤┐р┤Хр╡╛:',
			overdueTasks: 'р┤Хр┤╛р┤▓р┤╣р┤░р┤гр┤кр╡Нр┤кр╡Жр┤Яр╡Нр┤Я р┤Ьр╡Лр┤▓р┤┐р┤Хр╡╛:',
			completionRate: 'р┤кр╡Вр╡╝р┤др╡Нр┤др╡Ар┤Хр┤░р┤г р┤ир┤┐р┤░р┤Хр╡Нр┤Хр╡Н:',
			warningDetails: 'р┤ор╡Бр┤ир╡Нр┤ир┤▒р┤┐р┤пр┤┐р┤кр╡Нр┤кр╡Н р┤╡р┤┐р┤╢р┤жр┤╛р┤Вр┤╢р┤Щр╡Нр┤Щр╡╛',
			employeeSignature: 'р┤Ьр╡Ар┤╡р┤ир┤Хр╡Нр┤Хр┤╛р┤░р┤ир╡Нр┤▒р╡Ж р┤Тр┤кр╡Нр┤кр╡Н',
			managerSignature: 'р┤ор┤╛р┤ир╡Зр┤Ьр┤▒р╡Бр┤Яр╡Ж р┤Тр┤кр╡Нр┤кр╡Н',
			edit: 'р┤Ор┤бр┤┐р┤▒р╡Нр┤▒р╡Н',
			print: 'р┤кр╡Нр┤░р┤┐р┤ир╡Нр┤▒р╡Н',
			sendWarning: 'р┤ор╡Бр┤ир╡Нр┤ир┤▒р┤┐р┤пр┤┐р┤кр╡Нр┤кр╡Н р┤Ер┤пр┤пр╡Нр┤Хр╡Нр┤Хр╡Бр┤Х',
			sendWhatsApp: 'р┤╡р┤╛р┤Яр╡Нр┤╕р╡Нр┤Жр┤кр╡Нр┤кр╡Н р┤Ер┤пр┤пр╡Нр┤Хр╡Нр┤Хр╡Бр┤Х',
			notificationSent: 'р┤Ер┤▒р┤┐р┤пр┤┐р┤кр╡Нр┤кр╡Н р┤╡р┤┐р┤Ьр┤пр┤Хр┤░р┤ор┤╛р┤пр┤┐ р┤Ер┤пр┤Ър╡Нр┤Ър╡Б!',
			whatsappSent: 'р┤╡р┤╛р┤Яр╡Нр┤╕р╡Нр┤Жр┤кр╡Нр┤кр╡Н р┤╕р┤ир╡Нр┤жр╡Зр┤╢р┤В р┤Ер┤пр┤Ър╡Нр┤Ър╡Б!',
			datePlaceholder: 'р┤др╡Ар┤пр┤др┤┐: ________________',
			improvementRequired: 'р┤Хр╡Вр┤Яр╡Бр┤др╡╜ р┤Ер┤Ър╡Нр┤Ър┤Яр┤Хр╡Нр┤Х р┤ир┤Яр┤кр┤Яр┤┐р┤Хр╡╛ р┤Тр┤┤р┤┐р┤╡р┤╛р┤Хр╡Нр┤Хр┤╛р╡╗ р┤Йр┤Яр┤ир┤Яр┤┐ р┤ор╡Жр┤Ър╡Нр┤Ър┤кр╡Нр┤кр╡Жр┤Яр╡Бр┤др╡Нр┤др╡╜ р┤Жр┤╡р┤╢р╡Нр┤пр┤ор┤╛р┤гр╡Н.',
			documentFooter: 'р┤И р┤бр╡Лр┤Хр╡Нр┤пр╡Бр┤ор╡Жр┤ир╡Нр┤▒р╡Н р┤Ер┤Хр╡Нр┤╡р┤╛р┤▒ р┤ор┤╛р┤ир╡Зр┤Ьр╡НтАМр┤ор╡Жр┤ир╡Нр┤▒р╡Н р┤╕р┤┐р┤╕р╡Нр┤▒р╡Нр┤▒р┤В р┤╕р╡Гр┤╖р╡Нр┤Яр┤┐р┤Ър╡Нр┤Ър┤др┤╛р┤гр╡Н',
			autoGeneratedNote: 'р┤Хр╡Бр┤▒р┤┐р┤кр╡Нр┤кр╡Н: р┤Зр┤др╡Н р┤пр┤╛р┤ир╡Нр┤др╡Нр┤░р┤┐р┤Хр┤ор┤╛р┤пр┤┐ р┤╕р╡Гр┤╖р╡Нр┤Яр┤┐р┤Хр╡Нр┤Хр┤кр╡Нр┤кр╡Жр┤Яр╡Нр┤Я р┤░р╡Зр┤Цр┤пр┤╛р┤гр╡Н. р┤нр╡Чр┤др┤┐р┤Х р┤Тр┤кр╡Нр┤кр╡Бр┤Хр╡╛ р┤Жр┤╡р┤╢р╡Нр┤пр┤ор┤┐р┤▓р╡Нр┤▓. р┤Жр┤ир╡Нр┤др┤░р┤┐р┤Х р┤Ер┤▒р┤┐р┤пр┤┐р┤кр╡Нр┤кр╡Н р┤╕р┤Вр┤╡р┤┐р┤зр┤╛р┤ир┤др╡Нр┤др┤┐р┤▓р╡Вр┤Яр╡Ж р┤Ер┤пр┤Ър╡Нр┤Ър╡Бр┤Хр┤┤р┤┐р┤Юр╡Нр┤Юр┤╛р╡╜, р┤И р┤░р╡Зр┤Ц р┤Зр┤░р╡Б р┤Хр┤Хр╡Нр┤╖р┤┐р┤Хр┤│р╡Бр┤В р┤Фр┤жр╡Нр┤пр╡Лр┤Чр┤┐р┤Хр┤ор┤╛р┤пр┤┐ р┤Тр┤кр╡Нр┤кр┤┐р┤Яр╡Бр┤Хр┤пр╡Бр┤В р┤Ер┤Вр┤Чр╡Ар┤Хр┤░р┤┐р┤Хр╡Нр┤Хр╡Бр┤Хр┤пр╡Бр┤В р┤Ър╡Жр┤пр╡Нр┤др┤др┤╛р┤пр┤┐ р┤Хр┤гр┤Хр╡Нр┤Хр┤╛р┤Хр╡Нр┤Хр┤кр╡Нр┤кр╡Жр┤Яр╡Бр┤В.',
			acknowledgmentStatement: 'р┤ор╡Бр┤Хр┤│р┤┐р╡╜ р┤кр┤▒р┤Юр╡Нр┤Ю р┤ор╡Бр┤ир╡Нр┤ир┤▒р┤┐р┤пр┤┐р┤кр╡Нр┤кр╡Н р┤Ер┤▒р┤┐р┤пр┤┐р┤кр╡Нр┤кр╡Н р┤Юр┤╛р╡╗ р┤╡р┤╛р┤пр┤┐р┤Хр╡Нр┤Хр╡Бр┤Хр┤пр╡Бр┤В р┤ор┤ир┤╕р╡Нр┤╕р┤┐р┤▓р┤╛р┤Хр╡Нр┤Хр╡Бр┤Хр┤пр╡Бр┤В р┤Ър╡Жр┤пр╡Нр┤др╡Б р┤Ор┤ир╡Нр┤ир╡Н р┤Юр┤╛р╡╗ р┤Ер┤Вр┤Чр╡Ар┤Хр┤░р┤┐р┤Хр╡Нр┤Хр╡Бр┤ир╡Нр┤ир╡Б. р┤Ор┤ир╡Нр┤▒р╡Ж р┤кр╡Нр┤░р┤Хр┤Яр┤ир┤В р┤ор╡Жр┤Ър╡Нр┤Ър┤кр╡Нр┤кр╡Жр┤Яр╡Бр┤др╡Нр┤др┤╛р┤ир╡Бр┤В р┤Жр┤╡р┤╢р╡Нр┤пр┤ор┤╛р┤п р┤ор┤╛р┤ир┤жр┤гр╡Нр┤бр┤Щр╡Нр┤Щр╡╛ р┤кр┤╛р┤▓р┤┐р┤Хр╡Нр┤Хр┤╛р┤ир╡Бр┤В р┤Юр┤╛р╡╗ р┤кр╡Нр┤░р┤др┤┐р┤Ьр╡Нр┤Юр┤╛р┤мр┤жр╡Нр┤зр┤ир┤╛р┤гр╡Н.'
		},
		bn: {
			companyName: 'ржЖржХрзБрж░рж╛ ржорзНржпрж╛ржирзЗржЬржорзЗржирзНржЯ рж╕рж┐рж╕рзНржЯрзЗржо',
			documentTitle: 'ржХрж░рзНржоржХрзНрж╖ржорждрж╛ рж╕рждрж░рзНржХрждрж╛ ржирзЛржЯрж┐рж╢',
			date: 'рждрж╛рж░рж┐ржЦ:',
			to: 'ржкрзНрж░рждрж┐:',
			from: 'рж╣рждрзЗ:',
			subject: 'ржмрж┐рж╖ржпрж╝:',
			subjectText: 'ржХрж░рзНржоржХрзНрж╖ржорждрж╛ ржЙржирзНржирждрж┐ ржкрзНрж░ржпрж╝рзЛржЬржи',
			performanceSummary: 'ржХрж░рзНржоржХрзНрж╖ржорждрж╛ рж╕рж╛рж░рж╕ржВржХрзНрж╖рзЗржк',
			totalTasksAssigned: 'ржорзЛржЯ ржирж┐ржпрзБржХрзНржд ржХрж╛ржЬ:',
			tasksCompleted: 'рж╕ржорзНржкржирзНржи ржХрж╛ржЬ:',
			overdueTasks: 'ржмрж┐рж▓ржорзНржмрж┐ржд ржХрж╛ржЬ:',
			completionRate: 'рж╕ржорж╛ржкрзНрждрж┐рж░ рж╣рж╛рж░:',
			warningDetails: 'рж╕рждрж░рзНржХрждрж╛рж░ ржмрж┐рж╢ржж',
			employeeSignature: 'ржХрж░рзНржоржЪрж╛рж░рзАрж░ рж╕рзНржмрж╛ржХрзНрж╖рж░',
			managerSignature: 'ржорзНржпрж╛ржирзЗржЬрж╛рж░рзЗрж░ рж╕рзНржмрж╛ржХрзНрж╖рж░',
			edit: 'рж╕ржорзНржкрж╛ржжржирж╛',
			print: 'ржорзБржжрзНрж░ржг',
			sendWarning: 'рж╕рждрж░рзНржХрждрж╛ ржкрж╛ржарж╛ржи',
			sendWhatsApp: 'рж╣рзЛржпрж╝рж╛ржЯрж╕ржЕрзНржпрж╛ржк ржкрж╛ржарж╛ржи',
			notificationSent: 'ржмрж┐ржЬрзНржЮржкрзНрждрж┐ рж╕ржлрж▓ржнрж╛ржмрзЗ ржкрж╛ржарж╛ржирзЛ рж╣ржпрж╝рзЗржЫрзЗ!',
			whatsappSent: 'рж╣рзЛржпрж╝рж╛ржЯрж╕ржЕрзНржпрж╛ржк ржмрж╛рж░рзНрждрж╛ ржкрж╛ржарж╛ржирзЛ рж╣ржпрж╝рзЗржЫрзЗ!',
			datePlaceholder: 'рждрж╛рж░рж┐ржЦ: ________________',
			improvementRequired: 'ржЖрж░ржУ рж╢рж╛рж╕рзНрждрж┐ржорзВрж▓ржХ ржмрзНржпржмрж╕рзНржерж╛ ржПржбрж╝рж╛рждрзЗ рждрж╛рзОржХрзНрж╖ржгрж┐ржХ ржЙржирзНржирждрж┐ ржкрзНрж░ржпрж╝рзЛржЬржиред',
			documentFooter: 'ржПржЗ ржиржерж┐ржЯрж┐ ржЖржХрзБрж░рж╛ ржорзНржпрж╛ржирзЗржЬржорзЗржирзНржЯ рж╕рж┐рж╕рзНржЯрзЗржо ржжрзНржмрж╛рж░рж╛ рждрзИрж░рж┐',
			autoGeneratedNote: 'ржирзЛржЯ: ржПржЯрж┐ ржПржХржЯрж┐ рж╕рзНржмржпрж╝ржВржХрзНрж░рж┐ржпрж╝ржнрж╛ржмрзЗ рждрзИрж░рж┐ ржиржерж┐ред рж╢рж╛рж░рзАрж░рж┐ржХ рж╕рзНржмрж╛ржХрзНрж╖рж░рзЗрж░ ржкрзНрж░ржпрж╝рзЛржЬржи ржирзЗржЗред ржЕржнрзНржпржирзНрждрж░рзАржг ржмрж┐ржЬрзНржЮржкрзНрждрж┐ ржмрзНржпржмрж╕рзНржерж╛рж░ ржорж╛ржзрзНржпржорзЗ ржкрж╛ржарж╛ржирзЛрж░ ржкрж░рзЗ, ржПржЗ ржиржерж┐ржЯрж┐ ржЙржнржпрж╝ ржкржХрзНрж╖ ржжрзНржмрж╛рж░рж╛ ржЖржирзБрж╖рзНржарж╛ржирж┐ржХржнрж╛ржмрзЗ рж╕рзНржмрж╛ржХрзНрж╖рж░рж┐ржд ржПржмржВ рж╕рзНржмрзАржХрзГржд рж╣рж┐рж╕рж╛ржмрзЗ ржмрж┐ржмрзЗржЪрж┐ржд рж╣ржмрзЗред',
			acknowledgmentStatement: 'ржЖржорж┐ рж╕рзНржмрзАржХрж╛рж░ ржХрж░ржЫрж┐ ржпрзЗ ржЖржорж┐ ржЙржкрж░рзЗрж░ рж╕рждрж░рзНржХрждрж╛ ржирзЛржЯрж┐рж╢ржЯрж┐ ржкржбрж╝рзЗржЫрж┐ ржПржмржВ ржмрзБржЭрзЗржЫрж┐ред ржЖржорж┐ ржЖржорж╛рж░ ржкрж╛рж░ржлрж░ржорзНржпрж╛ржирзНрж╕ ржЙржирзНржиржд ржХрж░рждрзЗ ржПржмржВ ржкрзНрж░ржпрж╝рзЛржЬржирзАржпрж╝ ржорж╛ржи ржкрзВрж░ржг ржХрж░рждрзЗ ржкрзНрж░рждрж┐рж╢рзНрж░рзБрждрж┐ржмржжрзНржзред'
		}
	};

	// Get current language translations
	$: t = translations[data.language] || translations.en;

	// Check if user has WhatsApp contact
	async function checkWhatsAppContact() {
		try {
			let userData = null;
			let userError = null;

			// First try to get user by username if available
			if (data.recipientUsername && data.recipientUsername !== 'Unknown') {
				const result = await supabase
					.from('users')
					.select('employee_id, username')
					.eq('username', data.recipientUsername)
					.single();
				
				userData = result.data;
				userError = result.error;
			}

			// If username lookup failed or no username, try by user ID
			if ((!userData || userError) && data.recipientUserId) {
				console.log('Trying user lookup by ID:', data.recipientUserId);
				const result = await supabase
					.from('users')
					.select('employee_id, username')
					.eq('id', data.recipientUserId)
					.single();
				
				userData = result.data;
				userError = result.error;
			}

			if (userError || !userData?.employee_id) {
				console.log('No employee_id found for user:', data.recipientUsername, 'or user ID:', data.recipientUserId);
				return;
			}

			// Then get the employee's contact information
			const { data: contactData, error } = await supabase
				.from('hr_employee_contacts')
				.select('whatsapp_number')
				.eq('employee_id', userData.employee_id)
				.single();

			if (contactData && contactData.whatsapp_number) {
				hasWhatsApp = true;
				whatsappNumber = contactData.whatsapp_number;
			}
		} catch (err) {
			console.error('Error checking WhatsApp contact:', err);
		}
	}

	function toggleEdit() {
		if (isEditing) {
			// Save changes
			data.warningText = editableWarning;
		}
		isEditing = !isEditing;
	}

	// Function to lookup user ID by username
	async function lookupUserIdByUsername(username) {
		try {
			console.log(`Looking up user ID for username: ${username}`);
			
			// First try the users table
			const { data: userData, error: userError } = await supabaseAdmin
				.from('users')
				.select('id')
				.eq('username', username)
				.single();

			if (userData && !userError) {
				console.log(`Found user ID ${userData.id} for username ${username}`);
				return userData.id;
			}

			// If not found in users table, try hr_employees table
			const { data: hrData, error: hrError } = await supabaseAdmin
				.from('hr_employees')
				.select('id')
				.eq('username', username)
				.single();

			if (hrData && !hrError) {
				console.log(`Found employee ID ${hrData.id} for username ${username}`);
				return hrData.id;
			}

			console.warn(`No user ID found for username: ${username}`);
			return null;
		} catch (error) {
			console.error(`Error looking up user ID for username ${username}:`, error);
			return null;
		}
	}

	async function sendInternalNotification() {
		isSending = true;
		sendError = null;

		try {
			// WARNING RECORD MUST ALREADY BE SAVED BEFORE CALLING THIS
			// This function should only be called after saveAsImage() has saved the record
			if (!warningSaved || !savedWarningId) {
				throw new Error('Warning record must be saved before sending notification. Please use Save Image button first.');
			}

			// Determine the target user ID - try multiple possible fields
			let targetUserId = data.recipientUserId || 
							   data.assignmentData?.assigned_to_user_id || 
							   data.assignmentData?.assignedToUserId ||
							   data.assignmentData?.user_id ||
							   data.assignmentData?.userId;

			if (!targetUserId) {
				// If we still don't have a user ID, try to look it up by username
				const username = data.recipientUsername || data.assignmentData?.assigned_to_username || data.assignmentData?.assigned_to;
				if (username) {
					console.warn(`No user ID found for notification target. Attempting to look up user ID for username: ${username}`);
					targetUserId = await lookupUserIdByUsername(username);
					
					if (!targetUserId) {
						throw new Error(`No valid user ID found for notification target "${username}". User ID is required for push notifications.`);
					}
				} else {
					throw new Error('No valid user ID or username found for notification target');
				}
			}

			// Create notification using notificationManagement for proper push notification support
			const notificationData = {
				title: 'Performance Warning',
				message: `Warning: Performance Review Required\n\n${editableWarning}`,
				type: 'warning',
				priority: 'high',
				target_type: 'specific_users',
				target_users: [targetUserId]
			};

			// Use assigned_by or current user for createdBy - handle undefined case
			const createdBy = data.assignedBy || 
							  data.assignmentData?.assigned_by || 
							  'System Administrator';

			await notificationManagement.createNotification(notificationData, createdBy);

			// Don't close modal automatically - let workflow continue
			console.log('тЬЕ Notification sent successfully');
		} catch (err) {
			console.error('Error sending notification:', err);
			sendError = 'Failed to send notification: ' + err.message;
		} finally {
			isSending = false;
		}
	}

	async function saveWarningRecord() {
		if (warningSaved) {
			console.log('Warning already saved, skipping duplicate save');
			return;
		}

		try {
			// Get current user information from persistent auth
			const user = get(currentUser);
			
			if (!user) {
				throw new Error('User not authenticated');
			}

			// Get the employee information from the user_id to properly link the employee
			let employeeId = null;
			let actualUsername = null;
			let actualUserId = null;
			
			// First try to get user ID from data, then lookup by username if needed
			actualUserId = data.recipientUserId || 
						   data.assignmentData?.assigned_to_user_id || 
						   data.assignmentData?.assignedToUserId;
			
			if (!actualUserId) {
				// Try to lookup user ID by username
				const username = data.recipientUsername || data.assignmentData?.assigned_to_username || data.assignmentData?.assigned_to;
				if (username) {
					actualUserId = await lookupUserIdByUsername(username);
				}
			}
			
			if (actualUserId) {
				try {
					// Get user details to find linked employee
					const { data: userDetails, error: userError } = await supabaseAdmin
						.from('users')
						.select(`
							id,
							username,
							employee_id,
							hr_employees(id, name, employee_id)
						`)
						.eq('id', actualUserId)
						.single();
					
					if (!userError && userDetails) {
						actualUsername = userDetails.username;
						employeeId = userDetails.employee_id; // This is the UUID from users.employee_id
						console.log('Found user details:', {
							userId: userDetails.id,
							username: userDetails.username,
							employeeId: userDetails.employee_id,
							employeeData: userDetails.hr_employees
						});
					} else {
						console.warn('Could not find user details for ID:', actualUserId);
					}
				} catch (err) {
					console.error('Error fetching user details:', err);
				}
			}

			// Prepare warning record data matching the database schema
			const warningRecord = {
				user_id: actualUserId, // Use the looked-up user ID
				employee_id: employeeId, // Now properly linked to hr_employees table
				username: actualUsername || data.recipientUsername || data.assignmentData?.assigned_to || 'unknown_user',
				warning_type: data.warningType,
				has_fine: data.hasFine || false,
				fine_amount: data.fineAmount || null,
				fine_currency: data.fineCurrency || 'USD',
				fine_status: data.hasFine ? 'pending' : null,
				warning_text: editableWarning,
				language_code: data.language || 'en',
				task_id: data.assignmentData?.taskId || data.assignmentData?.task_id || null,
				task_title: data.assignmentData?.taskTitle || data.assignmentData?.task_title || null,
				task_description: data.assignmentData?.taskDescription || data.assignmentData?.task_description || null,
				assignment_id: data.assignmentData?.assignmentId || data.assignmentData?.assignment_id || data.assignmentData?.id || null,
				total_tasks_assigned: data.totalAssigned || data.assignmentData?.total_assigned || 0,
				total_tasks_completed: data.totalCompleted || data.assignmentData?.total_completed || 0,
				total_tasks_overdue: data.totalOverdue || data.assignmentData?.total_overdue || 0,
				completion_rate: data.completionRate || 0,
				issued_by: user?.id || 'system',
				issued_by_username: user?.username || 'system',
				warning_status: 'active',
				branch_id: data.assignmentData?.branchId || data.assignmentData?.branch_id || null,
				severity_level: determineSeverityLevel(),
				follow_up_required: data.hasFine || data.completionRate < 50,
				follow_up_date: data.hasFine ? new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] : null // 7 days from now
			};

			console.log('Saving warning record:', warningRecord);

			// Use admin client to bypass RLS since we have custom authentication
			const { data: insertedData, error } = await supabaseAdmin
				.from('employee_warnings')
				.insert([warningRecord])
				.select()
				.single();

			if (error) {
				console.error('Database error:', error);
				throw new Error(`Failed to save warning record: ${error.message}`);
			}

			console.log('Warning record saved successfully:', insertedData);
			warningSaved = true; // Set flag after successful save
			savedWarningId = insertedData.id; // Store the ID
			return insertedData; // Return the inserted data
		} catch (err) {
			console.error('Error saving warning record:', err);
			// Don't set warningSaved flag if save failed
			throw err;
		}
	}

	function determineSeverityLevel() {
		const completionRate = data.completionRate || 0;
		const hasFine = data.hasFine || false;
		
		if (hasFine && completionRate < 30) return 'critical';
		if (hasFine || completionRate < 40) return 'high';
		if (completionRate < 60) return 'medium';
		return 'low';
	}

	async function sendWarning() {
		if (isSending || isSaving) return;
		
		isSending = true;
		sendError = '';
		
		try {
			// WARNING: This is the OLD workflow function
			// The new workflow requires saving via saveAsImage() first
			// This function should not be called anymore but kept for backwards compatibility
			if (!warningSaved || !savedWarningId) {
				throw new Error('Warning record must be saved first. Please use Save Image button.');
			}
			
			// Then send the notification
			await sendInternalNotification();
			
			// Show success message
			alert(t.warningSent || 'Warning sent successfully!');
			
			// Close modal after successful send
			dispatch('close');
			
		} catch (err) {
			console.error('Error sending warning:', err);
			sendError = 'Failed to send warning: ' + err.message;
		} finally {
			isSending = false;
		}
	}

	function sendToWhatsApp() {
		if (!hasWhatsApp || !whatsappNumber) {
			alert('WhatsApp number not available for this employee');
			return;
		}

		// NEW WORKFLOW: Record must already be saved via saveAsImage()
		if (!warningSaved || !savedWarningId) {
			alert('Please save the warning as image first before sharing to WhatsApp');
			return;
		}
		
		// Generate WhatsApp message
		const message = generateWhatsAppMessage();
		const encodedMessage = encodeURIComponent(message);
		const whatsappUrl = `https://web.whatsapp.com/send?phone=${whatsappNumber}&text=${encodedMessage}`;
		
		// Open WhatsApp Web in new tab
		window.open(whatsappUrl, '_blank');
	}

	function generateWhatsAppMessage() {
		return `*${t.documentTitle}*

${t.to} ${data.recipientName},

*${t.warningDetails}:*
${editableWarning}

---
${t.from} ${currentUserName} (${currentUserPosition})
*Task Assigned By:* ${data.assignedBy}
${t.date} ${new Date().toLocaleDateString()}

${t.companyName}`;
	}

	function printTemplate() {
		// NEW WORKFLOW: Record should already be saved via saveAsImage()
		// But printing doesn't require the record to be saved, so we can allow it
		const printWindow = window.open('', '_blank');
		const printContent = generatePrintableHTML();
		
		printWindow.document.write(printContent);
		printWindow.document.close();
		printWindow.print();
	}

	function generatePrintableHTML() {
		const currentDate = new Date().toLocaleDateString();
		const logoUrl = `${window.location.origin}/icons/logo.png`;
		
		return `
		<!DOCTYPE html>
		<html>
		<head>
			<title>${t.documentTitle}</title>
			<style>
				@page {
					size: A4;
					margin: 20mm;
				}
				body {
					font-family: Arial, sans-serif;
					margin: 0;
					padding: 0;
					line-height: 1.4;
					color: #333;
					font-size: 12px;
				}
				.header {
					text-align: center;
					margin-bottom: 25px;
					border-bottom: 2px solid #333;
					padding-bottom: 15px;
				}
				.logo-container {
					width: 80px;
					height: 40px;
					margin: 0 auto 12px;
					display: flex;
					align-items: center;
					justify-content: center;
				}
				.company-logo {
					max-width: 100%;
					max-height: 100%;
					object-fit: contain;
				}
				.company-name {
					font-size: 18px;
					font-weight: 700;
					color: #111827;
					margin: 0;
				}
				.document-title {
					font-size: 16px;
					font-weight: 700;
					color: #dc2626;
					margin: 12px 0 0 0;
					letter-spacing: 0.5px;
				}
				.logo-container {
					width: 80px;
					height: 40px;
					margin: 0 auto 10px;
					display: flex;
					align-items: center;
					justify-content: center;
				}
				.company-logo {
					max-width: 100%;
					max-height: 100%;
					object-fit: contain;
				}
				.company-name {
					font-size: 16px;
					font-weight: bold;
					margin: 5px 0;
				}
				.document-title {
					font-size: 14px;
					font-weight: bold;
					color: #d32f2f;
					margin: 10px 0;
				}
				.content {
					margin: 20px 0;
				}
				.warning-content {
					background: #fff3cd;
					border: 1px solid #ffeaa7;
					padding: 15px;
					margin: 15px 0;
					border-radius: 4px;
					font-size: 11px;
				}
				.statistics {
					display: grid;
					grid-template-columns: repeat(2, 1fr);
					gap: 8px;
					margin: 15px 0;
					padding: 12px;
					background: #f8f9fa;
					border-radius: 4px;
					font-size: 11px;
				}
				.stat-item {
					display: flex;
					justify-content: space-between;
				}
				.signatures {
					margin-top: 30px;
					display: grid;
					grid-template-columns: 1fr 1fr;
					gap: 20px;
					font-size: 11px;
				}
				.signature-section {
					text-align: center;
				}
				.signature-line {
					border-top: 1px solid #333;
					margin-top: 25px;
					padding-top: 5px;
				}
				.footer {
					margin-top: 20px;
					text-align: center;
					font-size: 10px;
					color: #666;
				}
				@media print {
					body { 
						margin: 0; 
						font-size: 11px;
					}
					.header {
						margin-bottom: 20px;
						padding-bottom: 10px;
					}
				}
			</style>
		</head>
		<body>
			<div class="header">
				<div class="logo-container">
					<img src="${logoUrl}" alt="Company Logo" class="company-logo" />
				</div>
				<div class="company-name">${t.companyName}</div>
				<div class="document-title">${t.documentTitle}</div>
			</div>
			
			<div class="content">
				<p><strong>${t.date}</strong> ${currentDate}</p>
				<p><strong>${t.from}</strong> ${currentUserName} (${currentUserPosition})</p>
				<p><strong>${t.to}</strong> ${data.recipientName}</p>
				<p><strong>${t.subject}</strong> ${t.subjectText}</p>
				<p><strong>${t.taskAssignedBy || 'Task Assigned By:'}</strong> ${data.assignedBy}</p>
				
				<div class="warning-content">
					${editableWarning.split('\n').slice(0, 10).map(line => `<p style="margin: 5px 0;">${line}</p>`).join('')}
				</div>
				
				<p style="margin-top: 15px; font-size: 11px;">${t.improvementRequired}</p>
			</div>
			
			<div class="signatures">
				<div style="max-width: 500px; margin: 30px auto; padding: 20px; border: 2px solid #e5e7eb; border-radius: 8px; background: #ffffff;">
					<div style="text-align: center; font-weight: 600; font-size: 16px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #3b82f6;">
						${t.employeeSignature}
					</div>
					<div style="background: #f0f9ff; border-left: 4px solid #3b82f6; padding: 12px; margin-bottom: 20px; font-size: 12px; line-height: 1.5; color: #1e40af; font-style: italic;">
						${t.acknowledgmentStatement || 'I acknowledge that I have read and understood the above warning notice. I commit to improving my performance and meeting the required standards.'}
					</div>
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
						<div>
							<div style="font-weight: 600; font-size: 12px; margin-bottom: 8px;">${t.date || 'Date'}:</div>
							<div style="border-bottom: 2px solid #9ca3af; padding: 10px 0; min-height: 35px;">________________</div>
						</div>
						<div>
							<div style="font-weight: 600; font-size: 12px; margin-bottom: 8px;">${t.signature || 'Signature'}:</div>
							<div style="border-bottom: 2px solid #9ca3af; padding: 10px 0; min-height: 35px;">________________</div>
						</div>
					</div>
				</div>
			</div>
			
			<div class="auto-note" style="margin-top: 20px; padding: 12px; background: #f3f4f6; border-left: 4px solid #6366f1; font-size: 10px; line-height: 1.5; color: #4b5563; font-style: italic;">
				<p style="margin: 0;">${t.autoGeneratedNote}</p>
			</div>
			
			<div class="footer">
				<p>${t.documentFooter}</p>
			</div>
		</body>
		</html>`;
	}

	/**
	 * New Workflow Functions
	 */
	
	// Step 1: Save warning as image
	async function saveAsImage() {
		if (isSavingImage) return;
		
		isSavingImage = true;
		saveImageError = null;
		
		try {
			// First save the warning record to database if not already saved
			let warningData;
			if (!warningSaved) {
				warningData = await saveWarningRecord();
			} else {
				// Fetch existing warning data
				const { data: existingWarning } = await supabaseAdmin
					.from('employee_warnings')
					.select('*')
					.eq('id', savedWarningId)
					.single();
				warningData = existingWarning;
			}
			
			if (!warningData) {
				throw new Error('Failed to get warning data');
			}
			
			// Get the template body element for capture
			const templateBody = document.querySelector('.template-body');
			if (!templateBody) {
				throw new Error('Template body not found');
			}
			
			// Get employee information
			const employeeName = data.recipientName || warningData.username || 'Unknown';
			const employeeId = warningData.employee_id || null;
			
			console.log('ЁЯУ╕ Capturing warning for:', employeeName, '(ID:', employeeId, ')');
			
			// Capture and upload the image with employee details
			const result = await captureAndSaveWarning(
				templateBody, 
				warningData.id, 
				warningData.warning_reference,
				employeeName,
				employeeId
			);
			
			if (!result.success) {
				throw new Error(result.error);
			}
			
			// Store the image URL
			savedImageUrl = result.imageUrl;
			savedWarningId = result.warningId;
			
			// Move to next step
			workflowStep = 'send';
			
			successMessage = 'тЬЕ Warning saved as image successfully!';
			setTimeout(() => successMessage = null, 3000);
		} catch (err) {
			console.error('Error saving warning as image:', err);
			saveImageError = err.message;
		} finally {
			isSavingImage = false;
		}
	}
	
	// Step 2: Send notification (existing functionality, modified)
	async function sendNotificationWithImage() {
		if (isSending) return;
		
		isSending = true;
		sendError = null;
		
		try {
			// Ensure we have the saved image
			if (!savedImageUrl) {
				throw new Error('Please save the warning as image first');
			}
			
			// Send notification with image URL
			await sendInternalNotification();
			
			// Move to next step
			workflowStep = 'share';
			
			// Success message - use a better notification instead of alert
			successMessage = 'тЬЕ Notification sent successfully!';
			setTimeout(() => successMessage = null, 3000);
		} catch (err) {
			console.error('Error sending notification:', err);
			sendError = 'Failed to send notification: ' + err.message;
		} finally {
			isSending = false;
		}
	}
	
	// Step 3: Share to WhatsApp
	function shareToWhatsApp() {
		if (!savedImageUrl) {
			alert('Please save and send the warning first');
			return;
		}
		
		// Generate WhatsApp message with image link
		const whatsappUrl = generateWhatsAppShareUrl(
			savedImageUrl,
			data.recipientName,
			`*${t.documentTitle}*\n\n${t.to} ${data.recipientName},\n\n${t.warningDetails}\n\nView document: ${savedImageUrl}\n\n${t.from} ${currentUserName} (${currentUserPosition})\n${t.date} ${new Date().toLocaleDateString()}\n\n${t.companyName}`
		);
		
		// Open WhatsApp Web
		window.open(whatsappUrl, '_blank');
	}

	function closeModal() {
		dispatch('close');
	}
</script>

<div class="template-overlay" on:click={closeModal}>
	<div class="template-content" on:click|stopPropagation>
		<div class="template-header">
			<div class="header-left">
				<h2 class="template-title">Warning Template</h2>
				<span class="language-badge">{data.language.toUpperCase()}</span>
			</div>
			<div class="header-right">
				<button class="edit-btn" on:click={toggleEdit}>
					{#if isEditing}
						<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
						</svg>
						Save
					{:else}
						<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
						</svg>
						{t.edit}
					{/if}
				</button>
				<button class="print-btn" on:click={printTemplate}>
					<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
					</svg>
					{t.print}
				</button>
				<button class="close-btn" on:click={closeModal}>
					<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
					</svg>
				</button>
			</div>
		</div>

		<div class="template-body">
			<!-- Template Header Section -->
			<div class="document-header">
				<div class="logo-section">
					<div class="logo-container">
						<img src="/icons/logo.png" alt="Company Logo" class="company-logo" />
					</div>
					<h3 class="company-name">{t.companyName}</h3>
				</div>
				<h2 class="document-title">{t.documentTitle}</h2>
			</div>

			<!-- Document Details -->
			<div class="document-details">
				<div class="detail-row">
					<span class="detail-label">{t.date}</span>
					<span class="detail-value">{new Date().toLocaleDateString()}</span>
				</div>
				<div class="detail-row">
					<span class="detail-label">{t.from}</span>
					<span class="detail-value">{currentUserName} ({currentUserPosition})</span>
				</div>
				<div class="detail-row">
					<span class="detail-label">{t.to}</span>
					<span class="detail-value">{data.recipientName} ({data.recipientUsername})</span>
				</div>
				<div class="detail-row">
					<span class="detail-label">{t.subject}</span>
					<span class="detail-value">{t.subjectText}</span>
				</div>
				<div class="detail-row">
					<span class="detail-label">{t.taskAssignedBy || 'Task Assigned By:'}</span>
					<span class="detail-value">{data.assignedBy}</span>
				</div>
			</div>

			<!-- Warning Content -->
			<div class="warning-section">
				<h4 class="section-title">{t.warningDetails}</h4>
				{#if isEditing}
					<textarea 
						bind:value={editableWarning}
						class="warning-textarea"
						rows="8"
						placeholder="Enter warning text..."
					></textarea>
				{:else}
					<div class="warning-text">
						{#each editableWarning.split('\n') as line}
							<p>{line}</p>
						{/each}
					</div>
				{/if}
			</div>

			<!-- Signature Section -->
			<div class="signature-section">
				<div class="signature-card">
					<h5 class="signature-title">{t.employeeSignature}</h5>
					<div class="acknowledgment-text">
						{t.acknowledgmentStatement || 'I acknowledge that I have read and understood the above warning notice. I commit to improving my performance and meeting the required standards.'}
					</div>
					<div class="signature-fields">
						<div class="signature-field">
							<label>{t.date || 'Date'}:</label>
							<div class="field-line">________________</div>
						</div>
						<div class="signature-field">
							<label>{t.signature || 'Signature'}:</label>
							<div class="field-line">________________</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Auto-Generated Document Note -->
			<div class="auto-generated-note">
				<p>{t.autoGeneratedNote}</p>
			</div>
		</div>

		<!-- Error Messages -->
		{#if sendError}
			<div class="error-message">
				{sendError}
			</div>
		{/if}
		{#if saveImageError}
			<div class="error-message">
				{saveImageError}
			</div>
		{/if}

		<!-- Success Message -->
		{#if successMessage}
			<div class="success-message">
				{successMessage}
			</div>
		{/if}

		<!-- Action Buttons - Workflow -->
		<div class="template-footer">
			<div class="action-buttons">
				<!-- Step 1: Save as Image -->
				{#if workflowStep === 'edit' || workflowStep === 'save'}
					<button 
						class="action-btn save-image-btn"
						on:click={saveAsImage}
						disabled={isSavingImage}
					>
						{#if isSavingImage}
							<div class="loading-spinner"></div>
						{:else}
							<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
							</svg>
						{/if}
						ЁЯТ╛ Save as Image
					</button>
				{/if}
				
				<!-- Step 2: Send Notification -->
				{#if workflowStep === 'send'}
					<button 
						class="action-btn notification-btn"
						on:click={sendNotificationWithImage}
						disabled={isSending}
					>
						{#if isSending}
							<div class="loading-spinner"></div>
						{:else}
							<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
							</svg>
						{/if}
						ЁЯУд Send Notification
					</button>
				{/if}
				
				<!-- Step 3: Share to WhatsApp -->
				{#if workflowStep === 'share'}
					<div class="share-section">
						<button 
							class="action-btn whatsapp-btn"
							on:click={shareToWhatsApp}
						>
							<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
								<path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.106"/>
							</svg>
							ЁЯУ▒ Share to WhatsApp
						</button>
						<div class="image-link-section">
							<span class="link-label">Saved Image:</span>
							<a href={savedImageUrl} target="_blank" class="image-link">
								View Image ЁЯФЧ
							</a>
						</div>
					</div>
				{/if}
				
				<!-- Workflow Progress Indicator -->
				<div class="workflow-progress">
					<div class="progress-step" class:active={workflowStep === 'save' || workflowStep === 'edit'}>
						<span class="step-number">1</span>
						<span class="step-label">Save</span>
					</div>
					<div class="progress-line" class:completed={workflowStep === 'send' || workflowStep === 'share'}></div>
					<div class="progress-step" class:active={workflowStep === 'send'} class:completed={workflowStep === 'share'}>
						<span class="step-number">2</span>
						<span class="step-label">Send</span>
					</div>
					<div class="progress-line" class:completed={workflowStep === 'share'}></div>
					<div class="progress-step" class:active={workflowStep === 'share'}>
						<span class="step-number">3</span>
						<span class="step-label">Share</span>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<style>
	.template-overlay {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: rgba(0, 0, 0, 0.6);
		display: flex;
		align-items: center;
		justify-content: center;
		z-index: 1001;
	}

	.template-content {
		background: white;
		border-radius: 12px;
		box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
		width: 95%;
		max-width: 900px;
		max-height: 95vh;
		overflow-y: auto;
		position: relative;
	}

	.template-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: 20px 24px;
		border-bottom: 1px solid #e5e7eb;
		position: sticky;
		top: 0;
		background: white;
		z-index: 10;
	}

	.header-left {
		display: flex;
		align-items: center;
		gap: 12px;
	}

	.template-title {
		font-size: 20px;
		font-weight: 600;
		color: #111827;
		margin: 0;
	}

	.language-badge {
		background: #3b82f6;
		color: white;
		padding: 4px 8px;
		border-radius: 4px;
		font-size: 12px;
		font-weight: 600;
	}

	.header-right {
		display: flex;
		align-items: center;
		gap: 8px;
	}

	.edit-btn, .print-btn, .close-btn {
		display: flex;
		align-items: center;
		gap: 4px;
		padding: 6px 12px;
		border: 1px solid #d1d5db;
		background: white;
		color: #374151;
		border-radius: 6px;
		font-size: 14px;
		font-weight: 500;
		cursor: pointer;
		transition: all 0.2s ease;
	}

	.edit-btn:hover, .print-btn:hover {
		background: #f9fafb;
		border-color: #9ca3af;
	}

	.close-btn {
		border-color: transparent;
		color: #6b7280;
	}

	.close-btn:hover {
		background: #f3f4f6;
		color: #374151;
	}

	.template-body {
		padding: 20px;
		max-width: 210mm;
		min-height: 297mm;
		margin: 0 auto;
		background: white;
		box-shadow: 0 0 10px rgba(0,0,0,0.1);
	}

	.document-header {
		text-align: center;
		margin-bottom: 20px;
		padding-bottom: 15px;
		border-bottom: 2px solid #111827;
	}

	.logo-section {
		margin-bottom: 20px;
	}

	.logo-placeholder {
		width: 120px;
		height: 60px;
		background: #f3f4f6;
		border: 2px dashed #9ca3af;
		margin: 0 auto 16px;
		display: flex;
		align-items: center;
		justify-content: center;
		color: #6b7280;
		font-size: 12px;
		font-weight: 600;
		border-radius: 8px;
	}

	.logo-container {
		width: 80px;
		height: 40px;
		margin: 0 auto 12px;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.company-logo {
		max-width: 100%;
		max-height: 100%;
		object-fit: contain;
	}

	.company-name {
		font-size: 18px;
		font-weight: 700;
		color: #111827;
		margin: 0;
	}

	.document-title {
		font-size: 16px;
		font-weight: 700;
		color: #dc2626;
		margin: 12px 0 0 0;
		letter-spacing: 0.5px;
	}

	.document-details {
		margin-bottom: 24px;
		padding: 20px;
		background: #f9fafb;
		border-radius: 8px;
	}

	.detail-row {
		display: flex;
		margin-bottom: 8px;
	}

	.detail-row:last-child {
		margin-bottom: 0;
	}

	.detail-label {
		font-weight: 600;
		color: #374151;
		min-width: 80px;
	}

	.detail-value {
		color: #111827;
	}

	.signature-section, .warning-section, .signature-section {
		margin-bottom: 32px;
	}

	.signature-card {
		max-width: 600px;
		margin: 0 auto;
		padding: 24px;
		background: #ffffff;
		border: 2px solid #e5e7eb;
		border-radius: 12px;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
	}

	.signature-title {
		font-size: 18px;
		font-weight: 600;
		color: #111827;
		margin: 0 0 16px 0;
		text-align: center;
		padding-bottom: 12px;
		border-bottom: 2px solid #3b82f6;
	}

	.acknowledgment-text {
		background: #f0f9ff;
		border-left: 4px solid #3b82f6;
		padding: 16px;
		margin-bottom: 24px;
		border-radius: 4px;
		font-size: 14px;
		line-height: 1.6;
		color: #1e40af;
		font-style: italic;
	}

	.signature-fields {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 24px;
	}

	.signature-field {
		display: flex;
		flex-direction: column;
		gap: 8px;
	}

	.signature-field label {
		font-weight: 600;
		color: #374151;
		font-size: 14px;
	}

	.field-line {
		padding: 12px 0;
		border-bottom: 2px solid #9ca3af;
		min-height: 40px;
		color: #6b7280;
		font-size: 14px;
	}

	.section-title {
		font-size: 18px;
		font-weight: 600;
		color: #111827;
		margin: 0 0 16px 0;
		padding-bottom: 8px;
		border-bottom: 1px solid #e5e7eb;
	}

	.stats-grid {
		display: grid;
		grid-template-columns: repeat(2, 1fr);
		gap: 16px;
		padding: 20px;
		background: #f8fafc;
		border-radius: 8px;
		border: 1px solid #e2e8f0;
	}

	.stat-item {
		display: flex;
		justify-content: space-between;
		align-items: center;
	}

	.stat-label {
		font-weight: 500;
		color: #475569;
	}

	.stat-value {
		font-weight: 700;
		color: #111827;
	}

	.stat-completed {
		color: #059669;
	}

	.stat-overdue {
		color: #dc2626;
	}

	.warning-textarea {
		width: 100%;
		padding: 16px;
		border: 1px solid #d1d5db;
		border-radius: 8px;
		font-size: 14px;
		line-height: 1.6;
		resize: vertical;
		min-height: 200px;
	}

	.warning-textarea:focus {
		outline: none;
		border-color: #3b82f6;
		box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
	}

	.warning-text {
		padding: 20px;
		background: #fff3cd;
		border: 1px solid #ffeaa7;
		border-radius: 8px;
		line-height: 1.6;
	}

	.auto-generated-note {
		margin-top: 30px;
		padding: 16px;
		background: #f3f4f6;
		border-left: 4px solid #6366f1;
		border-radius: 4px;
		font-size: 12px;
		line-height: 1.6;
		color: #4b5563;
		font-style: italic;
	}

	.auto-generated-note p {
		margin: 0;
	}

	.warning-text p {
		margin: 0 0 12px 0;
		color: #111827;
	}

	.warning-text p:last-child {
		margin-bottom: 0;
	}

	.error-message {
		background: #fef2f2;
		border: 1px solid #fecaca;
		color: #dc2626;
		padding: 16px;
		margin: 16px 24px;
		border-radius: 8px;
		font-size: 14px;
	}

	.success-message {
		background: #f0fdf4;
		border: 1px solid #bbf7d0;
		color: #16a34a;
		padding: 16px;
		margin: 16px 24px;
		border-radius: 8px;
		font-size: 14px;
		font-weight: 500;
		animation: slideIn 0.3s ease-out;
	}

	@keyframes slideIn {
		from {
			opacity: 0;
			transform: translateY(-10px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	.template-footer {
		padding: 24px;
		border-top: 1px solid #e5e7eb;
		background: #f9fafb;
		border-bottom-left-radius: 12px;
		border-bottom-right-radius: 12px;
	}

	.action-buttons {
		display: flex;
		gap: 12px;
		justify-content: center;
		flex-wrap: wrap;
	}

	.action-btn {
		display: flex;
		align-items: center;
		gap: 8px;
		padding: 12px 20px;
		border: none;
		border-radius: 8px;
		font-size: 14px;
		font-weight: 500;
		cursor: pointer;
		transition: all 0.2s ease;
	}

	.notification-btn {
		background: #3b82f6;
		color: white;
	}

	.notification-btn:hover:not(:disabled) {
		background: #2563eb;
	}

	.notification-btn:disabled {
		opacity: 0.6;
		cursor: not-allowed;
	}

	.whatsapp-btn {
		background: #25d366;
		color: white;
	}

	.whatsapp-btn:hover {
		background: #20ba5a;
	}

	.save-image-btn {
		background: #8b5cf6;
		color: white;
	}

	.save-image-btn:hover:not(:disabled) {
		background: #7c3aed;
	}

	.save-image-btn:disabled {
		opacity: 0.6;
		cursor: not-allowed;
	}

	.share-section {
		display: flex;
		flex-direction: column;
		gap: 12px;
		align-items: center;
		width: 100%;
	}

	.image-link-section {
		display: flex;
		align-items: center;
		gap: 8px;
		padding: 8px 16px;
		background: #f0fdf4;
		border: 1px solid #bbf7d0;
		border-radius: 6px;
		font-size: 13px;
	}

	.link-label {
		color: #166534;
		font-weight: 500;
	}

	.image-link {
		color: #2563eb;
		text-decoration: none;
		font-weight: 600;
		display: flex;
		align-items: center;
		gap: 4px;
		transition: color 0.2s;
	}

	.image-link:hover {
		color: #1d4ed8;
		text-decoration: underline;
	}

	.workflow-progress {
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 12px;
		margin-top: 24px;
		padding-top: 20px;
		border-top: 1px solid #e5e7eb;
		width: 100%;
	}

	.progress-step {
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: 6px;
		opacity: 0.4;
		transition: opacity 0.3s;
	}

	.progress-step.active,
	.progress-step.completed {
		opacity: 1;
	}

	.step-number {
		width: 32px;
		height: 32px;
		border-radius: 50%;
		background: #e5e7eb;
		color: #6b7280;
		display: flex;
		align-items: center;
		justify-content: center;
		font-weight: 600;
		font-size: 14px;
		transition: all 0.3s;
	}

	.progress-step.active .step-number {
		background: #3b82f6;
		color: white;
	}

	.progress-step.completed .step-number {
		background: #10b981;
		color: white;
	}

	.step-label {
		font-size: 12px;
		color: #6b7280;
		font-weight: 500;
	}

	.progress-step.active .step-label {
		color: #3b82f6;
		font-weight: 600;
	}

	.progress-step.completed .step-label {
		color: #10b981;
	}

	.progress-line {
		width: 40px;
		height: 2px;
		background: #e5e7eb;
		transition: background 0.3s;
	}

	.progress-line.completed {
		background: #10b981;
	}

	.loading-spinner {
		width: 16px;
		height: 16px;
		border: 2px solid rgba(255, 255, 255, 0.3);
		border-top: 2px solid white;
		border-radius: 50%;
		animation: spin 1s linear infinite;
	}

	@keyframes spin {
		0% { transform: rotate(0deg); }
		100% { transform: rotate(360deg); }
	}

	@media (max-width: 768px) {
		.template-content {
			width: 98%;
			max-height: 98vh;
		}
		
		.template-header {
			flex-direction: column;
			gap: 12px;
			padding: 16px;
		}
		
		.template-body {
			padding: 20px;
		}
		
		.stats-grid {
			grid-template-columns: 1fr;
		}
		
		.signature-grid {
			grid-template-columns: 1fr;
			gap: 24px;
		}
		
		.action-buttons {
			flex-direction: column;
		}
	}
</style>