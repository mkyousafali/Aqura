# GitHub Copilot Instructions for Aqura Management System

## ðŸ”„ Version Management Protocol

**CRITICAL: Every time you commit and push changes to git, you MUST update the version number.**

### Automatic Version Update Process:

1. **Before committing any changes**, run the version update script:
   ```bash
   # Use npm scripts (recommended)
   npm run version:patch    # For bug fixes and small improvements
   npm run version:minor    # For new features 
   npm run version:major    # For breaking changes
   
   # Or use direct script
   node scripts/update-version.js [patch|minor|major]
   ```
   This will automatically:
   - Increment version (2.0.2 â†’ 2.0.3)
   - Update root `package.json`
   - Update `frontend/package.json`
   - Update version display in `frontend/src/lib/components/Sidebar.svelte`
   - Update mobile version in `frontend/src/routes/mobile/+layout.svelte`

2. **Update version popup content manually** (REQUIRED):
   - Edit `frontend/src/lib/components/Sidebar.svelte` (lines ~610-650)
   - Update feature descriptions to match your changes
   - Update release date and version info
   - Use specific action words: "Fixed", "Implemented", "Enhanced", "Added"

3. **Then proceed with git operations**:
   ```bash
   git add -A
   git commit -m "feat: your feature description"
   git push origin master
   ```

### Version Update Guidelines:

- **Patch (x.x.X)**: Bug fixes, small improvements, styling changes, documentation updates
- **Minor (x.X.0)**: New features, component additions, significant enhancements, new modules
- **Major (X.0.0)**: Breaking changes, major architecture changes, API changes, complete rewrites

### Files That Display Version:

- `frontend/src/lib/components/Sidebar.svelte` - Desktop version footer and popup content
- `frontend/src/routes/mobile/+layout.svelte` - Mobile top bar version badge
- `package.json` - Root project version
- `frontend/package.json` - Frontend project version

### Integration Points:

The version number appears in:
1. **Desktop Sidebar Footer**: Shows version as "v2.0.2" with clickable popup
2. **Mobile Header Badge**: Shows version badge in top navigation
3. **Package Metadata**: Used for builds and deployments
4. **Version Popup**: Detailed release notes and feature descriptions

### Copilot Workflow Checklist:

Before every `git push`:
- [ ] Run `npm run version:[patch|minor|major]`
- [ ] Update version popup content in Sidebar.svelte
- [ ] Verify version updated in all 4 locations
- [ ] Test version display in both desktop and mobile interfaces
- [ ] Commit version changes with descriptive message
- [ ] Push to remote repository

### Error Handling:

If version update script fails:
1. Check if all target files exist
2. Verify file permissions
3. Ensure valid JSON syntax in package.json files
4. Check for merge conflicts in target files

### Manual Version Update (Fallback):

If script fails, manually update these files:
1. `/package.json` - "version" field
2. `/frontend/package.json` - "version" field  
3. `/frontend/src/lib/components/Sidebar.svelte` - Version footer and popup content
4. `/frontend/src/routes/mobile/+layout.svelte` - Mobile version badge

---

## âš ï¸ Important: Always Confirm Before Making Changes

**CRITICAL RULE: NEVER assume or make changes without explicit confirmation from the user.**

### Before Making ANY Changes:
1. **Analyze the request thoroughly** - Understand what the user is asking for
2. **Check existing implementation** - Review current code, database schema, and structure
3. **Identify potential impacts** - Consider what will be affected by the change
4. **Present a clear plan** - Explain what you will change and why
5. **WAIT for user confirmation** - Do not proceed until the user explicitly approves

### What Requires Confirmation:
- âœ‹ **Database changes** (schema, functions, triggers, RLS policies)
- âœ‹ **File creation/deletion** (new components, utilities, routes)
- âœ‹ **Code modifications** (logic changes, refactoring, optimizations)
- âœ‹ **Configuration updates** (package.json, vite.config, tailwind.config)
- âœ‹ **Architectural decisions** (new patterns, state management, API structure)
- âœ‹ **Version updates** (dependencies, framework versions)
- âœ‹ **Build/deployment changes** (build scripts, deployment config)

### Exceptions (Can proceed without confirmation):
- âœ… **Reading files** to gather context
- âœ… **Searching codebase** to understand structure
- âœ… **Checking database schema** using utility scripts
- âœ… **Providing information** or explanations
- âœ… **Suggesting solutions** without implementing them

### Communication Pattern:
```
User: "Add a new feature X"

Copilot Response:
"I'll help you add feature X. Let me first check the current implementation...

[After checking]

Here's my plan:
1. Create new component at src/lib/components/X.svelte
2. Add route at src/routes/x/+page.svelte
3. Update windowManager.ts to include new window type
4. Add i18n translations for Arabic/English

This will affect:
- Window system (new window type)
- Routing (new route)
- i18n files (new translations)

Should I proceed with this implementation?"

[WAIT FOR USER: "yes" / "proceed" / "go ahead"]
```

### Never Assume:
- âŒ Don't assume column names exist in database tables - CHECK FIRST
- âŒ Don't assume functions or triggers exist - VERIFY using utility scripts
- âŒ Don't assume file structure - LIST directories if unsure
- âŒ Don't assume dependencies are installed - CHECK package.json
- âŒ Don't assume user wants a specific implementation - ASK for preferences
- âŒ Don't assume backwards compatibility is not needed - CONFIRM breaking changes

### Terminal Commands:
- **ALWAYS use PowerShell commands** - The development environment is VS Code on Windows with PowerShell
- Use PowerShell syntax: `Remove-Item`, `Copy-Item`, `Get-ChildItem`, etc.
- NOT bash/Linux commands: avoid `rm`, `cp`, `ls`, etc.
- Use semicolons (`;`) to chain commands on a single line if needed
- Use `2>$null` to suppress error output in PowerShell

### Git Workflow:
- **ALWAYS check git status before push** - Use `git status` to review staged and unstaged changes
- Review what files will be committed before pushing
- Ensure no unintended files are staged (e.g., .env, node_modules, build artifacts)
- Verify commit message follows conventional commits format
- Check for any merge conflicts before pushing

```powershell
# Recommended git workflow
git status                           # Check current status
git add -A                          # Stage all changes (after review)
git status                          # Verify staged changes
git commit -m "feat: description"   # Commit with conventional format
git status                          # Confirm clean working tree
git push origin master              # Push to remote
```

---

## ðŸŽ¯ Project Context

### Current Status: v2.0.2
- **Phase**: Development - Frontend foundation completed
- **Focus**: PWA-first windowed management platform for Saudi businesses
- **Target**: Bilingual (Arabic/English) enterprise management system

### Architecture:
- **Frontend**: SvelteKit + TypeScript + TailwindCSS + Vite PWA
- **Backend**: Go (Fiber framework) + Supabase (PostgreSQL + Auth + Storage)  
- **Deployment**: Vercel (Frontend) + Supabase (Backend)
- **Build Tools**: pnpm monorepo + Vite + PWA + Electron packaging
- **Package Manager**: pnpm (required - NOT npm/yarn)

### Development Environment:
```bash
# Install dependencies
pnpm setup  # or pnpm install

# Development servers  
pnpm dev  # Runs both frontend and backend
pnpm --filter frontend dev  # Frontend only (port 5173)

# Build commands
pnpm build  # Build all
pnpm build:pwa  # PWA build
pnpm build:windows  # Windows installer

# Utility commands
pnpm lint  # Lint all packages
pnpm test  # Run all tests  
pnpm i18n:extract  # Extract i18n strings
```

### Key Features Implemented:
- âœ… **Windowed Desktop Interface**: Drag/resize/minimize windows, taskbar, command palette
- âœ… **PWA Capabilities**: Installable, offline-first, service worker, push notifications
- âœ… **Bilingual System**: Arabic/English with RTL support and cultural adaptations
- âœ… **Business Modules**: 
  - HR Management (employees, departments, positions, salary)
  - Branch Management (multi-branch operations)
  - Vendor Management (vendor details, payment schedules, visits)
  - Receiving Management (receiving records, tasks, workflow)
  - Task System (assignments, completion tracking, reminders)
  - Customer Management (registration, login, recovery)
  - Finance Management (expenses, requisitions, payments)
  - Notification System (push notifications, in-app notifications)
- âœ… **Accessibility**: WCAG 2.1 compliant, screen reader support, keyboard navigation
- âœ… **Security**: Supabase RLS, JWT auth, encrypted transmission

### Key Components:
- **Window Manager** (`windowManager`) - Desktop-style window management system
- **Sidebar Navigation** - Multi-level navigation with submenus and role-based access
- **i18n System** - Custom bilingual localization (not auto-translate)
- **PWA Features** - Service worker, offline support, installation, push notifications
- **Data Management** - Supabase integration with real-time updates
- **User Management** - Role-based access control with position-based permissions
- **Task Management** - Full task workflow with assignments, completion, and tracking
- **Notification Center** - In-app notifications with attachments and read states
- **Receiving System** - Complete receiving workflow with role-specific tasks
- **My Tasks View** - Personal task dashboard with smooth UI updates

### UI/UX Guidelines:
- **Desktop-First**: Windowed interface with OS-style interactions
- **Mobile Responsive**: Touch-friendly mobile layouts
- **Bilingual**: Arabic RTL + English LTR with cultural adaptations
- **Accessibility**: ARIA labels, keyboard navigation, screen reader support
- **Color System**: Brand colors with consistent theming
- **Typography**: Noto Sans Arabic + Inter fonts

### Code Style Guidelines:
- **TypeScript**: Use for type safety, balanced typing (strict for domain, relaxed for UI)
- **Svelte Patterns**: Follow reactive patterns with Svelte stores
- **Error Handling**: Implement proper error handling with user feedback
- **Loading States**: Add loading states and user feedback for all async operations
- **Accessibility**: Use semantic HTML, ARIA labels, and keyboard navigation
- **Modularity**: Keep functions focused and modular
- **i18n**: Use custom i18n system (`import { t } from '$i18n'`)
- **Responsive**: Mobile-first responsive design with touch support

### Database Schema (Supabase):
**Note**: SQL migration files have been removed from the repository. Database schema is managed directly in Supabase.

**IMPORTANT**: Always check the original database schema, functions, triggers, and constraints directly in Supabase using the service role key before making any database-related changes or assumptions.

**How to Check Table Structure** (Use `check-table-structure.js`):
```bash
# Check any table structure and see column names, types, and sample data
node check-table-structure.js [table_name]

# Examples:
node check-table-structure.js hr_employees
node check-table-structure.js receiving_records
node check-table-structure.js tasks
```

**How to Check Database Schema** (JavaScript):
```javascript
// Use service role key from .env file for full database access
import { readFileSync } from 'fs';
import { createClient } from '@supabase/supabase-js';

// Load environment variables from frontend/.env
const envPath = './frontend/.env';
const envContent = readFileSync(envPath, 'utf-8');
const envVars = {};

envContent.split('\n').forEach(line => {
  const trimmed = line.trim();
  if (trimmed && !trimmed.startsWith('#')) {
    const match = trimmed.match(/^([^=]+)=(.*)$/);
    if (match) {
      envVars[match[1].trim()] = match[2].trim();
    }
  }
});

const supabaseUrl = envVars.VITE_SUPABASE_URL;
const supabaseServiceKey = envVars.VITE_SUPABASE_SERVICE_ROLE_KEY;

const supabase = createClient(supabaseUrl, supabaseServiceKey);

// Check table structure and data
const { data, error, count } = await supabase
  .from('table_name')
  .select('*', { count: 'exact' })
  .limit(1);

// Get column names
if (data && data.length > 0) {
  const columns = Object.keys(data[0]);
  console.log('Columns:', columns);
}
```

**Environment Variables** (from `frontend/.env` file):
- `VITE_SUPABASE_URL` - Supabase project URL
- `VITE_SUPABASE_ANON_KEY` - Public anon key (limited access)
- `VITE_SUPABASE_SERVICE_ROLE_KEY` - Service role key (full database access, check schema)

**Total Tables: 65**

Core tables by category:

**User & Authentication:**
- `users` - User accounts and profiles with RLS
- `user_roles` - User role assignments
- `user_sessions` - Active user sessions
- `user_device_sessions` - Device-specific sessions
- `user_password_history` - Password change history
- `user_audit_logs` - User activity audit trail
- `role_permissions` - Role-based permissions
- `interface_permissions` - UI permission controls

**HR Management (11 tables):**
- `hr_employees` - Employee records (203 records)
- `hr_departments` - Department structure
- `hr_positions` - Position definitions
- `hr_position_assignments` - Employee-position mapping
- `hr_levels` - Hierarchical levels
- `hr_salary_components` - Salary breakdown
- `hr_salary_wages` - Wage information
- `hr_employee_contacts` - Employee contact details
- `hr_employee_documents` - Document management
- `hr_fingerprint_transactions` - Attendance tracking
- `hr_position_reporting_template` - Reporting structure

**Task Management (13 tables):**
- `tasks` - Main task system with assignments
- `task_assignments` - Task-user assignments
- `task_completions` - Task completion records
- `task_images` - Task attachments
- `task_reminder_logs` - Reminder history
- `receiving_tasks` - Receiving-specific tasks
- `receiving_task_templates` - Task templates
- `quick_tasks` - Quick task creation
- `quick_task_assignments` - Quick task assignments
- `quick_task_comments` - Task comments
- `quick_task_completions` - Quick task completions
- `quick_task_files` - Quick task attachments
- `quick_task_user_preferences` - User preferences
- `recurring_assignment_schedules` - Recurring task schedules
- `recurring_schedule_check_log` - Schedule execution log

**Receiving & Vendor (3 tables):**
- `receiving_records` - Receiving transaction data (755 records)
- `vendors` - Vendor information
- `vendor_payment_schedule` - Payment schedules

**Notifications (6 tables):**
- `notifications` - System notifications
- `notification_queue` - Push notification queue
- `notification_attachments` - Notification attachments
- `notification_recipients` - Notification recipients
- `notification_read_states` - Read status tracking
- `push_subscriptions` - Web push subscriptions

**Finance & Expenses (7 tables):**
- `expense_requisitions` - Expense requests
- `expense_parent_categories` - Main categories
- `expense_sub_categories` - Sub categories
- `expense_scheduler` - Scheduled expenses
- `employee_warnings` - Employee warnings
- `employee_warning_history` - Warning history
- `employee_fine_payments` - Fine payment tracking
- `non_approved_payment_scheduler` - Pending payments

**Customer Management (5 tables):**
- `customers` - Customer accounts
- `customer_recovery_requests` - Account recovery
- `customer_access_code_history` - Access code history
- `customer_app_media` - Customer media content
- `delivery_service_settings` - Delivery configuration
- `delivery_fee_tiers` - Delivery fee structure

**Product Management (4 tables):**
- `products` - Product catalog
- `product_categories` - Product categories
- `product_units` - Measurement units
- `tax_categories` - Tax definitions

**System & Configuration (4 tables):**
- `branches` - Branch/location management
- `app_functions` - System functions
- `approval_permissions` - Approval workflows
- `requesters` - Request originators

### Database Functions (Supabase):
**Total Functions: 256** organized into 8 categories

Use `node list-functions.js` to see all functions by category.

**Key Functions by Category:**

**Task Management (59 functions)** - Task workflow and completion
- `complete_receiving_task_simple` - Complete receiving tasks with validation
- `create_quick_task_with_assignments` - Create and assign quick tasks
- `check_overdue_tasks_and_send_reminders` - Automated reminder system
- `validate_task_completion_requirements` - Ensure completion criteria met

**Receiving & Vendor (51 functions)** - Receiving workflow and vendor management
- `get_vendor_for_receiving_record` - Fetch vendor details for receiving
- `calculate_next_visit_date` - Auto-calculate vendor visit schedules
- `sync_erp_reference_for_receiving_record` - Sync ERP invoice references

**User Management (20 functions)** - Authentication and permissions
- `create_user` - User account creation with role assignment
- `verify_password` - Password verification and hashing
- `get_user_interface_permissions` - Retrieve UI permission set

**Employee/HR (10 functions)** - HR and employee management
- `sync_employee_with_hr` - Sync employee data with HR system
- `get_active_employees_by_branch` - Branch-specific employee lists

**Financial (16 functions)** - Payment and expense management
- `record_fine_payment` - Record employee fine payments
- `count_bills_without_pr_excel` - Track missing PR Excel files
- `validate_payment_methods` - Ensure valid payment method selection

**Notification (23 functions)** - Push and in-app notifications
- `queue_push_notification` - Queue notifications for delivery
- `process_push_notification_queue` - Process queued notifications
- `cleanup_orphaned_notifications` - Maintain notification hygiene

**Customer (12 functions)** - Customer account management
- `authenticate_customer_access_code` - Customer authentication
- `create_customer_registration` - New customer registration
- `process_customer_recovery` - Account recovery workflow

**System/ERP (31 functions)** - System utilities and ERP integration
- `get_database_schema` - Retrieve complete database schema
- `get_database_functions` - List all database functions
- `sync_all_missing_erp_references` - Batch sync ERP data
- `http_*` - HTTP utility functions for external API calls

### Database Triggers (Supabase):
**Total Triggers: 71** across 35 tables organized by function type

Use `node list-triggers.js` to see all triggers by table.

**Key Trigger Types:**

**Timestamp Management (Most tables):**
- `update_updated_at` - Auto-update timestamp on record changes
- Applied to most core tables for audit trails

**Auto-Calculations:**
- `calculate_receiving_amounts` - Auto-calculate amounts in receiving records
- `calculate_category_days` - Calculate expense category days
- `update_final_bill_amount_on_adjustment` - Recalculate bill amounts

**Synchronization:**
- `sync_user_roles_from_positions` - Sync roles when position changes
- `sync_requisition_balance` - Update balance on payment changes
- `sync_erp_reference` - Sync ERP invoice references

**Notifications:**
- `queue_push_notification_trigger` - Queue push notifications
- `create_quick_task_notification` - Notify on task creation
- `notify_expense_changes` - Alert on expense updates

**Audit & Logging:**
- `log_user_action` - Log all user actions (INSERT/UPDATE/DELETE on users table)
- `log_password_change` - Track password changes in history
- `track_access_code_changes` - Log customer access code updates

**Cleanup & Maintenance:**
- `cleanup_assignment_notifications` - Remove orphaned notification assignments
- `cleanup_task_notifications` - Clean up task-related notifications
- `delete_old_push_subscriptions` - Remove expired push subscriptions

**Tables with Most Triggers:**
- `expense_scheduler` - 8 triggers (scheduling, calculation, notification)
- `hr_employee_documents` - 6 triggers (status, workflow, validation)
- `employee_warnings` - 5 triggers (warning workflow, fine tracking)
- `users` - 5 triggers (audit, role sync, session management)

### Database Constraints:
**Note**: Constraint details should be checked directly in Supabase Dashboard or by inspecting individual tables.

**Utility Script**: Use `node check-table-structure.js [table_name]` to see column structure including:
- Primary keys (id columns with SERIAL/UUID types)
- Foreign key relationships (references to other tables)
- NOT NULL constraints (is_nullable field)
- Default values and data types

**Common Constraint Patterns:**
- **Primary Keys**: All tables have `id` as primary key (SERIAL or UUID)
- **Foreign Keys**: Consistent naming (`table_id` references `table.id`)
- **Timestamps**: `created_at` and `updated_at` with NOT NULL constraints
- **Branch Relations**: Most operational tables link to `branches.id`
- **User Relations**: Activity tables link to `users.id` for audit trails
- **Status Fields**: Use CHECK constraints for valid status values
- **Unique Constraints**: Applied to business identifiers (employee_id, erp_reference, etc.)

**Referential Integrity Examples:**
- `hr_employees.branch_id` â†’ `branches.id`
- `tasks.assigned_to` â†’ `users.id`
- `receiving_records.vendor_id` â†’ `vendors.id`
- `notifications.created_by` â†’ `users.id`
- `expense_requisitions.employee_id` â†’ `hr_employees.id`

### File Structure:
```
Aqura/
â”œâ”€â”€ frontend/               # SvelteKit PWA frontend
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”‚   â”œâ”€â”€ components/    # Reusable UI components
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ admin/     # Admin components (tasks, vendor, receiving, etc.)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ customer/  # Customer-facing components
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ shared/    # Shared components (buttons, modals, etc.)
â”‚   â”‚   â”‚   â”œâ”€â”€ stores/        # Svelte stores for state management
â”‚   â”‚   â”‚   â”œâ”€â”€ utils/         # Utility functions and helpers
â”‚   â”‚   â”‚   â”œâ”€â”€ types/         # TypeScript type definitions
â”‚   â”‚   â”‚   â””â”€â”€ i18n/          # Custom bilingual system (Arabic/English)
â”‚   â”‚   â”œâ”€â”€ routes/            # SvelteKit file-based routing
â”‚   â”‚   â”‚   â”œâ”€â”€ api/           # API endpoints (+server.js files)
â”‚   â”‚   â”‚   â”œâ”€â”€ mobile/        # Mobile-optimized interface
â”‚   â”‚   â”‚   â””â”€â”€ +page.svelte   # Desktop windowed interface
â”‚   â”‚   â”œâ”€â”€ app.html           # HTML template
â”‚   â”‚   â””â”€â”€ app.css            # Global styles
â”‚   â”œâ”€â”€ static/                # Static assets (icons, sounds, manifest)
â”‚   â””â”€â”€ package.json           # Frontend dependencies
â”œâ”€â”€ supabase/                  # Supabase backend configuration
â”‚   â”œâ”€â”€ functions/             # Edge functions (push notifications, etc.)
â”‚   â”œâ”€â”€ migrations/            # Database migrations (SQL files removed)
â”‚   â””â”€â”€ config.toml            # Supabase configuration
â”œâ”€â”€ scripts/                   # Utility scripts
â”‚   â””â”€â”€ update-version.js      # Version management script
â”œâ”€â”€ build/                     # Production build output
â”œâ”€â”€ package.json               # Root workspace configuration
â””â”€â”€ pnpm-workspace.yaml        # pnpm monorepo configuration
```

### Important Conventions:
- **Database Schema**: ALWAYS check original schema, functions, triggers, constraints in Supabase using service role key before making changes
- **Service Role Key**: Use `SUPABASE_SERVICE_ROLE_KEY` from `.env` for direct database inspection
- **Schema Verification**: Never assume schema structure - query Supabase directly to verify
- **Commits**: Use conventional commits (`feat:`, `fix:`, `docs:`, `perf:`, etc.)
- **Branches**: Work on `master` branch (single developer workflow)
- **Imports**: Use `$lib` alias for library imports
- **Styling**: TailwindCSS with custom design system
- **State**: Use Svelte stores for global state management
- **API**: Use Supabase client for data operations with RLS policies
- **Routes**: SvelteKit file-based routing with `+page.svelte` and `+server.js`
- **Performance**: Batch database queries, use reactive updates instead of full reloads
- **UX**: Smooth transitions, optimistic UI updates, proper loading states

### Recent Optimizations:
- **NotificationCenter**: Batch loading for task attachments (single query vs sequential)
- **MyTasksView**: Smooth task removal without full page reload
- **Receiving Tasks**: Auto-flag upload states in API endpoints
- **Database**: Fixed upload flag inconsistencies for receiving records

Remember: Always maintain backward compatibility and provide migration paths for breaking changes!