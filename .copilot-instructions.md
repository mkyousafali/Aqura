# GitHub Copilot Instructions for Aqura Management System

## ğŸš€ Project Overview

**Aqura** is a PWA-first windowed management platform for Saudi businesses with custom authentication.

### Current Status (December 2025)
- **Version**: AQ (4-part version system)
- **Phase**: Production Ready
- **Focus**: Multi-interface desktop/mobile/customer/cashier management system
- **Database**: Supabase PostgreSQL with 88 tables + universal RLS policies

### Architecture
- **Frontend**: SvelteKit + TypeScript + TailwindCSS + Vite PWA
- **Backend**: Supabase PostgreSQL (RLS-enabled, 88 tables)
- **Authentication**: Custom `persistentAuth` system (NOT Supabase Auth)
- **Deployment**: Vercel (Frontend) + Supabase (Database)
- **Security**: Universal permissive RLS policies + application-level authorization

## ğŸ—ï¸ Project Structure

```
Aqura/
â”œâ”€â”€ frontend/                      # SvelteKit PWA application
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”‚   â”œâ”€â”€ components/       # UI components (interface-based organization)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ common/       # Shared components (all interfaces)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ desktop-interface/   # Desktop admin interface
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ mobile-interface/    # Mobile employee app
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ customer-interface/  # Customer shopping app
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ cashier-interface/   # Cashier/POS interface
â”‚   â”‚   â”‚   â”œâ”€â”€ stores/           # Svelte stores (state management)
â”‚   â”‚   â”‚   â”œâ”€â”€ utils/            # Utility functions
â”‚   â”‚   â”‚   â”œâ”€â”€ types/            # TypeScript definitions
â”‚   â”‚   â”‚   â””â”€â”€ i18n/             # Bilingual system (Arabic/English)
â”‚   â”‚   â”œâ”€â”€ routes/               # SvelteKit file-based routing
â”‚   â”‚   â”‚   â”œâ”€â”€ login/            # Main interface selector
â”‚   â”‚   â”‚   â”œâ”€â”€ desktop-interface/
â”‚   â”‚   â”‚   â”œâ”€â”€ mobile-interface/
â”‚   â”‚   â”‚   â”œâ”€â”€ customer-interface/
â”‚   â”‚   â”‚   â””â”€â”€ cashier-interface/
â”‚   â”‚   â”œâ”€â”€ app.html              # HTML template
â”‚   â”‚   â””â”€â”€ app.css               # Global styles
â”‚   â”œâ”€â”€ static/                   # Static assets
â”‚   â”‚   â”œâ”€â”€ sw.js                 # Service worker (PWA)
â”‚   â”‚   â”œâ”€â”€ manifest.webmanifest  # PWA manifest
â”‚   â”‚   â””â”€â”€ icons/                # App icons
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ supabase/                      # Supabase configuration
â”‚   â”œâ”€â”€ functions/                # Edge functions
â”‚   â””â”€â”€ config.toml               # Supabase config
â”œâ”€â”€ migrations/                    # [EMPTY - migrations in Supabase only]
â”œâ”€â”€ scripts/                       # Build and utility scripts
â”‚   â””â”€â”€ copy-flyer-images.js      # Build-time image copy
â”œâ”€â”€ README.md                      # Project documentation
â””â”€â”€ package.json                   # Root workspace configuration
```

## ğŸ” Security & RLS Status

### âœ… COMPLETED: Universal RLS Implementation
- **All 88 tables**: RLS enabled with 4 universal policies each
- **Storage buckets**: RLS enabled with 4 universal policies
- **Policies**: `allow_select`, `allow_insert`, `allow_update`, `allow_delete` (all using `USING (true)` and `WITH CHECK (true)`)
- **Authorization**: Handled at application level (custom auth system)
- **Total policies**: 352 table policies + 4 storage policies = 356 total

### âœ… COMPLETED: Security Fixes
- Removed all hardcoded API keys from source code
- Service worker uses environment variables for Supabase anon key
- All sensitive credentials in `.env` only (gitignored)
- PostgreSQL role permissions properly configured

## ğŸ”‘ Environment Variables

Required in `frontend/.env`:
```
VITE_SUPABASE_URL=https://supabase.urbanaqura.com
VITE_SUPABASE_ANON_KEY=eyJ...              # Public anon key (safe to expose)
VITE_SUPABASE_SERVICE_KEY=eyJ...           # Service role (backend only, NOT in frontend)
VITE_GOOGLE_MAPS_API_KEY=AIza...
VITE_OPENAI_API_KEY=sk-proj-...
VITE_VAPID_PUBLIC_KEY=BExw...
VAPID_PRIVATE_KEY=hCYj...
VITE_GO_API_URL=http://localhost:8080      # Optional - for Go backend testing
VITE_USE_GO_BACKEND=false
VITE_PWA_ENABLED=true
VITE_PUSH_NOTIFICATIONS_ENABLED=true
```

## ğŸ‘¥ User Entity Types (CRITICAL - DO NOT CONFUSE)

**Three distinct entity types serve different purposes:**

1. **USERS** (`users` table - UUID id)
   - Admin/Manager staff operating the desktop admin interface
   - Supabase Auth with role-based permissions
   - Can create offers, tasks, manage business operations
   - Example: `offers.created_by` â†’ User ID

2. **EMPLOYEES** (`hr_employees` table - UUID id)
   - Company staff tracked in HR system
   - Managed by admins (not direct system users)
   - Subject to payroll, attendance, positions
   - Example: `expense_requisitions.employee_id` â†’ Employee ID
   - **Note**: Employees MAY have user accounts if given admin access

3. **CUSTOMERS** (`customers` table - UUID id)
   - End users/shoppers using the mobile app
   - Separate authentication system (access codes)
   - Can browse products, place orders, use offers
   - Example: `offer_usage_logs.customer_id` â†’ Customer ID

## ğŸ—„ï¸ Database Overview

### Total Tables: 88
Organized by category:
- **User & Auth** (8 tables)
- **HR Management** (11 tables)
- **Task Management** (13 tables)
- **Receiving & Vendor** (3 tables)
- **Notifications** (6 tables)
- **Finance & Expenses** (8 tables)
- **Customer Management** (6 tables)
- **Product Management** (4 tables)
- **Offer System** (6 tables - normalized structure)
- **System & Configuration** (4 tables)

### Key Points
- âœ… All tables have RLS enabled
- âœ… All tables have universal permissive policies
- âœ… Authorization is handled at application level (custom auth)
- âœ… No hardcoded secrets in database
- âœ… Triggers and functions working correctly

## ğŸ”„ Authentication System

### Custom `persistentAuth` (NOT Supabase Auth)
```javascript
// Usage in components
import { currentUser } from '$lib/stores/persistentAuth';

// Check if user is logged in
if ($currentUser) {
  // User authenticated
  const userId = $currentUser.id;
  const userRole = $currentUser.role;
}
```

### Key Features
- Sessions stored in localStorage
- No Supabase Auth dependency
- Custom login/logout flows
- Application-level authorization
- RLS policies are defense-in-depth only

## ğŸ¨ Component Organization Rules

**CRITICAL: Interface-based organization**
- âœ… `common/` - Shared across ALL interfaces
- âœ… `desktop-interface/` - Desktop admin ONLY
- âœ… `mobile-interface/` - Mobile employee app ONLY
- âœ… `customer-interface/` - Customer shopping app ONLY
- âœ… `cashier-interface/` - Cashier/POS ONLY
- âŒ NEVER mix components from different interfaces
- âŒ NEVER use `admin/`, `mobile/`, `customer/` folders

## ğŸŒ Internationalization

### Bilingual System (Arabic/English)
- Custom i18n implementation (not auto-translate)
- Files: `frontend/src/lib/i18n/locales/en.ts` and `ar.ts`
- **CRITICAL**: Both files must have identical key structures

### Usage
```typescript
import { t, isRTL } from '$lib/i18n';

// In components
<h1>{t('key.path')}</h1>  // âœ… CORRECT - function call
<h1>{$t('key.path')}</h1> // âŒ WRONG - not a store!
```

### When Adding UI Elements
- âœ… Add translation key to BOTH en.ts AND ar.ts
- âœ… Use identical key names in both files
- âœ… Test in both English and Arabic modes
- âŒ Never add to just one language file

## ğŸ” Svelte Reactivity Pattern (CRITICAL)

**Svelte detects changes through OBJECT REFERENCE CHANGES, not mutations.**

### Problem Pattern (BUG)
```typescript
// âŒ WRONG - Direct mutation, Svelte won't detect change
store.update(value => {
  value.property = newValue;  // Mutation!
  return value;               // Same reference
});
```

### Solution Pattern (CORRECT)
```typescript
// âœ… CORRECT - New object reference
store.update(value => {
  const newMap = new Map(value);           // NEW MAP
  const item = newMap.get('id');
  newMap.set('id', { ...item, prop: val }); // NEW OBJECT
  return newMap;                            // NEW REFERENCE
});
```

## â° Saudi Arabia Timezone Handling

**CRITICAL: Saudi Arabia uses UTC+3 timezone**

### For datetime-local inputs
```typescript
// Convert UTC â†’ Saudi time for display
function toSaudiTimeInput(utcDateString: string) {
  const date = new Date(utcDateString);
  const saudiTime = new Date(date.toLocaleString('en-US', { timeZone: 'Asia/Riyadh' }));
  // Format for datetime-local input
  return `${year}-${month}-${day}T${hours}:${minutes}`;
}

// Convert Saudi time â†’ UTC for database storage
function toUTCFromSaudiInput(saudiTimeString: string) {
  const saudiDate = new Date(parts);
  const utcDate = new Date(saudiDate.getTime() - (3 * 60 * 60 * 1000));
  return utcDate.toISOString();
}
```

### When to Use
- âœ… ALWAYS for datetime-local form inputs
- âœ… ALWAYS for offer start/end dates
- âœ… ALWAYS for task due dates
- âœ… ALWAYS when saving/loading timestamps

## ğŸ› ï¸ Development Workflow

### Start Development Servers
```bash
# Terminal 1: Frontend
cd frontend
npm run dev

# Terminal 2: Backend (optional - Go API)
cd backend
go run main.go
```

### Available Tasks
- `npm run build` - Build all packages
- `npm run dev` - Start dev server
- `npm run lint` - Lint all code
- `npm run test` - Run tests

### Git Workflow
```bash
git add -A
git commit -m "feat: description"  # Use conventional commits
git push origin master
```

## âš ï¸ Important Rules

### Before Making ANY Changes
1. âœ… Analyze the request thoroughly
2. âœ… Check existing implementation
3. âœ… Identify potential impacts
4. âœ… Present a clear plan
5. âœ… WAIT for user confirmation

### Code Quality Checks
1. **Syntax Errors**: Use `get_errors` tool after editing
2. **Import Verification**: Always verify imports exist
3. **Method Calls**: Verify methods exist on imported objects
4. **Svelte Reactivity**: Use spread operators and new references
5. **Translations**: Update BOTH en.ts AND ar.ts files
6. **Timezone**: Convert datetime values for Saudi Arabia (UTC+3)

### Common Mistakes to AVOID
- âŒ Direct mutations in Svelte stores (use spread operators)
- âŒ Hardcoded API keys in code (use .env)
- âŒ Assuming imports without verification (search first)
- âŒ Missing translations in one language
- âŒ Forgetting timezone conversion for datetime inputs
- âŒ Mixing components from different interfaces
- âŒ Using Supabase Auth (use persistentAuth instead)

## ğŸ“‹ Code Quality Standards

### TypeScript
- Use strict typing for domain logic
- Balance with pragmatic relaxation for UI code
- Always define function return types

### Components
- Keep components focused and modular
- Use Svelte stores for global state
- Implement proper error handling
- Add loading states for async operations

### Accessibility
- Use semantic HTML
- Add ARIA labels
- Support keyboard navigation
- Test with screen readers

### Performance
- Batch database queries
- Use reactive updates instead of full reloads
- Cache frequently accessed data
- Optimize images and assets

## ğŸš€ Deployment

### Frontend
- Deployed on **Vercel**
- Automatic deployment on `master` push
- PWA available at production URL

### Database
- Hosted on **Supabase**
- PostgreSQL with RLS enabled
- Real-time subscriptions available
- Automatic backups enabled

## ğŸ“ Support & Documentation

### Key Files
- `README.md` - Project overview
- `frontend/.env` - Environment configuration
- `frontend/src/lib/i18n/` - Translation files
- `supabase/config.toml` - Database config

### Debugging
- Check browser console for errors
- Check Supabase logs for database errors
- Use `get_errors` tool to verify syntax
- Check RLS policies for permission issues

---

**Last Updated**: December 7, 2025
**Status**: Production Ready âœ…
**All cleanups completed** - Test files, migrations, and debug scripts removed
