<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circuit Breaker Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        h1 {
            color: #00d4ff;
            text-align: center;
        }
        .test-section {
            background: #16213e;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #00d4ff;
        }
        .test-section h2 {
            color: #00d4ff;
            margin-top: 0;
        }
        button {
            background: #00d4ff;
            color: #1a1a2e;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s;
        }
        button:hover {
            background: #00a8cc;
            transform: translateY(-2px);
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }
        #log {
            background: #0f0f1e;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 15px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        .log-success { color: #4ade80; }
        .log-error { color: #f87171; background: rgba(248, 113, 113, 0.1); }
        .log-warning { color: #fbbf24; }
        .log-info { color: #60a5fa; }
        .log-circuit { color: #a855f7; background: rgba(168, 85, 247, 0.1); font-weight: bold; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #0f0f1e;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #00d4ff;
        }
        .stat-label {
            color: #999;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>üîí Circuit Breaker & Rate Limiting Test</h1>
    
    <div class="stats">
        <div class="stat-card">
            <div class="stat-value" id="attemptCount">0</div>
            <div class="stat-label">Attempts</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="failureCount">0</div>
            <div class="stat-label">Failures</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="blockedCount">0</div>
            <div class="stat-label">Blocked</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="circuitStatus">CLOSED</div>
            <div class="stat-label">Circuit Status</div>
        </div>
    </div>

    <div class="test-section">
        <h2>üìã Test Scenarios</h2>
        <button onclick="testSingleAttempt()">1Ô∏è‚É£ Single Attempt</button>
        <button onclick="testRapidRetries()">‚ö° Rapid Retries (5 quick)</button>
        <button onclick="testCircuitBreaker()">üö´ Trigger Circuit Breaker</button>
        <button onclick="testRateLimit()">‚è±Ô∏è Test Rate Limit</button>
        <button onclick="clearLog()">üßπ Clear Log</button>
        <button onclick="resetCircuit()">üîÑ Reset Circuit</button>
    </div>

    <div class="test-section">
        <h2>üìä Activity Log</h2>
        <div id="log"></div>
    </div>

    <script>
        // Simulate the circuit breaker from pushNotifications.ts
        class CircuitBreakerSimulator {
            constructor() {
                this.deviceRegistrationFailures = 0;
                this.maxConsecutiveFailures = 5;
                this.isCircuitBreakerOpen = false;
                this.circuitBreakerResetTime = 0;
                this.circuitBreakerTimeout = 30000; // 30 seconds for testing (5 min in production)
                
                this.lastRegistrationAttempt = 0;
                this.minTimeBetweenRetries = 3000; // 3 seconds for testing (10s in production)
                
                this.totalAttempts = 0;
                this.totalBlocked = 0;
            }

            async registerDevice() {
                this.totalAttempts++;
                updateStats();

                // Circuit breaker check
                if (this.isCircuitBreakerOpen) {
                    const now = Date.now();
                    if (now < this.circuitBreakerResetTime) {
                        const waitTime = Math.ceil((this.circuitBreakerResetTime - now) / 1000);
                        log(`üö´ Circuit breaker is OPEN. Request blocked for ${waitTime} more seconds.`, 'circuit');
                        this.totalBlocked++;
                        updateStats();
                        return { blocked: true, reason: 'circuit_breaker' };
                    } else {
                        log('üîÑ Circuit breaker timeout expired. Resetting...', 'success');
                        this.isCircuitBreakerOpen = false;
                        this.deviceRegistrationFailures = 0;
                        updateStats();
                    }
                }

                // Rate limiting check
                const now = Date.now();
                const timeSinceLastAttempt = now - this.lastRegistrationAttempt;
                if (timeSinceLastAttempt < this.minTimeBetweenRetries && this.lastRegistrationAttempt > 0) {
                    const waitTime = Math.ceil((this.minTimeBetweenRetries - timeSinceLastAttempt) / 1000);
                    log(`‚è±Ô∏è Rate limit: Wait ${waitTime}s before retrying.`, 'warning');
                    this.totalBlocked++;
                    updateStats();
                    return { blocked: true, reason: 'rate_limit' };
                }

                this.lastRegistrationAttempt = now;

                // Simulate API call that always fails (simulating Supabase 556 error)
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Simulate failure
                this.deviceRegistrationFailures++;
                log(`‚ùå Registration failed (${this.deviceRegistrationFailures}/${this.maxConsecutiveFailures})`, 'error');
                updateStats();

                // Check if circuit breaker should open
                if (this.deviceRegistrationFailures >= this.maxConsecutiveFailures) {
                    this.isCircuitBreakerOpen = true;
                    this.circuitBreakerResetTime = Date.now() + this.circuitBreakerTimeout;
                    log(
                        `üö´ CIRCUIT BREAKER OPENED! Too many failures (${this.deviceRegistrationFailures}). ` +
                        `Blocked for ${this.circuitBreakerTimeout / 1000} seconds.`,
                        'circuit'
                    );
                    updateStats();
                }

                return { success: false, error: 'Simulated failure' };
            }

            reset() {
                this.deviceRegistrationFailures = 0;
                this.isCircuitBreakerOpen = false;
                this.circuitBreakerResetTime = 0;
                this.lastRegistrationAttempt = 0;
                this.totalAttempts = 0;
                this.totalBlocked = 0;
                log('üîÑ Circuit breaker manually reset', 'success');
                updateStats();
            }
        }

        const simulator = new CircuitBreakerSimulator();

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.insertBefore(entry, logDiv.firstChild);
        }

        function updateStats() {
            document.getElementById('attemptCount').textContent = simulator.totalAttempts;
            document.getElementById('failureCount').textContent = simulator.deviceRegistrationFailures;
            document.getElementById('blockedCount').textContent = simulator.totalBlocked;
            document.getElementById('circuitStatus').textContent = simulator.isCircuitBreakerOpen ? 'OPEN üö´' : 'CLOSED ‚úÖ';
            document.getElementById('circuitStatus').style.color = simulator.isCircuitBreakerOpen ? '#f87171' : '#4ade80';
        }

        async function testSingleAttempt() {
            log('üß™ Testing single registration attempt...', 'info');
            await simulator.registerDevice();
        }

        async function testRapidRetries() {
            log('üß™ Testing 5 rapid retries (should hit rate limit)...', 'info');
            for (let i = 0; i < 5; i++) {
                await simulator.registerDevice();
                await new Promise(resolve => setTimeout(resolve, 500)); // 500ms between attempts
            }
        }

        async function testCircuitBreaker() {
            log('üß™ Testing circuit breaker (triggering 5 consecutive failures)...', 'info');
            for (let i = 0; i < 7; i++) {
                await simulator.registerDevice();
                await new Promise(resolve => setTimeout(resolve, 3500)); // Wait 3.5s to avoid rate limit
            }
        }

        async function testRateLimit() {
            log('üß™ Testing rate limit (3 attempts with 1s gap)...', 'info');
            for (let i = 0; i < 3; i++) {
                await simulator.registerDevice();
                await new Promise(resolve => setTimeout(resolve, 1000)); // 1s between attempts
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('Log cleared', 'info');
        }

        function resetCircuit() {
            simulator.reset();
        }

        // Initial log entry
        log('üöÄ Circuit Breaker Test Page Loaded', 'success');
        log('üí° Run tests to see how circuit breaker and rate limiting work', 'info');
        updateStats();
    </script>
</body>
</html>
