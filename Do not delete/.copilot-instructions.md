# GitHub Copilot Instructions for Aqura Management System

## üîÑ Version Management Protocol (AQ Format: AQ[Desktop].[Mobile].[Cashier].[Customer])

**CRITICAL: Use the automated simple-push.js script for version updates and git push operations.**

### Version Format: AQ1.1.1.1

The Aqura system uses a 4-part version number format:

```
AQ[Desktop].[Mobile].[Cashier].[Customer]
  ‚îî‚îÄ 1st     ‚îî‚îÄ 2nd    ‚îî‚îÄ 3rd    ‚îî‚îÄ 4th
```

**Each number represents the version of that specific interface:**
- **Desktop (1st)**: Admin/Manager interface - `AQ{1}.1.1.1`
- **Mobile (2nd)**: Employee mobile app - `AQ1.{1}.1.1`
- **Cashier (3rd)**: POS/Coupon redemption - `AQ1.1.{1}.1`
- **Customer (4th)**: Customer shopping app - `AQ1.1.1.{1}`

### Automated Git Push with Version Update

**Script Location:** `Do not delete/simple-push.js`

**Usage:**
```powershell
# Basic usage (defaults to desktop interface)
node "Do not delete/simple-push.js" desktop

# Specify interface
node "Do not delete/simple-push.js" mobile
node "Do not delete/simple-push.js" cashier
node "Do not delete/simple-push.js" customer
node "Do not delete/simple-push.js" all

# With custom commit message
node "Do not delete/simple-push.js" desktop "feat(desktop): add new HR feature"
```

**What the script does automatically:**
1. ‚úÖ Checks git status for changes
2. ‚úÖ Increments the appropriate interface version (AQ16.2.2.2 ‚Üí AQ17.2.2.2)
3. ‚úÖ Updates `package.json` (root and frontend)
4. ‚úÖ Updates version display in `Sidebar.svelte`
5. ‚úÖ Generates fresh `VersionChangelog.svelte` with:
   - Proper version format display
   - Commit type emoji and label (feat, fix, chore, etc.)
   - Interface breakdown (Desktop, Mobile, Cashier, Customer)
   - Current date
6. ‚úÖ Stages all changes (`git add -A`)
7. ‚úÖ Creates commit with proper message format
8. ‚úÖ Pushes to origin/master

**Then manually push:**
```powershell
git add -A
git commit -m "chore(desktop): bump version to AQ17.2.2.2"
git push
```

### Version Update Guidelines by Change Type:

**When to increment each interface:**

- **Desktop**: HR module changes, task system updates, window management, sidebar features, master data management
- **Mobile**: Employee app features, notification system, mobile task management, punch card updates
- **Cashier**: POS system changes, coupon redemption logic, cashier-specific features
- **Customer**: Shopping app features, offer system, product browsing, order management

**Increment amount (always +1 via script):**
- Small features, bug fixes, minor improvements
- Multiple related features
- Major new features

### Files Updated Automatically:

- `package.json` (root) - Project version in AQ format
- `frontend/package.json` - Frontend project version in AQ format
- `frontend/src/lib/components/desktop-interface/common/Sidebar.svelte` - Version number in footer
- `frontend/src/lib/components/desktop-interface/common/VersionChangelog.svelte` - Complete changelog UI

### Examples:

**Example 1: Push desktop changes**
```powershell
node "Do not delete/simple-push.js" desktop
# Then review and push manually
git push
```

**Example 2: Push mobile changes with custom message**
```powershell
node "Do not delete/simple-push.js" mobile "feat(mobile): add biometric sync"
git push
```

**Example 3: Push changes affecting all interfaces**
```powershell
node "Do not delete/simple-push.js" all
git push
```

### Commit Message Format:

The script automatically generates proper commit messages:
```
chore(desktop): bump version to AQ17.2.2.2
chore(mobile): bump version to AQ16.3.2.2
chore(cashier): bump version to AQ16.2.3.2
chore(customer): bump version to AQ16.2.2.3
chore(all): bump version to AQ17.3.3.3
```

### Copilot Workflow Checklist:

Before every `git push`:
- [ ] Run `node "Do not delete/simple-push.js" [interface]`
- [ ] Script automatically updates all version files
- [ ] Script generates VersionChangelog.svelte
- [ ] Review git status and staged changes
- [ ] Run `git push` to push to remote

### VersionChangelog.svelte Auto-Generation:

The script automatically creates a fresh `VersionChangelog.svelte` file with:

**Features:**
- Version number display (AQ16.2.2.2)
- Interface breakdown (Desktop: 16 | Mobile: 2 | Cashier: 2 | Customer: 2)
- Commit type detection with emojis:
  - ‚ú® feat ‚Üí New Feature
  - üêõ fix ‚Üí Bug Fix
  - ‚ö° perf ‚Üí Performance
  - ‚ôªÔ∏è refactor ‚Üí Refactor
  - üìù docs ‚Üí Documentation
  - üíÑ style ‚Üí Style
  - üß™ test ‚Üí Test
  - üîß chore ‚Üí Maintenance
- Current date (e.g., "December 1, 2025")
- Interface information cards for all 4 interfaces

### Integration Points:

The version number appears in:
1. **Desktop Sidebar Footer**: Shows version as "AQ16.2.2.2" with clickable popup
2. **Version Changelog Window**: Opens when clicking version in sidebar
3. **Package Metadata**: Used for builds and deployments
4. **Git History**: Each version bump includes interface information

### Error Handling:

If script fails:
1. Check if `package.json` files exist and have valid JSON
2. Verify `Sidebar.svelte` path is correct
3. Ensure no merge conflicts in target files
4. Check git repository is initialized
5. Verify write permissions for all files

---

## ‚ö†Ô∏è Important: Always Confirm Before Making Changes

**CRITICAL RULE: NEVER assume or make changes without explicit confirmation from the user.**

### Before Making ANY Changes:
1. **Analyze the request thoroughly** - Understand what the user is asking for
2. **Check existing implementation** - Review current code, database schema, and structure
3. **Identify potential impacts** - Consider what will be affected by the change
4. **Present a clear plan** - Explain what you will change and why
5. **WAIT for user confirmation** - Do not proceed until the user explicitly approves

### What Requires Confirmation:
- ‚úã **Database changes** (schema, functions, triggers, RLS policies)
- ‚úã **File creation/deletion** (new components, utilities, routes)
- ‚úã **Code modifications** (logic changes, refactoring, optimizations)
- ‚úã **Configuration updates** (package.json, vite.config, tailwind.config)
- ‚úã **Architectural decisions** (new patterns, state management, API structure)
- ‚úã **Version updates** (dependencies, framework versions)
- ‚úã **Build/deployment changes** (build scripts, deployment config)

### Code Quality Checks:

**CRITICAL: After making ANY code edits, ALWAYS verify correctness.**

#### 1. Translation Update Protocol:

**CRITICAL: When adding ANY new UI elements (buttons, labels, menus, messages), ALWAYS update translations.**

1. **Files to Update**:
   - ‚úÖ `frontend/src/lib/i18n/locales/en.ts` - English translations
   - ‚úÖ `frontend/src/lib/i18n/locales/ar.ts` - Arabic translations (RTL)

2. **When Translation is Required**:
   - ‚úÖ New sidebar menu items or buttons
   - ‚úÖ New window titles or component labels
   - ‚úÖ User-facing messages (success, error, warnings)
   - ‚úÖ Form labels, placeholders, and validation messages
   - ‚úÖ Modal dialogs and confirmation messages
   - ‚úÖ Status indicators and tooltips
   - ‚úÖ Navigation items and breadcrumbs

3. **Translation Best Practices**:
   - Add translations in **both** English and Arabic files
   - Use descriptive keys that match the feature context
   - Keep translations concise and user-friendly
   - Use proper Arabic grammar and cultural context
   - Add comments to organize translation sections

4. **Example Translation Addition**:
   ```typescript
   // English (en.ts)
   reports: {
     expenseTracker: "Expense Tracker",
     salesReport: "Sales Report",  // ‚Üê Add new translation
   },
   
   // Arabic (ar.ts)
   reports: {
     expenseTracker: "ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖÿµÿ±ŸàŸÅÿßÿ™",
     salesReport: "ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™",  // ‚Üê Add new translation
   },
   ```

5. **Verification Checklist**:
   - [ ] Translation added to `en.ts` file
   - [ ] Translation added to `ar.ts` file
   - [ ] Translation key matches usage in component
   - [ ] Arabic translation is culturally appropriate
   - [ ] No syntax errors in locale files
   - [ ] Test UI in both English and Arabic modes

#### 2. Syntax Error Prevention Protocol:
1. **After every `replace_string_in_file` operation** - Check for:
   - ‚úÖ Matching opening and closing brackets `{}`, `[]`, `()`
   - ‚úÖ Proper closing of functions, objects, and arrays
   - ‚úÖ No duplicate closing statements (e.g., `}));` appearing twice)
   - ‚úÖ Correct template literal syntax in Svelte components
   - ‚úÖ Proper JSX/Svelte syntax (no unclosed tags)
   
2. **Use `get_errors` tool immediately after editing** - Verify no compile errors:
   ```
   Use get_errors tool to check the edited file for syntax/compile errors
   ```

3. **Common Syntax Pitfalls to Avoid**:
   - ‚ùå Duplicate closing brackets when copy-pasting code
   - ‚ùå Missing commas in object/array literals
   - ‚ùå Unclosed template literals or strings
   - ‚ùå Missing semicolons in statement termination (where required)
   - ‚ùå Incorrect arrow function syntax `() => {}`
   - ‚ùå Mismatched JSX/Svelte tag closures

4. **If Syntax Error Detected**:
   - Immediately fix the error before proceeding
   - Re-verify with `get_errors` tool
   - Inform user of the fix made

5. **Best Practice**:
   - Read surrounding context before editing (3-5 lines before/after)
   - Count brackets in your replacement strings
   - Preview the full logical block being modified
   - Test compile after each significant change

#### 3. Import Error Prevention Protocol:

**CRITICAL: NEVER assume import paths or module names. ALWAYS verify before adding imports.**

1. **Before Adding ANY Import Statement**:
   - ‚úÖ Use `file_search` to find the actual file/module location
   - ‚úÖ Check existing imports in similar files
   - ‚úÖ Use `grep_search` to find how the module is imported elsewhere
   - ‚úÖ Verify the export name matches what you're importing
   
2. **Common Import Verification Steps**:
   ```bash
   # Find the store/module file
   file_search: **/*notification*.{ts,js,svelte}
   
   # Check how it's used in other files
   grep_search: "import.*notification" (isRegexp: true)
   
   # Read the actual file to see exports
   read_file: path/to/notification/file.ts
   ```

3. **Import Path Patterns in Aqura**:
   - ‚úÖ `$lib/stores/notifications` - Notification store (uses .add() method)
   - ‚úÖ `$lib/stores/windowManager` - Window management store
   - ‚úÖ `$lib/i18n` - Bilingual translation system
   - ‚úÖ `$lib/utils/supabase` - Supabase client utilities
   - ‚úÖ `$lib/components/*` - UI components
   - ‚ùå `$lib/stores/notificationStore` - DOES NOT EXIST
   - ‚ùå `$lib/utils/notifications` - WRONG PATH

4. **Common Import Mistakes to Avoid**:
   - ‚ùå Importing non-existent modules (e.g., `notificationStore`)
   - ‚ùå Using wrong import names (e.g., `showNotification` instead of `notifications`)
   - ‚ùå Mixing default and named imports incorrectly
   - ‚ùå Using relative paths instead of `$lib` alias
   - ‚ùå Assuming a utility exists without checking
   - ‚ùå Copy-pasting imports from other projects

5. **Verification Checklist Before Importing**:
   - [ ] File/module actually exists in codebase
   - [ ] Export name matches import statement
   - [ ] Import path is correct (use $lib alias)
   - [ ] Method names match the actual API
   - [ ] Dependencies are installed (check package.json)

6. **If Import Error Detected**:
   - Stop immediately - do NOT guess the correct path
   - Use `file_search` to locate the actual module
   - Use `grep_search` to find working examples
   - Read the actual file to verify exports
   - Update import with verified path and name
   - Test with `get_errors` tool

7. **Store/Module Usage Patterns**:
   ```javascript
   // ‚úÖ CORRECT - Notifications Store
   import { notifications } from '$lib/stores/notifications';
   notifications.add({ message: 'Success!', type: 'success' });
   
   // ‚úÖ CORRECT - Window Manager
   import { openWindow } from '$lib/stores/windowManager';
   openWindow('ComponentName', { props });
   
   // ‚úÖ CORRECT - i18n System
   import { t, isRTL } from '$lib/i18n';
   $t('key.path')
   
   // ‚úÖ CORRECT - Supabase
   import { supabaseAdmin } from '$lib/utils/supabase';
   const { data, error } = await supabaseAdmin.from('table').select();
   
   // ‚ùå WRONG - Non-existent modules
   import { showNotification } from '$lib/stores/notificationStore'; // DOES NOT EXIST
   import notifications from '$lib/utils/notifications'; // WRONG PATH
   ```

8. **Best Practice Workflow**:
   ```
   Step 1: Need to use functionality X
   Step 2: Search for existing usage: grep_search("import.*X", true)
   Step 3: Find the file: file_search("**/*X*.{ts,js}")
   Step 4: Read exports: read_file(found_path)
   Step 5: Copy exact import from working example
   Step 6: Verify with get_errors tool
   ```

#### 4. Method/API Error Prevention Protocol:

**CRITICAL: After importing a module, verify its actual API before using it.**

1. **Before Calling ANY Method**:
   - ‚úÖ Read the source file to see available methods
   - ‚úÖ Check method signatures (parameters, return types)
   - ‚úÖ Look for existing usage examples in codebase
   - ‚úÖ Verify method name spelling exactly

2. **Common API Verification Steps**:
   ```javascript
   // After importing notifications store, verify its API:
   // 1. Read the store file
   read_file: frontend/src/lib/stores/notifications.ts
   
   // 2. Look for method definitions:
   //    - add() method?
   //    - show() method?
   //    - notify() method?
   //    - What parameters does it accept?
   ```

3. **Method Call Patterns in Aqura**:
   - ‚úÖ `notifications.add({ message, type, duration })` - Add notification
   - ‚úÖ `openWindow('Component', { props })` - Open window
   - ‚úÖ `$t('translation.key')` - Get translation
   - ‚ùå `showNotification({ message })` - DOES NOT EXIST
   - ‚ùå `notifications.show()` - WRONG METHOD NAME

4. **Verification Checklist Before Method Calls**:
   - [ ] Method exists on the imported object
   - [ ] Method name is spelled correctly
   - [ ] Parameters match expected signature
   - [ ] Return value is handled correctly
   - [ ] Async/await used where needed

#### 5. Saudi Arabia Timezone Handling Protocol:

**CRITICAL: Saudi Arabia uses UTC+3 timezone. ALWAYS convert datetime inputs to/from UTC.**

1. **Datetime Input Fields (datetime-local)**:
   - Display dates in Saudi timezone (UTC+3) for user convenience
   - Convert to UTC before saving to database
   - Convert from UTC when loading from database
   
2. **Required Helper Functions**:
   ```javascript
   // Convert UTC to Saudi time for datetime-local input display
   function toSaudiTimeInput(utcDateString: string) {
     const date = new Date(utcDateString);
     const saudiTime = new Date(date.toLocaleString('en-US', { timeZone: 'Asia/Riyadh' }));
     const year = saudiTime.getFullYear();
     const month = String(saudiTime.getMonth() + 1).padStart(2, '0');
     const day = String(saudiTime.getDate()).padStart(2, '0');
     const hours = String(saudiTime.getHours()).padStart(2, '0');
     const minutes = String(saudiTime.getMinutes()).padStart(2, '0');
     return `${year}-${month}-${day}T${hours}:${minutes}`;
   }

   // Convert Saudi time from datetime-local input to UTC for database storage
   function toUTCFromSaudiInput(saudiTimeString: string) {
     const [datePart, timePart] = saudiTimeString.split('T');
     const [year, month, day] = datePart.split('-').map(Number);
     const [hours, minutes] = timePart.split(':').map(Number);
     
     // Create date in Saudi timezone (UTC+3)
     const saudiDate = new Date(year, month - 1, day, hours, minutes);
     
     // Convert to UTC by subtracting 3 hours
     const utcDate = new Date(saudiDate.getTime() - (3 * 60 * 60 * 1000));
     
     return utcDate.toISOString();
   }
   ```

3. **When Loading Data from Database**:
   ```javascript
   // ‚úÖ CORRECT - Convert UTC to Saudi time for display
   offerData = {
     name_ar: data.name_ar,
     start_date: toSaudiTimeInput(data.start_date),  // Convert to Saudi time
     end_date: toSaudiTimeInput(data.end_date)
   };
   ```

4. **When Saving Data to Database**:
   ```javascript
   // ‚úÖ CORRECT - Convert Saudi time to UTC for storage
   const offerPayload = {
     name_ar: offerData.name_ar,
     start_date: toUTCFromSaudiInput(offerData.start_date),  // Convert to UTC
     end_date: toUTCFromSaudiInput(offerData.end_date)
   };
   ```

5. **Common Timezone Mistakes to Avoid**:
   - ‚ùå Saving datetime-local value directly without UTC conversion
   - ‚ùå Displaying UTC time directly in datetime-local input
   - ‚ùå Forgetting that datetime-local is in local timezone (Saudi time)
   - ‚ùå Assuming server and client are in same timezone
   - ‚ùå Using `new Date()` without timezone consideration

6. **When to Use Timezone Conversion**:
   - ‚úÖ **ALWAYS** for datetime-local inputs in forms
   - ‚úÖ **ALWAYS** when saving/loading start_date, end_date, scheduled times
   - ‚úÖ **ALWAYS** for offer validity periods
   - ‚úÖ **ALWAYS** for task due dates
   - ‚úÖ **ALWAYS** for scheduled notifications

7. **Testing Timezone Correctness**:
   ```javascript
   // After saving, verify the stored UTC time is correct
   // Saudi time 9:00 PM (21:00) should be stored as 6:00 PM (18:00) UTC
   console.log('Input Saudi time:', saudiTimeString);  // 2025-11-12T21:00
   console.log('Stored UTC time:', utcISOString);      // 2025-11-12T18:00:00.000Z
   ```

8. **Impact of Incorrect Timezone Handling**:
   - ‚ùå Offers scheduled for wrong times (3 hours off)
   - ‚ùå Offers showing as "scheduled" when they should be "active"
   - ‚ùå Offers disappearing from lists due to status calculation errors
   - ‚ùå Tasks due at wrong times
   - ‚ùå Notifications sent at wrong times

#### 6. Svelte Reactivity Pattern Protocol:

**CRITICAL: Svelte reactivity requires NEW object references, not mutations. Direct mutations are invisible to Svelte.**

This issue caused window movement to fail silently - store updates appeared to work but Svelte never detected changes because objects were mutated instead of replaced.

**The Problem (BUG PATTERN):**
```typescript
// ‚ùå WRONG - Direct mutation - Svelte won't detect changes!
export const updateWindowPosition = (windowId: string, position: { x: number; y: number }) => {
  windows.update(store => {
    const window = store.get(windowId);
    window.position = position;  // ‚Üê MUTATION - Store doesn't see this change
    return store;  // ‚Üê Same object reference returned
  });
};

// Symptoms:
// - Console logs show update functions being called
// - DOM doesn't update even though you see "success" messages
// - Position/size changes are silently ignored
// - Reactive statements ($:) don't trigger
// - Derived stores don't recalculate
```

**The Solution (CORRECT PATTERN):**
```typescript
// ‚úÖ CORRECT - Create new objects with spread operator
export const updateWindowPosition = (windowId: string, position: { x: number; y: number }) => {
  windows.update(store => {
    const newWindows = new Map(store);  // ‚Üê Create new Map
    const window = newWindows.get(windowId);
    newWindows.set(windowId, { ...window, position });  // ‚Üê Spread creates new object
    return newWindows;  // ‚Üê Return new reference, Svelte detects this!
  });
};
```

**Why This Matters:**
- Svelte detects changes through **object reference changes**, not mutations
- A `new Map(oldMap)` creates a new reference (triggers reactivity)
- A `{ ...obj, property: value }` creates a new object (triggers reactivity)
- Returning the same Map reference means "no change" to Svelte, even if contents changed

**Common Svelte Store Patterns in Aqura:**

1. **Updating Writable Store with Object Map:**
```typescript
// ‚ùå WRONG
store.update(value => {
  value.get('id').someProperty = newValue;
  return value;
});

// ‚úÖ CORRECT
store.update(value => {
  const newMap = new Map(value);
  const item = newMap.get('id');
  newMap.set('id', { ...item, someProperty: newValue });
  return newMap;
});
```

2. **Window Manager Update Pattern (Actual Aqura Code):**
```typescript
// ‚ùå WRONG - What was broken before fix
export const updateWindowPosition = (windowId: string, position: Position) => {
  windows.update(store => {
    const window = store.get(windowId);
    window.position = position;  // MUTATION!
    return store;  // Same reference
  });
};

// ‚úÖ CORRECT - How it's fixed now
export const updateWindowPosition = (windowId: string, position: Position) => {
  windows.update(store => {
    const newWindows = new Map(store);  // NEW MAP
    const window = newWindows.get(windowId);
    newWindows.set(windowId, { ...window, position });  // NEW OBJECT + NEW MAP
    return newWindows;  // NEW REFERENCE
  });
};
```

3. **Updating Nested State in Stores:**
```typescript
// ‚ùå WRONG - Won't trigger reactivity
export const updateConfig = (config: Config) => {
  appConfig.update(value => {
    value.settings.theme = 'dark';  // Direct mutation
    return value;  // Same reference
  });
};

// ‚úÖ CORRECT - Creates new nested objects
export const updateConfig = (config: Config) => {
  appConfig.update(value => ({
    ...value,
    settings: {
      ...value.settings,
      theme: 'dark'
    }
  }));
};
```

**Verification Checklist When Updating Stores:**
- [ ] Are you creating a NEW Map/object or mutating the existing one?
- [ ] Are you using `...spread` operator for nested updates?
- [ ] Are you returning a different object reference than what you received?
- [ ] Will Svelte see a reference change (not just property change)?
- [ ] Test: Does a reactive statement ($: newProp = storeProp) trigger when you update?
- [ ] Test: Do console logs show the new values after update?

**Common Mutations to Avoid:**
- ‚ùå `store.property = value` - Direct assignment, returns same reference
- ‚ùå `array.push(item)` - Mutates array, same reference
- ‚ùå `map.set(key, value)` - If not wrapping in new Map(), doesn't trigger reactivity
- ‚ùå `object.nested.property = value` - Deep mutation, same root reference
- ‚ùå Reassigning array element: `array[0] = newValue` - Same reference

**Common Correct Patterns:**
- ‚úÖ `new Map(oldMap)` - Creates new Map reference
- ‚úÖ `{ ...object, property: value }` - Creates new object reference
- ‚úÖ `[...array]` or `array.filter()` - Creates new array reference
- ‚úÖ Spread operator for nested: `{ ...obj, nested: { ...obj.nested, prop: val } }`
- ‚úÖ Array methods that return new arrays: `map()`, `filter()`, `concat()`, `slice()`

**Real-World Example from Bug Fix:**
```typescript
// BEFORE (Bug) - Windows wouldn't move
const activateWindow = (windowId: string) => {
  windows.update(store => {
    const window = store.get(windowId);
    window.state = 'normal';  // ‚Üê MUTATION
    return store;  // ‚Üê SAME REFERENCE
  });
};
// Result: Visual window movement didn't happen because Svelte didn't see the change

// AFTER (Fixed) - Windows move correctly
const activateWindow = (windowId: string) => {
  windows.update(store => {
    const newWindows = new Map(store);  // ‚Üê NEW MAP
    const window = newWindows.get(windowId);
    newWindows.set(windowId, { ...window, state: 'normal' });  // ‚Üê NEW OBJECT
    return newWindows;  // ‚Üê NEW REFERENCE (Svelte sees this!)
  });
};
```

**Testing Your Store Updates:**
1. **Console Log Test**: Add logging before and after update
   ```typescript
   console.log('Before:', store); // Log the store
   storeFunction(args);  // Call update
   subscribe(value => console.log('After:', value));  // Subscribe to see new value
   ```

2. **Reactive Statement Test**: If a reactive statement doesn't trigger, mutation is likely
   ```svelte
   <script>
     let myValue = $store.someProperty;
     $: myValue = $store.someProperty;  // ‚Üê Should update when store changes
   </script>
   ```

3. **Derived Store Test**: Check if derived stores recalculate
   ```typescript
   export const sortedItems = derived(items, $items => 
     // This should re-run when items store updates
   );
   ```

#### 7. Bilingual Language Support Protocol:

**CRITICAL: When adding ANY new UI elements, ALWAYS add translations for both Arabic and English to avoid future errors.**

1. **Translation File Structure**:
   - English translations: `frontend/src/lib/i18n/locales/en.ts`
   - Arabic translations: `frontend/src/lib/i18n/locales/ar.ts`
   - Both files MUST have identical key structures (same number of keys, same names)
   - Never have duplicate keys in the same object - causes "multiple properties with the same name" errors

2. **When Adding New UI Labels**:
   - ‚úÖ Add translation key to English file (en.ts)
   - ‚úÖ Add translation key to Arabic file (ar.ts)
   - ‚úÖ Use IDENTICAL key names in both files
   - ‚úÖ Place translations in the appropriate section (hr, admin, reports, etc.)
   - ‚ùå Don't add to just one language file
   - ‚ùå Don't use different key names between languages
   - ‚ùå Don't create duplicate keys (will cause compilation errors)

3. **Translation Key Naming Conventions**:
   ```typescript
   // ‚úÖ CORRECT - Organized by feature section
   hr: {
     presentToday: "Present Today",
     branchBreakdown: "Branch-wise Breakdown",
     employeeId: "Employee ID",
     checkIn: "Check-in",
     checkOut: "Check-out",
   }
   
   // ‚ùå WRONG - Flat structure without sections
   presentToday: "Present Today",
   branchBreakdown: "Branch-wise Breakdown",
   ```

4. **Using Translation Function in Components**:
   ```svelte
   <!-- ‚úÖ CORRECT - Use t() as a function, NOT as a store -->
   <h3>{t('hr.presentToday')}</h3>
   <button>{t('common.retry')}</button>
   
   <!-- ‚ùå WRONG - Don't use $ prefix (not a Svelte store) -->
   <h3>{$t('hr.presentToday')}</h3>  <!-- Will throw store_invalid_shape error -->
   
   <!-- ‚ùå WRONG - Don't forget to call as function -->
   <h3>{t}</h3>  <!-- Won't work, must include key -->
   ```

5. **Import Statement for i18n**:
   ```typescript
   // ‚úÖ CORRECT - Import t function and stores
   import { t, isRTL, currentLocale } from '$lib/i18n';
   
   // ‚ùå WRONG - Don't import non-existent exports
   import { t, isRTL, currentLanguage } from '$lib/i18n';  // currentLanguage doesn't exist
   import { $t } from '$lib/i18n';  // $t is not an export
   ```

6. **Localizing Database Content (Names, Descriptions)**:
   ```typescript
   // When displaying multilingual database content, use helper function
   import { t, isRTL } from '$lib/i18n';
   
   function getLocalizedText(enText: string, arText: string): string {
     const locale = get(currentLocale);  // Read current locale from store
     return locale === 'ar' ? arText : enText;
   }
   
   // Usage in component
   <p>{getLocalizedText(branch.name_en, branch.name_ar)}</p>
   ```

7. **Verification Checklist for Language Support**:
   - [ ] Added translation key to `en.ts` file
   - [ ] Added translation key to `ar.ts` file
   - [ ] Key names are IDENTICAL in both files
   - [ ] Used as function call: `t('key.path')` (no $ prefix)
   - [ ] No duplicate keys in same object
   - [ ] Verified with `get_errors` tool - no compilation errors
   - [ ] Tested in both English and Arabic modes
   - [ ] Database content uses `getLocalizedText()` helper for ar/en fields

8. **Common Language Support Errors to Avoid**:
   - ‚ùå `store_invalid_shape` - Using `$t()` instead of `t()` (not a store!)
   - ‚ùå `Cannot read properties of undefined` - Translation key doesn't exist
   - ‚ùå Duplicate key errors - Same key defined twice in object
   - ‚ùå Missing Arabic translation - Key only in en.ts, not ar.ts
   - ‚ùå Missing English translation - Key only in ar.ts, not en.ts
   - ‚ùå Hardcoded English text - Should use `t('key')` instead
   - ‚ùå Wrong import path - `$lib/i18n/locales` instead of `$lib/i18n`

9. **Translation File Error Prevention**:
   - ‚úÖ Always check `get_errors` after modifying en.ts or ar.ts
   - ‚úÖ Use VS Code's bracket matching to verify object structure
   - ‚úÖ Count opening/closing braces to ensure balance
   - ‚úÖ Look for duplicate comma errors or missing commas
   - ‚úÖ Verify no trailing commas before closing braces
   - ‚úÖ Ensure each section has matching structure in both files

10. **Handling Component-Specific Translations**:
    ```typescript
    // Good practice: Group translations by feature
    hr: {
      // Biometric data dashboard translations
      biometricData: "Biometric Data",
      presentToday: "Present Today",
      branchBreakdown: "Branch-wise Breakdown",
      
      // Employee management translations
      employee: "Employee",
      employees: "Employees",
    }
    
    // Then use with clear namespacing
    <h1>{t('hr.biometricData')}</h1>
    <p>{t('hr.employee')}</p>
    ```

#### 8. Full-Page Layout Setup Protocol:

**CRITICAL: Full-page layouts require proper flex/grid constraints to prevent overflow and ensure responsive behavior.**

This protocol prevents common layout issues like horizontal scrollbars, content overflow, and improper flex sizing that occurred during CustomerImporter implementation.

**The Problem (COMMON ISSUES):**
```typescript
// ‚ùå WRONG - w-screen includes scrollbar width, causes horizontal overflow
<div class="w-screen h-screen">
  <div class="flex">
    <div class="flex-1">Content</div>  // Flex items have min-w: auto, can overflow
  </div>
</div>

// Symptoms:
// - Horizontal scrollbar appears
// - Content spills outside viewport
// - Mobile layout breaks on certain screens
// - Grid columns don't size properly
```

**The Solution (CORRECT PATTERN):**
```typescript
// ‚úÖ CORRECT - Proper full-page container with flex constraints
<div class="flex flex-col w-full h-screen bg-gradient-to-br from-gray-50 to-gray-100 overflow-hidden">
  <!-- Header with flex-shrink-0 to prevent compression -->
  <div class="flex-shrink-0 bg-white border-b border-gray-200 px-8 py-6 shadow-sm">
    <!-- Header content -->
  </div>

  <!-- Content area that expands to fill remaining space -->
  <div class="flex-1 overflow-hidden p-8 w-full">
    <!-- Scrollable content -->
  </div>
</div>
```

**Why This Works:**
- `w-full` respects parent width constraints (no scrollbar inclusion)
- `h-screen` sets full viewport height
- `overflow-hidden` on root prevents any outer scrolling
- `flex-col` + `flex-1` on content lets it expand to available space
- `min-w-0` on flex children enables shrinking (critical for flex items)
- `flex-shrink-0` on fixed-size elements prevents unwanted compression

**Full-Page Layout Patterns in Aqura:**

**1. Simple Two-Section Layout (Header + Content):**
```svelte
<div class="flex flex-col w-full h-screen bg-gradient-to-br from-gray-50 to-gray-100 overflow-hidden">
  <!-- Fixed Header -->
  <div class="flex-shrink-0 bg-white border-b border-gray-200 px-8 py-6 shadow-sm">
    <h1 class="text-3xl font-bold">{t('title')}</h1>
  </div>

  <!-- Scrollable Content -->
  <div class="flex-1 overflow-y-auto p-8 w-full">
    <div class="max-w-7xl mx-auto space-y-8">
      <!-- Content goes here -->
    </div>
  </div>
</div>
```

**2. Two-Column Layout (Sidebar + Content):**
```svelte
<div class="flex w-full h-screen bg-gray-50 overflow-hidden">
  <!-- Sidebar - Fixed width, scrollable -->
  <div class="w-64 bg-white border-r border-gray-200 overflow-y-auto flex-shrink-0">
    <!-- Sidebar content -->
  </div>

  <!-- Main Content - Expands to fill space -->
  <div class="flex-1 flex flex-col overflow-hidden min-w-0">
    <!-- Header -->
    <div class="flex-shrink-0 bg-white border-b px-8 py-6">
      <!-- Header content -->
    </div>

    <!-- Content -->
    <div class="flex-1 overflow-y-auto p-8 w-full min-w-0">
      <!-- Content here, min-w-0 enables flex shrinking -->
    </div>
  </div>
</div>
```

**3. Multi-Column Grid Layout (Like CustomerImporter):**
```svelte
<div class="flex flex-col w-full h-screen bg-gradient-to-br from-gray-50 to-gray-100 overflow-hidden">
  <!-- Header -->
  <div class="flex-shrink-0 bg-white border-b px-8 py-6">
    <!-- Header -->
  </div>

  <!-- Content Grid -->
  <div class="flex-1 overflow-hidden p-8 w-full">
    <!-- CRITICAL: grid container needs min-w-0 w-full overflow-hidden -->
    <div class="flex-1 grid grid-cols-3 gap-8 min-w-0 w-full overflow-hidden">
      <!-- Left column (col-span-2) - Scrollable -->
      <div class="col-span-2 space-y-8 overflow-y-auto pr-4 min-w-0">
        <!-- Content with min-w-0 to allow flex shrinking -->
      </div>

      <!-- Right column (col-span-1) - Scrollable -->
      <div class="col-span-1 flex flex-col min-w-0 w-full overflow-hidden">
        <!-- Content -->
        <div class="flex-1 overflow-y-auto min-w-0">
          <!-- Scrollable items -->
        </div>
      </div>
    </div>
  </div>
</div>
```

**Critical Constraints for Full-Page Layouts:**

| Situation | Solution | Why |
|-----------|----------|-----|
| Root container spilling off-screen | Use `w-full` not `w-screen` | w-screen includes scrollbar width |
| Flex items overflow horizontally | Add `min-w-0` to flex children | Flex items default to min-w: auto (no shrinking) |
| Text in flex container overflows | Use `truncate` or `text-ellipsis` on items | Long text can prevent flex shrinking |
| Grid columns overflow | Add `min-w-0` to grid items | Same as flex - grid items need explicit shrink |
| Content gets cut off at bottom | Use `flex-1` instead of `h-full` on scrollable | flex-1 respects flex container sizing |
| Content jumps/shifts when scrollbar appears | Use `overflow-hidden` on root | Prevents content reflow when scrollbar appears |
| Header compresses when scrolling | Add `flex-shrink-0` to header | Prevents flex compression |
| Nested scrollbars conflict | Add `overflow-hidden` to parent container | Prevents multiple scroll areas interfering |

**Responsive Full-Page Layouts:**

```svelte
<!-- Responsive layout that stacks on mobile -->
<div class="flex flex-col w-full h-screen bg-gray-50 overflow-hidden lg:flex-row">
  <!-- Sidebar hides on mobile -->
  <div class="hidden lg:flex lg:w-64 bg-white border-r overflow-y-auto flex-shrink-0">
    <!-- Sidebar -->
  </div>

  <!-- Main content expands on all sizes -->
  <div class="flex-1 flex flex-col overflow-hidden min-w-0">
    <!-- Header -->
    <div class="flex-shrink-0 bg-white border-b px-6 py-4">
      <!-- Header -->
    </div>

    <!-- Content -->
    <div class="flex-1 overflow-y-auto p-6 w-full min-w-0">
      <!-- Content responds to available space -->
    </div>
  </div>
</div>
```

**Common Full-Page Layout Mistakes to Avoid:**

1. ‚ùå **Using `h-full` instead of `h-screen`** on root
   - `h-full` = 100% of parent height (needs parent to have height)
   - `h-screen` = 100vh (full viewport height, always works for root)

2. ‚ùå **Forgetting `min-w-0` on flex children**
   - Flex items won't shrink below content width without it
   - Results in overflow and horizontal scrollbars

3. ‚ùå **Using `w-screen` on responsive elements**
   - Includes scrollbar width, causes overflow
   - Use `w-full` for responsive width

4. ‚ùå **Not adding `overflow-hidden` to scrollable parent**
   - Child scrollbars can cause parent to scroll too
   - Always isolate scroll contexts with overflow-hidden

5. ‚ùå **Making scrollable content `w-screen` or `max-w-full`**
   - Forces full screen width for scrollable content
   - Use `w-full min-w-0` for proper flex sizing

6. ‚ùå **Using `flex-1` on fixed-height headers/footers**
   - `flex-1` makes element expand; use `flex-shrink-0` instead
   - `flex-shrink-0` prevents flex compression

7. ‚ùå **Nesting flex containers without `overflow-hidden`**
   - Can cause cascading scroll issues
   - Always isolate with overflow-hidden

8. ‚ùå **Putting `max-w-*` constraints on full-page containers**
   - Defeats full-page purpose
   - Put max-w only on content inside, not the container

**Verification Checklist for Full-Page Layouts:**

- [ ] Root container uses `flex flex-col w-full h-screen overflow-hidden`
- [ ] Header has `flex-shrink-0` to prevent compression
- [ ] Content area uses `flex-1 overflow-y-auto` to fill space
- [ ] All flex children have `min-w-0` to allow shrinking
- [ ] No `w-screen` used (use `w-full` instead)
- [ ] Scrollable sections isolated with `overflow-hidden` on parents
- [ ] Grid columns have `min-w-0` if they contain scrollable content
- [ ] Tested responsiveness on mobile (flex containers stack properly)
- [ ] No horizontal scrollbar appears on any screen size
- [ ] Content fills full height without gaps
- [ ] Scrolling works smoothly without jumping/shifting

**Real-World Example (CustomerImporter):**

```svelte
<!-- ‚úÖ CORRECT - Full-page layout with 2-column grid -->
<div class="flex flex-col w-full h-screen bg-gradient-to-br from-gray-50 to-gray-100 overflow-hidden">
  <!-- Header - Fixed height, doesn't scroll -->
  <div class="flex-shrink-0 bg-white border-b border-gray-200 px-8 py-6 shadow-sm">
    <div class="flex items-center justify-between gap-6 w-full">
      <div class="bg-gradient-to-br from-red-50 to-orange-50 border-l-4 border-orange-500 px-6 py-4 rounded-xl flex-1 min-w-0">
        <h1 class="text-3xl font-bold text-gray-900">Import Customers</h1>
      </div>
      <button class="px-6 py-3 bg-green-500 text-white rounded-xl flex-shrink-0">
        Download Template
      </button>
    </div>
  </div>

  <!-- Content - Expands and scrolls -->
  <div class="flex-1 overflow-hidden p-8 w-full">
    <!-- Campaign selector -->
    <div class="mb-8 flex-shrink-0">
      <select class="w-full px-4 py-3 border rounded-xl"></select>
    </div>

    <!-- Two-column grid - Takes remaining space -->
    <div class="flex-1 grid grid-cols-3 gap-8 min-w-0 w-full overflow-hidden">
      <!-- Import section (col-span-2) - Scrollable -->
      <div class="col-span-2 space-y-8 overflow-y-auto pr-4 min-w-0">
        <!-- File upload, manual entry, preview - all scrollable -->
      </div>

      <!-- Customer list (col-span-1) - Scrollable independently -->
      <div class="col-span-1 flex flex-col min-w-0 w-full overflow-hidden">
        <div class="flex-1 overflow-y-auto min-w-0">
          <!-- Customer list items -->
        </div>
      </div>
    </div>
  </div>
</div>
```

### Exceptions (Can proceed without confirmation):
- ‚úÖ **Reading files** to gather context
- ‚úÖ **Searching codebase** to understand structure
- ‚úÖ **Checking database schema** using utility scripts
- ‚úÖ **Providing information** or explanations
- ‚úÖ **Suggesting solutions** without implementing them

### Communication Pattern:
```
User: "Add a new feature X"

Copilot Response:
"I'll help you add feature X. Let me first check the current implementation...

[After checking]

Here's my plan:
1. Create new component at src/lib/components/desktop-interface/master/X.svelte
2. Add route at src/routes/desktop-interface/x/+page.svelte (if needed)
3. Update windowManager.ts to include new window type
4. Add i18n translations for Arabic/English (en.ts and ar.ts)

This will affect:
- Window system (new window type)
- Routing (new route if applicable)
- i18n files (new translations)

Should I proceed with this implementation?"

[WAIT FOR USER: "yes" / "proceed" / "go ahead"]
```

### Communication Style for Summaries:
When summarizing work or providing updates to users:
- ‚úÖ **Keep it brief and conversational** - Use simple, friendly language
- ‚úÖ **Focus on what was accomplished** - Describe the outcome, not the technical details
- ‚úÖ **Use bullet points** - Easy to scan and understand
- ‚úÖ **Avoid code snippets** - Unless specifically requested by the user
- ‚úÖ **Be human and relatable** - "Fixed the issue where offers were disappearing" instead of "Modified RLS policy execution"
- ‚úÖ **Highlight user benefits** - "Now you can see and manage paused offers" instead of "Implemented reactive filtering"

### Never Assume:
- ‚ùå Don't assume column names exist in database tables - CHECK FIRST
- ‚ùå Don't assume functions or triggers exist - VERIFY using utility scripts
- ‚ùå Don't assume file structure - LIST directories if unsure
- ‚ùå Don't assume dependencies are installed - CHECK package.json
- ‚ùå Don't assume user wants a specific implementation - ASK for preferences
- ‚ùå Don't assume backwards compatibility is not needed - CONFIRM breaking changes

### Terminal Commands:
- **ALWAYS use PowerShell commands** - The development environment is VS Code on Windows with PowerShell
- Use PowerShell syntax: `Remove-Item`, `Copy-Item`, `Get-ChildItem`, etc.
- NOT bash/Linux commands: avoid `rm`, `cp`, `ls`, etc.
- Use semicolons (`;`) to chain commands on a single line if needed
- Use `2>$null` to suppress error output in PowerShell

### Git Workflow:
- **ALWAYS check git status before push** - Use `git status` to review staged and unstaged changes
- Review what files will be committed before pushing
- Ensure no unintended files are staged (e.g., .env, node_modules, build artifacts)
- Verify commit message follows conventional commits format
- Check for any merge conflicts before pushing

```powershell
# Recommended git workflow
git status                           # Check current status
git add -A                          # Stage all changes (after review)
git status                          # Verify staged changes
git commit -m "feat: description"   # Commit with conventional format
git status                          # Confirm clean working tree
git push origin master              # Push to remote
```

---

## üéØ Project Context

### Current Status: v2.0.2
- **Phase**: Development - Frontend foundation completed
- **Focus**: PWA-first windowed management platform for Saudi businesses
- **Target**: Bilingual (Arabic/English) enterprise management system

### Architecture:
- **Frontend**: SvelteKit + TypeScript + TailwindCSS + Vite PWA
- **Backend**: Go (Fiber framework) + Supabase (PostgreSQL + Auth + Storage)  
- **Deployment**: Vercel (Frontend) + Supabase (Backend)
- **Build Tools**: pnpm monorepo + Vite + PWA + Electron packaging
- **Package Manager**: pnpm (required - NOT npm/yarn)

### Development Environment:

**IMPORTANT: Always start the local dev server using VS Code tasks, NOT terminal commands.**

#### Starting the Local Dev Server:
1. **Use VS Code Task**: Press `Ctrl+Shift+B` or go to Terminal ‚Üí Run Task
2. **Select Task**: Choose **"üé® Dev Frontend (npm)"** from the task list
3. **Server starts on port 5173** - http://localhost:5173
4. **Task runs in background** - continues running until manually stopped

#### Manual Terminal Commands (if needed):
```powershell
# Windows PowerShell - Install pnpm globally first
npm install -g pnpm

# Then run from project root
cd d:\Aqura\frontend
npm run dev  # Starts dev server on port 5175
```

#### Other Development Tasks:
```bash
# Build commands (via VS Code Tasks)
npm run build  # Build all
pnpm build:pwa  # PWA build
pnpm build:windows  # Windows installer

# Utility commands
pnpm lint  # Lint all packages
pnpm test  # Run all tests  
pnpm i18n:extract  # Extract i18n strings
```

#### Available VS Code Tasks:
- **üé® Dev Frontend (npm)** - START LOCAL DEV SERVER (RECOMMENDED)
- üöÄ Build All - Build all packages
- üì± Build PWA - Create PWA build
- ü™ü Build Windows Installer - Create Windows installer
- üßπ Lint All - Run linters
- üß™ Test All - Run tests

### Key Features Implemented:
- ‚úÖ **Windowed Desktop Interface**: Drag/resize/minimize windows, taskbar, command palette
- ‚úÖ **PWA Capabilities**: Installable, offline-first, service worker, push notifications
- ‚úÖ **Bilingual System**: Arabic/English with RTL support and cultural adaptations
- ‚úÖ **Business Modules**: 
  - HR Management (employees, departments, positions, salary)
  - Branch Management (multi-branch operations)
  - Vendor Management (vendor details, payment schedules, visits)
  - Receiving Management (receiving records, tasks, workflow)
  - Task System (assignments, completion tracking, reminders)
  - Customer Management (registration, login, recovery)
  - Finance Management (expenses, requisitions, payments)
  - Notification System (push notifications, in-app notifications)
- ‚úÖ **Accessibility**: WCAG 2.1 compliant, screen reader support, keyboard navigation
- ‚úÖ **Security**: Supabase RLS, JWT auth, encrypted transmission

### Key Components:
- **Window Manager** (`windowManager`) - Desktop-style window management system
- **Sidebar Navigation** - Multi-level navigation with submenus and role-based access
- **i18n System** - Custom bilingual localization (not auto-translate)
- **PWA Features** - Service worker, offline support, installation, push notifications
- **Data Management** - Supabase integration with real-time updates
- **User Management** - Role-based access control with position-based permissions
- **Task Management** - Full task workflow with assignments, completion, and tracking
- **Notification Center** - In-app notifications with attachments and read states
- **Receiving System** - Complete receiving workflow with role-specific tasks
- **My Tasks View** - Personal task dashboard with smooth UI updates
- **Cashier Interface** - Standalone desktop-style coupon redemption system with dedicated sidebar, taskbar, and window management

### UI/UX Guidelines:
- **Desktop-First**: Windowed interface with OS-style interactions
- **Mobile Responsive**: Touch-friendly mobile layouts
- **Bilingual**: Arabic RTL + English LTR with cultural adaptations
- **Accessibility**: ARIA labels, keyboard navigation, screen reader support
- **Color System**: Brand colors with consistent theming
- **Typography**: Noto Sans Arabic + Inter fonts

### Code Style Guidelines:
- **TypeScript**: Use for type safety, balanced typing (strict for domain, relaxed for UI)
- **Svelte Patterns**: Follow reactive patterns with Svelte stores
- **Error Handling**: Implement proper error handling with user feedback
- **Loading States**: Add loading states and user feedback for all async operations
- **Accessibility**: Use semantic HTML, ARIA labels, and keyboard navigation
- **Modularity**: Keep functions focused and modular
- **i18n**: Use custom i18n system (`import { t } from '$i18n'`)
- **Responsive**: Mobile-first responsive design with touch support

### Database Schema (Supabase):

**CRITICAL: ALWAYS CHECK DATABASE DIRECTLY - NEVER ASSUME SCHEMA**

**Why Direct Database Verification is Required:**
- SQL migration files have been removed from the repository
- Database schema is managed directly in Supabase
- Schema may change without local file updates
- Real-time verification prevents errors and assumptions

**How to Check Table Structure (JavaScript with Service Role Key):**

```javascript
// ALWAYS use this pattern to check table structure before working with any table
import { readFileSync } from 'fs';
import { createClient } from '@supabase/supabase-js';

// Load environment variables from frontend/.env
const envPath = './frontend/.env';
const envContent = readFileSync(envPath, 'utf-8');
const envVars = {};

envContent.split('\n').forEach(line => {
  const trimmed = line.trim();
  if (trimmed && !trimmed.startsWith('#')) {
    const match = trimmed.match(/^([^=]+)=(.*)$/);
    if (match) {
      envVars[match[1].trim()] = match[2].trim();
    }
  }
});

const supabaseUrl = envVars.VITE_SUPABASE_URL;
const supabaseServiceKey = envVars.VITE_SUPABASE_SERVICE_ROLE_KEY; // Use service role for full access

const supabase = createClient(supabaseUrl, supabaseServiceKey);

// Example: Check table structure and data
async function checkTable(tableName) {
  const { data, error, count } = await supabase
    .from(tableName)
    .select('*', { count: 'exact' })
    .limit(2);

  if (error) {
    console.error(`‚ùå Error: ${error.message}`);
    return;
  }

  console.log(`üìä Table: ${tableName}`);
  console.log(`   Total records: ${count}`);
  
  if (data && data.length > 0) {
    console.log(`   Columns:`, Object.keys(data[0]));
    console.log(`   Sample:`, JSON.stringify(data[0], null, 2));
  }
}

// Check specific table
await checkTable('offers');
```

**Environment Variables** (from `frontend/.env` file):
- `VITE_SUPABASE_URL` - Supabase project URL
- `VITE_SUPABASE_ANON_KEY` - Public anon key (limited access)
- `VITE_SUPABASE_SERVICE_ROLE_KEY` - Service role key (full database access, check schema)

**Database Summary:**
- **Total Tables: 71** (Customer-specific offers removed)
- Tables are organized by category: HR, Tasks, Receiving, Notifications, Finance, Customer, Product, Offers, System
- Use the verification script above to check any table's current structure before working with it

### Entity Types: Understanding users vs employees vs customers

**CRITICAL**: The Aqura system has THREE distinct entity types that serve different purposes and should NOT be confused:

#### 1. **USERS** (`users` table - UUID id)
- **Purpose**: Admin/Manager staff who operate the DESKTOP admin interface
- **Interface**: Desktop windowed management system (main Aqura interface)
- **Capabilities**: 
  - Create and manage offers, tasks, and business operations
  - Access all admin features and management tools
  - Assign offers to customers, manage employee records
  - Full system administration and configuration
- **Authentication**: Supabase Auth with role-based permissions
- **Usage Examples**:
  - `offers.created_by` ‚Üí References admin user who created the offer
  - `tasks.created_by` ‚Üí References admin user who created the task
  - `notifications.created_by` ‚Üí References admin user who sent the notification
- **Database Relations**: Primary operators of the system with highest permissions

#### 2. **EMPLOYEES** (`hr_employees` table - UUID id)
- **Purpose**: Company staff/workers tracked in the HR management system
- **Interface**: Managed through Desktop HR module (not direct system users)
- **Capabilities**:
  - Tracked for payroll, attendance, department assignments
  - Managed by admins through HR interface
  - May or may not have user accounts (separate from users table)
  - Subject to HR policies, salary components, position assignments
- **Authentication**: NOT directly authenticated (managed entities, not system users)
- **Usage Examples**:
  - `hr_employees.id` ‚Üí Employee records for HR purposes
  - `hr_position_assignments.employee_id` ‚Üí Position tracking
  - `hr_salary_components.employee_id` ‚Üí Salary management
  - `expense_requisitions.employee_id` ‚Üí Employee expense requests
- **Database Relations**: HR system entities, MAY have corresponding users table entry if given admin access
- **Key Distinction**: Employees are HR records; users are system operators. An employee might become a user if granted admin access, but most employees are NOT users.

#### 3. **CUSTOMERS** (`customers` table - UUID id)
- **Purpose**: End users/shoppers who use the MOBILE customer app
- **Interface**: Mobile customer-facing application (shopping, orders, offers)
- **Capabilities**:
  - Browse products and place orders
  - Receive and use offers/promotions
  - Track order history and delivery
  - Manage personal profile and preferences
- **Authentication**: Separate customer authentication system (access codes, mobile registration)
- **Usage Examples**:
  - `offer_usage_logs.customer_id` ‚Üí Customer who used an offer
  - `orders.customer_id` ‚Üí Customer who placed the order (when orders table exists)
  - `customer_recovery_requests.customer_id` ‚Üí Customer account recovery
- **Database Relations**: Mobile app users with limited, customer-facing permissions

#### Summary Table:

| Aspect | USERS | EMPLOYEES | CUSTOMERS |
|--------|-------|-----------|-----------|
| **ID Type** | UUID | UUID | UUID |
| **Table** | `users` | `hr_employees` | `customers` |
| **Interface** | Desktop Admin | Managed by Admin | Mobile App |
| **Purpose** | System operators | HR records | End shoppers |
| **Auth Type** | Supabase Auth | No direct auth | Customer auth |
| **Permissions** | Full admin access | Managed entities | Limited customer access |
| **Can Create Offers?** | ‚úÖ Yes | ‚ùå No | ‚ùå No |
| **Can Receive Offers?** | ‚ùå No | ‚ùå No | ‚úÖ Yes |
| **Can Place Orders?** | ‚ùå No | ‚ùå No | ‚úÖ Yes |
| **In HR System?** | Maybe (if also employee) | ‚úÖ Yes | ‚ùå No |

#### Common Mistakes to Avoid:
- ‚ùå **Don't confuse** `users` with `employees` - they serve different purposes
- ‚ùå **Don't assume** all employees have user accounts (most don't)
- ‚ùå **Don't use** `hr_employees` table for offer assignments (use `customers` table)
- ‚ùå **Don't reference** `employees` in customer-facing features (use `customers` table)
- ‚ùå **Don't mix** admin operations (`users`) with customer operations (`customers`)

#### When Creating New Features:
- **Admin/Manager Actions** ‚Üí Use `users` table (created_by, assigned_by, managed_by)
- **Customer-Facing Features** ‚Üí Use `customers` table (customer_id, user_id in customer context)
- **HR Operations** ‚Üí Use `hr_employees` table (employee_id for payroll, attendance, positions)
- **Cross-Reference Check**: Always verify which entity type is appropriate for your use case

**Total Tables: 65**

Core tables by category:

**User & Authentication:**
- `users` - User accounts and profiles with RLS
- `user_roles` - User role assignments
- `user_sessions` - Active user sessions
- `user_device_sessions` - Device-specific sessions
- `user_password_history` - Password change history
- `user_audit_logs` - User activity audit trail
- `role_permissions` - Role-based permissions
- `interface_permissions` - UI permission controls

**HR Management (11 tables):**
- `hr_employees` - Employee records (203 records)
- `hr_departments` - Department structure
- `hr_positions` - Position definitions
- `hr_position_assignments` - Employee-position mapping
- `hr_levels` - Hierarchical levels
- `hr_salary_components` - Salary breakdown
- `hr_salary_wages` - Wage information
- `hr_employee_contacts` - Employee contact details
- `hr_employee_documents` - Document management
- `hr_fingerprint_transactions` - Attendance tracking
- `hr_position_reporting_template` - Reporting structure

**Task Management (13 tables):**
- `tasks` - Main task system with assignments
- `task_assignments` - Task-user assignments
- `task_completions` - Task completion records
- `task_images` - Task attachments
- `task_reminder_logs` - Reminder history
- `receiving_tasks` - Receiving-specific tasks
- `receiving_task_templates` - Task templates
- `quick_tasks` - Quick task creation
- `quick_task_assignments` - Quick task assignments
- `quick_task_comments` - Task comments
- `quick_task_completions` - Quick task completions
- `quick_task_files` - Quick task attachments
- `quick_task_user_preferences` - User preferences
- `recurring_assignment_schedules` - Recurring task schedules
- `recurring_schedule_check_log` - Schedule execution log

**Receiving & Vendor (3 tables):**
- `receiving_records` - Receiving transaction data (755 records)
- `vendors` - Vendor information
- `vendor_payment_schedule` - Payment schedules

**Notifications (6 tables):**
- `notifications` - System notifications
- `notification_queue` - Push notification queue
- `notification_attachments` - Notification attachments
- `notification_recipients` - Notification recipients
- `notification_read_states` - Read status tracking
- `push_subscriptions` - Web push subscriptions

**Finance & Expenses (7 tables):**
- `expense_requisitions` - Expense requests
- `expense_parent_categories` - Main categories
- `expense_sub_categories` - Sub categories
- `expense_scheduler` - Scheduled expenses
- `employee_warnings` - Employee warnings
- `employee_warning_history` - Warning history
- `employee_fine_payments` - Fine payment tracking
- `non_approved_payment_scheduler` - Pending payments

**Customer Management (5 tables):**
- `customers` - Customer accounts
- `customer_recovery_requests` - Account recovery
- `customer_access_code_history` - Access code history
- `customer_app_media` - Customer media content
- `delivery_service_settings` - Delivery configuration
- `delivery_fee_tiers` - Delivery fee structure

**Product Management (4 tables):**
- `products` - Product catalog
- `product_categories` - Product categories
- `product_units` - Measurement units
- `tax_categories` - Tax definitions

**Offer System (6 tables - NORMALIZED STRUCTURE):**
- `offers` - Main offer metadata (cleaned - no redundant columns)
  - Core fields only: id, type, names, dates, limits, settings
  - All offer-specific data stored in child tables
- `offer_products` - Product-specific offers (percentage/special price)
  - Contains: product_id, offer_qty, offer_percentage, offer_price, max_uses
- `offer_bundles` - Bundle offer definitions
  - Contains: bundle_name, required_products (JSON array), discount_value
- `bogo_offer_rules` - Buy X Get Y offers
  - Contains: buy_product_id, buy_quantity, get_product_id, get_quantity, discount
- `offer_cart_tiers` - Cart-level discount tiers
  - Contains: tier_number, min_amount, max_amount, discount_type, discount_value
- `offer_usage_logs` - Usage tracking and limits enforcement
  - Contains: offer_id, customer_id, product_id, discount_applied, timestamp

**IMPORTANT NOTES:**
- ‚ùå `customer_offers` table has been REMOVED (not needed - offers are global)
- ‚úÖ All redundant columns removed from `offers` table (2025-11-14 cleanup)
- ‚úÖ Offer-specific data properly normalized into child tables
- ‚úÖ Always query child tables for offer details (products, bundles, BOGO, tiers)

**System & Configuration (4 tables):**
- `branches` - Branch/location management
- `app_functions` - System functions
- `approval_permissions` - Approval workflows
- `requesters` - Request originators

### Database Functions (Supabase):
**Total Functions: 256** organized into 8 categories

Use `node list-functions.js` to see all functions by category.

**Key Functions by Category:**

**Task Management (59 functions)** - Task workflow and completion
- `complete_receiving_task_simple` - Complete receiving tasks with validation
- `create_quick_task_with_assignments` - Create and assign quick tasks
- `check_overdue_tasks_and_send_reminders` - Automated reminder system
- `validate_task_completion_requirements` - Ensure completion criteria met

**Receiving & Vendor (51 functions)** - Receiving workflow and vendor management
- `get_vendor_for_receiving_record` - Fetch vendor details for receiving
- `calculate_next_visit_date` - Auto-calculate vendor visit schedules
- `sync_erp_reference_for_receiving_record` - Sync ERP invoice references

**User Management (20 functions)** - Authentication and permissions
- `create_user` - User account creation with role assignment
- `verify_password` - Password verification and hashing
- `get_user_interface_permissions` - Retrieve UI permission set

**Employee/HR (10 functions)** - HR and employee management
- `sync_employee_with_hr` - Sync employee data with HR system
- `get_active_employees_by_branch` - Branch-specific employee lists

**Financial (16 functions)** - Payment and expense management
- `record_fine_payment` - Record employee fine payments
- `count_bills_without_pr_excel` - Track missing PR Excel files
- `validate_payment_methods` - Ensure valid payment method selection

**Notification (23 functions)** - Push and in-app notifications
- `queue_push_notification` - Queue notifications for delivery
- `process_push_notification_queue` - Process queued notifications
- `cleanup_orphaned_notifications` - Maintain notification hygiene

**Customer (12 functions)** - Customer account management
- `authenticate_customer_access_code` - Customer authentication
- `create_customer_registration` - New customer registration
- `process_customer_recovery` - Account recovery workflow

**System/ERP (31 functions)** - System utilities and ERP integration
- `get_database_schema` - Retrieve complete database schema
- `get_database_functions` - List all database functions
- `sync_all_missing_erp_references` - Batch sync ERP data
- `http_*` - HTTP utility functions for external API calls

### Database Triggers (Supabase):
**Total Triggers: 71** across 35 tables organized by function type

Use `node list-triggers.js` to see all triggers by table.

**Key Trigger Types:**

**Timestamp Management (Most tables):**
- `update_updated_at` - Auto-update timestamp on record changes
- Applied to most core tables for audit trails

**Auto-Calculations:**
- `calculate_receiving_amounts` - Auto-calculate amounts in receiving records
- `calculate_category_days` - Calculate expense category days
- `update_final_bill_amount_on_adjustment` - Recalculate bill amounts

**Synchronization:**
- `sync_user_roles_from_positions` - Sync roles when position changes
- `sync_requisition_balance` - Update balance on payment changes
- `sync_erp_reference` - Sync ERP invoice references

**Notifications:**
- `queue_push_notification_trigger` - Queue push notifications
- `create_quick_task_notification` - Notify on task creation
- `notify_expense_changes` - Alert on expense updates

**Audit & Logging:**
- `log_user_action` - Log all user actions (INSERT/UPDATE/DELETE on users table)
- `log_password_change` - Track password changes in history
- `track_access_code_changes` - Log customer access code updates

**Cleanup & Maintenance:**
- `cleanup_assignment_notifications` - Remove orphaned notification assignments
- `cleanup_task_notifications` - Clean up task-related notifications
- `delete_old_push_subscriptions` - Remove expired push subscriptions

**Tables with Most Triggers:**
- `expense_scheduler` - 8 triggers (scheduling, calculation, notification)
- `hr_employee_documents` - 6 triggers (status, workflow, validation)
- `employee_warnings` - 5 triggers (warning workflow, fine tracking)
- `users` - 5 triggers (audit, role sync, session management)

### Database Constraints:
**Note**: Constraint details should be checked directly in Supabase Dashboard or by inspecting individual tables.

**Utility Script**: Use `node check-table-structure.js [table_name]` to see column structure including:
- Primary keys (id columns with SERIAL/UUID types)
- Foreign key relationships (references to other tables)
- NOT NULL constraints (is_nullable field)
- Default values and data types

**Common Constraint Patterns:**
- **Primary Keys**: All tables have `id` as primary key (SERIAL or UUID)
- **Foreign Keys**: Consistent naming (`table_id` references `table.id`)
- **Timestamps**: `created_at` and `updated_at` with NOT NULL constraints
- **Branch Relations**: Most operational tables link to `branches.id`
- **User Relations**: Activity tables link to `users.id` for audit trails
- **Status Fields**: Use CHECK constraints for valid status values
- **Unique Constraints**: Applied to business identifiers (employee_id, erp_reference, etc.)

**Referential Integrity Examples:**
- `hr_employees.branch_id` ‚Üí `branches.id`
- `tasks.assigned_to` ‚Üí `users.id`
- `receiving_records.vendor_id` ‚Üí `vendors.id`
- `notifications.created_by` ‚Üí `users.id`
- `expense_requisitions.employee_id` ‚Üí `hr_employees.id`

### File Structure:
```
Aqura/
‚îú‚îÄ‚îÄ frontend/               # SvelteKit PWA frontend
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/    # Reusable UI components (INTERFACE-BASED ORGANIZATION)
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ common/            # Shared components across all interfaces
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FileUpload.svelte
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FileDownload.svelte
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ NotificationSoundControls.svelte
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ToastNotifications.svelte
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UserSwitcher.svelte
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ WelcomeWindow.svelte
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Window.svelte              # Core window component
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ WindowManager.svelte       # Window management system
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ desktop-interface/  # Desktop admin interface (36+ components)
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ common/         # Sidebar, Taskbar, CommandPalette
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ master/         # Master data (Branch, HR, Task, Vendor, etc.)
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ work/           # Work management (receiving, tasks, requisitions)
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin-customer-app/  # Customer app management
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ products/   # Product management (8 components)
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ communication/  # Notifications, messages
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings/       # Settings (7 components + user management)
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ customer-interface/  # Customer shopping interface (7 components)
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ common/         # TopBar, BottomNav, CustomerLogin
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cart/           # BottomCartBar
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ shopping/       # FeaturedOffers, OfferBadge, OfferDetailModal
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mobile-interface/   # Mobile employee interface (4 components)
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ common/         # LanguageToggle
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notifications/  # NotificationCenter
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tasks/          # TasksWindow, QuickTaskModal, TaskCompletionModal
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ cashier-interface/  # Cashier/POS interface (4 components)
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ CashierInterface.svelte   # Standalone desktop interface
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ CashierLogin.svelte       # Access code authentication
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ CashierTaskbar.svelte     # Taskbar for cashier
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ CouponRedemption.svelte   # Coupon redemption window
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stores/        # Svelte stores for state management
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ utils/         # Utility functions and helpers
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types/         # TypeScript type definitions
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ i18n/          # Custom bilingual system (Arabic/English)
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes/            # SvelteKit file-based routing
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ +layout.svelte        # Root layout
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ +layout.server.ts     # Server config
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ +page.svelte          # Root router/redirect
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login/                # Main interface selector ‚úÖ
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ +page.svelte
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ desktop-interface/    # Desktop admin routes ‚úÖ
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ +layout.svelte
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ +page.svelte
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ receiving/        # Receiving workflow pages
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ customer-interface/   # Customer shopping routes ‚úÖ
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ +layout.svelte
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ +page.svelte
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login/           # Customer login ‚úÖ
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ register/        # Customer registration ‚úÖ
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cart/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ checkout/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ orders/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ products/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ profile/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mobile-interface/     # Mobile employee routes ‚úÖ
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ +layout.svelte
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ +page.svelte
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login/           # Mobile login ‚úÖ
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ +layout.svelte
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ +page.svelte
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tasks/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notifications/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ assignments/
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cashier-interface/    # Cashier routes ‚úÖ
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ +page.svelte
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ api/                  # Backend API endpoints (+server.js)
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ customer/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ erp/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ receiving-records/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ receiving-tasks/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ tasks/
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app.html           # HTML template
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ app.css            # Global styles
‚îÇ   ‚îú‚îÄ‚îÄ static/                # Static assets (icons, sounds, manifest)
‚îÇ   ‚îî‚îÄ‚îÄ package.json           # Frontend dependencies
‚îú‚îÄ‚îÄ supabase/                  # Supabase backend configuration
‚îÇ   ‚îú‚îÄ‚îÄ functions/             # Edge functions (push notifications, etc.)
‚îÇ   ‚îú‚îÄ‚îÄ migrations/            # Database migrations (SQL files removed)
‚îÇ   ‚îî‚îÄ‚îÄ config.toml            # Supabase configuration
‚îú‚îÄ‚îÄ scripts/                   # Utility scripts
‚îÇ   ‚îî‚îÄ‚îÄ update-version.js      # Version management script
‚îú‚îÄ‚îÄ build/                     # Production build output
‚îú‚îÄ‚îÄ package.json               # Root workspace configuration
‚îî‚îÄ‚îÄ pnpm-workspace.yaml        # pnpm monorepo configuration
```

### Component Organization Rules:
- ‚úÖ **common/** - Shared across ALL interfaces (window system, file upload, notifications)
- ‚úÖ **desktop-interface/** - Desktop admin components ONLY
- ‚úÖ **customer-interface/** - Customer shopping app components ONLY
- ‚úÖ **mobile-interface/** - Mobile employee app components ONLY
- ‚úÖ **cashier-interface/** - Cashier/POS components ONLY
- ‚ùå **Never mix** components from different interfaces
- ‚ùå **Never use** `admin/`, `mobile/`, `customer/` - use proper interface names

### Routes Organization (‚úÖ COMPLETED - See ROUTES_REORGANIZATION_PLAN.md):
- ‚úÖ **Completed:** Routes renamed to match component structure
  - `/customer` ‚Üí `/customer-interface` ‚úÖ
  - `/mobile` ‚Üí `/mobile-interface` ‚úÖ
  - `/cashier` ‚Üí `/cashier-interface` ‚úÖ
  - Login pages moved:
    - `/login` ‚Üí Root level (main interface selector) ‚úÖ
    - `/mobile-login` ‚Üí `/mobile-interface/login` ‚úÖ
    - `/customer-login` ‚Üí `/customer-interface/login` ‚úÖ
    - `/register` ‚Üí `/customer-interface/register` ‚úÖ

### Important Conventions:
- **Database Schema**: ALWAYS query directly from Supabase - NEVER assume or guess schema structure
- **Service Role Key**: Use `SUPABASE_SERVICE_ROLE_KEY` from `frontend/.env` for direct database access
- **Schema Verification**: Always fetch current schema before making any changes
- **Commits**: Use conventional commits (`feat:`, `fix:`, `docs:`, `perf:`, etc.)
- **Branches**: Work on `master` branch (single developer workflow)
- **Imports**: Use `$lib` alias for library imports
- **Styling**: TailwindCSS with custom design system
- **State**: Use Svelte stores for global state management
- **API**: Use Supabase client for data operations with RLS policies
- **Routes**: SvelteKit file-based routing with `+page.svelte` and `+server.js`
- **Performance**: Batch database queries, use reactive updates instead of full reloads
- **UX**: Smooth transitions, optimistic UI updates, proper loading states

---

## üìä Fetching Database Schema, Functions, and Storage from Supabase

**CRITICAL: ALWAYS fetch database metadata directly from Supabase. NEVER assume or guess. NEVER use outdated documentation.**

### Why Direct Query is Required:

- SQL migration files are NOT in the repository
- Database schema is managed directly in Supabase
- Schema changes without local file updates are common
- Real-time verification prevents errors and assumptions
- Storage buckets are dynamic and change frequently

### Method 1: Fetch Database Schema

**Script Location:** `scripts/create-schema-md.js`

**How to Use:**
```bash
node scripts/create-schema-md.js
```

**What It Does:**
1. Reads Supabase credentials from `frontend/.env`
2. Calls `get_database_schema` RPC function
3. Generates `DATABASE_SCHEMA.md` with:
   - All 88 tables with column details
   - 1,400+ columns documented
   - Data types, constraints, relationships
   - Table organization by category

**API Endpoint Used:**
```javascript
POST ${SUPABASE_URL}/rest/v1/rpc/get_database_schema
Headers: {
  'Authorization': `Bearer ${SUPABASE_SERVICE_ROLE_KEY}`,
  'Content-Type': 'application/json',
  'apikey': SUPABASE_SERVICE_ROLE_KEY
}
```

**Output File:** `DATABASE_SCHEMA.md` (86.5 KB)

**When to Use:**
- Before working with any table
- To understand column structure and types
- To check foreign key relationships
- To verify data types before queries
- When schema may have changed

### Method 2: Fetch Database Functions

**Script Location:** `scripts/create-functions-md.js`

**How to Use:**
```bash
node scripts/create-functions-md.js
```

**What It Does:**
1. Reads Supabase credentials from `frontend/.env`
2. Calls `get_database_functions` RPC function
3. Generates `DATABASE_FUNCTIONS.md` with:
   - All 305 database functions
   - 10 functional categories:
     - Customer (17 functions)
     - Employee/HR (11 functions)
     - Financial (14 functions)
     - Notification (16 functions)
     - Offer Management (19 functions)
     - Other (92 functions)
     - Receiving & Vendor (29 functions)
     - System/ERP (26 functions)
     - Task Management (60 functions)
     - User Management (21 functions)

**API Endpoint Used:**
```javascript
POST ${SUPABASE_URL}/rest/v1/rpc/get_database_functions
Headers: {
  'Authorization': `Bearer ${SUPABASE_SERVICE_ROLE_KEY}`,
  'Content-Type': 'application/json',
  'apikey': SUPABASE_SERVICE_ROLE_KEY
}
```

**Output File:** `DATABASE_FUNCTIONS.md` (15.02 KB)

**When to Use:**
- To find available RPC functions
- Before calling any database function
- To understand function parameters
- To check function availability
- When adding new business logic

### Method 3: Fetch Storage Buckets (CRITICAL)

**Script Location:** `scripts/fetch-storage-info.js`

**How to Use:**
```bash
node scripts/fetch-storage-info.js
```

**What It Does:**
1. Reads Supabase credentials from `frontend/.env`
2. Queries Supabase Storage API endpoint: `/storage/v1/bucket`
3. Generates `STORAGE_INFO.md` with:
   - All 21 storage buckets (actual database values)
   - File size limits for each bucket (5 MB - 50 MB - Unlimited)
   - Allowed MIME types for each bucket
   - Created/Updated timestamps
   - Public access status
   - URL patterns for file access

**API Endpoint Used:**
```javascript
GET ${SUPABASE_URL}/storage/v1/bucket
Headers: {
  'Authorization': `Bearer ${SUPABASE_SERVICE_ROLE_KEY}`,
  'Accept': 'application/json',
  'apikey': SUPABASE_SERVICE_ROLE_KEY
}
```

**Output File:** `STORAGE_INFO.md` (20.62 KB)

**Current Storage Buckets (21 total):**
1. `category-images` (5 MB) - Product categories
2. `clearance-certificates` (10 MB) - Clearance docs
3. `completion-photos` (50 MB) - Task completion photos
4. `coupon-product-images` (Unlimited) - Coupon images
5. `customer-app-media` (50 MB) - Customer app media
6. `documents` (10 MB) - General documents
7. `employee-documents` (10 MB) - Employee docs
8. `expense-scheduler-bills` (50 MB) - Bill documents
9. `flyer-product-images` (20 MB) - Flyer images
10. `flyer-templates` (10 MB) - Flyer templates
11. `notification-images` (50 MB) - Notification attachments
12. `original-bills` (50 MB) - Invoice/bills
13. `pr-excel-files` (50 MB) - PR Excel files
14. `product-images` (5 MB) - Product images
15. `quick-task-files` (50 MB) - Quick task attachments
16. `requisition-images` (5 MB) - Requisition images
17. `shelf-paper-templates` (10 MB) - Shelf templates
18. `task-images` (50 MB) - Task attachments
19. `user-avatars` (Unlimited) - User avatars
20. `vendor-contracts` (50 MB) - Vendor contracts
21. `warning-documents` (5 MB) - Warning documents

**When to Use:**
- Before uploading files
- To check file type restrictions for a bucket
- To verify file size limits
- Before implementing file upload features
- To get correct bucket names (NEVER hardcode assumptions)

### Method 4: Manual Direct Query (If Scripts Fail)

**Direct Node.js Script Template:**

```javascript
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));

// Read .env file
const envPath = path.join(__dirname, '..', 'frontend', '.env');
const envContent = fs.readFileSync(envPath, 'utf-8');

const envVars = {};
envContent.split('\n').forEach(line => {
  const trimmed = line.trim();
  if (trimmed && !trimmed.startsWith('#')) {
    const match = trimmed.match(/^([^=]+)=(.*)$/);
    if (match) {
      envVars[match[1].trim()] = match[2].trim();
    }
  }
});

const supabaseUrl = envVars.VITE_SUPABASE_URL;
const supabaseServiceKey = envVars.VITE_SUPABASE_SERVICE_ROLE_KEY;

// Fetch schema
async function fetchSchema() {
  const response = await fetch(`${supabaseUrl}/rest/v1/rpc/get_database_schema`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${supabaseServiceKey}`,
      'Content-Type': 'application/json',
      'apikey': supabaseServiceKey,
    },
    body: JSON.stringify({}),
  });

  if (!response.ok) {
    console.error(`Error: ${response.status} ${response.statusText}`);
    process.exit(1);
  }

  const data = await response.json();
  console.log(JSON.stringify(data, null, 2));
}

fetchSchema();
```

### Workflow for Database-Related Changes

**BEFORE making ANY database-related change:**

1. **Fetch Current Schema:**
   ```bash
   node scripts/create-schema-md.js
   ```

2. **Fetch Available Functions:**
   ```bash
   node scripts/create-functions-md.js
   ```

3. **Fetch Storage Information:**
   ```bash
   node scripts/fetch-storage-info.js
   ```

4. **Check Generated Markdown Files:**
   - `DATABASE_SCHEMA.md` - For table structure
   - `DATABASE_FUNCTIONS.md` - For available functions
   - `STORAGE_INFO.md` - For file upload buckets

5. **Verify Your Assumptions:**
   - Does the table exist? ‚úÖ Check `DATABASE_SCHEMA.md`
   - Does the column exist? ‚úÖ Check `DATABASE_SCHEMA.md`
   - Does the function exist? ‚úÖ Check `DATABASE_FUNCTIONS.md`
   - Can I upload to this bucket? ‚úÖ Check `STORAGE_INFO.md`
   - What are the file type restrictions? ‚úÖ Check `STORAGE_INFO.md`

6. **THEN proceed** with development

### Critical Rules - NEVER Do These:

‚ùå **NEVER assume a table exists** without checking `DATABASE_SCHEMA.md`
‚ùå **NEVER assume a column exists** without checking `DATABASE_SCHEMA.md`
‚ùå **NEVER call a function** without checking `DATABASE_FUNCTIONS.md`
‚ùå **NEVER upload files** without checking `STORAGE_INFO.md` for bucket and MIME type
‚ùå **NEVER hardcode bucket names** - always use the documented names
‚ùå **NEVER use outdated documentation** - always fetch fresh
‚ùå **NEVER assume file size limits** - check `STORAGE_INFO.md` for current limits
‚ùå **NEVER assume MIME type restrictions** - verify in `STORAGE_INFO.md`

### Verification Checklist

Before every database operation:

- [ ] Ran `node scripts/create-schema-md.js`
- [ ] Ran `node scripts/create-functions-md.js`
- [ ] Ran `node scripts/fetch-storage-info.js`
- [ ] Checked table exists in `DATABASE_SCHEMA.md`
- [ ] Verified column names in `DATABASE_SCHEMA.md`
- [ ] Confirmed function exists in `DATABASE_FUNCTIONS.md`
- [ ] If file upload: verified bucket in `STORAGE_INFO.md`
- [ ] If file upload: checked MIME type restrictions
- [ ] If file upload: checked file size limit
- [ ] All documentation is current (check timestamps)

### Error Recovery

**If a schema query fails:**

1. Check Supabase is accessible
2. Verify `frontend/.env` has correct credentials
3. Ensure credentials are valid (not expired)
4. Check network connectivity
5. Try alternative endpoint (some endpoints may have issues)
6. Use manual query template above

**If scripts report missing data:**

1. Go to Supabase Dashboard: https://app.supabase.com
2. Navigate to specific section (Tables, Functions, Storage)
3. Manually verify the data exists in dashboard
4. Check if RLS policies are blocking queries
5. Verify service role key has sufficient permissions

---

### Recent Optimizations:
- **NotificationCenter**: Batch loading for task attachments (single query vs sequential)
- **MyTasksView**: Smooth task removal without full page reload
- **Receiving Tasks**: Auto-flag upload states in API endpoints
- **Database**: Fixed upload flag inconsistencies for receiving records

Remember: Always maintain backward compatibility and provide migration paths for breaking changes!